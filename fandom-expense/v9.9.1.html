<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¿½æ˜Ÿè¨˜å¸³ V9.9.1 - å‚™è¨»æ¢å¾©ç‰ˆ</title>
    <!-- å¤–éƒ¨è³‡æº -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        :root {
            --brand-color: #92A8D1; 
            --brand-gradient: linear-gradient(135deg, #F7CAC9 0%, #92A8D1 100%);
            --app-bg: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --border-color: #f1f5f9;
        }

        /* é»‘ç²‰ä¸»é¡Œ (Dark Mode) å„ªåŒ– */
        body.dark-mode {
            --app-bg: #000000;
            --card-bg: #1a1a1a;
            --text-main: #ffffff;
            --text-sub: #94a3b8;
            --border-color: #2d2d2d;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--app-bg);
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s, color 0.3s;
        }

        .bg-brand { background: var(--brand-gradient) !important; }
        .text-brand { color: var(--brand-color) !important; }
        .border-brand { border-color: var(--brand-color) !important; }
        .tab-active { color: var(--brand-color) !important; font-weight: 900; }
        
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .modal-enter { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .card-shadow { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); }
        body.dark-mode .card-shadow { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4); }

        .status-unArrived { background-color: #fee2e2; color: #ef4444; }
        .status-toShip { background-color: #fef3c7; color: #d97706; }
        .status-received { background-color: #dcfce7; color: #16a34a; }

        .chip {
            flex-shrink: 0; padding: 6px 14px; border-radius: 12px; font-size: 11px;
            font-weight: 600; transition: all 0.2s; cursor: pointer;
            border: 1px solid var(--border-color); background-color: var(--card-bg); color: var(--text-sub);
        }
        .chip.active-tag { background: var(--brand-gradient) !important; color: #fff !important; border-color: transparent !important; }
        .report-range-btn.active { background: var(--brand-gradient); color: white; }
        
        .color-preset { width: 42px; height: 42px; border-radius: 50%; cursor: pointer; border: 2px solid #e2e8f0; transition: all 0.2s; }
        .color-preset.active { border-color: #fff !important; outline: 3px solid var(--brand-color); }
        .photo-tab.active { border-bottom: 3px solid var(--brand-color); color: var(--brand-color); font-weight: 900; }

        /* Dark Mode æ–‡å­—é¡¯ç¤ºä¿®æ­£ */
        body.dark-mode .bg-white { background-color: var(--card-bg) !important; }
        body.dark-mode .text-slate-800, 
        body.dark-mode .text-gray-800, 
        body.dark-mode .text-slate-700, 
        body.dark-mode .text-gray-700,
        body.dark-mode .text-slate-600,
        body.dark-mode .font-black.text-sm,
        body.dark-mode .text-sm.font-black,
        body.dark-mode .text-sm.font-bold { color: #ffffff !important; }
        body.dark-mode .bg-slate-50 { background-color: #121212 !important; }
        body.dark-mode .border-gray-100, body.dark-mode .border-slate-50 { border-color: #2d2d2d !important; }
        body.dark-mode .bg-slate-200\/50 { background-color: rgba(255, 255, 255, 0.1) !important; }

        #toast {
            visibility: hidden; min-width: 200px; background-color: rgba(30, 41, 59, 0.95);
            color: #fff; text-align: center; border-radius: 16px; padding: 12px 24px;
            position: fixed; z-index: 999; left: 50%; bottom: 100px; transform: translateX(-50%);
            font-size: 14px; font-weight: 600; backdrop-filter: blur(8px); opacity: 0;
            transition: opacity 0.3s, bottom 0.3s, visibility 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 120px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <main id="main-content" class="flex-grow overflow-y-auto no-scrollbar pb-32"></main>
    <div id="toast">æç¤ºè¨Šæ¯</div>
    <button id="fab" onclick="openAddModal()" class="bg-brand fixed bottom-28 right-6 w-14 h-14 text-white rounded-full flex items-center justify-center text-3xl shadow-lg z-40 transition-transform active:scale-90">ï¼‹</button>

    <!-- åº•éƒ¨å°è¦½ -->
    <footer class="fixed bottom-0 w-full bg-white/95 backdrop-blur-md border-t border-gray-100 flex justify-around items-center h-20 safe-area-bottom z-50 px-2 shadow-[0_-4px_10px_rgba(0,0,0,0.03)]">
        <button onclick="switchTab('expense')" id="tab-expense" class="flex-1 flex flex-col items-center gap-1 text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 012-2h2a2 2 0 012 2" stroke-width="2"/></svg>
            <span class="text-[10px] font-bold">æ¶ˆè²»æ¸…å–®</span>
        </button>
        <button onclick="switchTab('report')" id="tab-report" class="flex-1 flex flex-col items-center gap-1 text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" stroke-width="2"/><path d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" stroke-width="2"/></svg>
            <span class="text-[10px] font-bold">è²¡å‹™å ±è¡¨</span>
        </button>
        <button onclick="switchTab('wish')" id="tab-wish" class="flex-1 flex flex-col items-center gap-1 text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" stroke-width="2"/></svg>
            <span class="text-[10px] font-bold">é¡˜æœ›æ¸…å–®</span>
        </button>
        <button onclick="switchTab('settings')" id="tab-settings" class="flex-1 flex flex-col items-center gap-1 text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" stroke-width="2"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke-width="2"/></svg>
            <span class="text-[10px] font-bold">è¨­å®š</span>
        </button>
    </footer>

    <!-- å½ˆçª—å…§å®¹ -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/60 hidden z-[60] flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div id="modal-container" class="bg-white w-full max-w-lg rounded-t-3xl sm:rounded-3xl overflow-hidden modal-enter shadow-2xl">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="modal-title" class="text-xl font-bold text-gray-800">æ–°å¢æ¶ˆè²»</h3>
                    <button onclick="closeModal()" class="text-gray-400 p-2 text-xl">âœ•</button>
                </div>
                <form id="data-form" class="space-y-4 max-h-[60vh] overflow-y-auto no-scrollbar pb-6 px-1"></form>
                <div class="pt-4 border-t border-gray-50 flex gap-3">
                    <button onclick="closeModal()" class="flex-1 bg-gray-100 text-gray-500 font-bold py-4 rounded-2xl active:scale-95 transition-transform">å–æ¶ˆ</button>
                    <button onclick="saveData()" class="bg-brand flex-[2] text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-transform">ç¢ºèªå„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆªé™¤ç¢ºèª -->
    <div id="delete-modal-overlay" class="fixed inset-0 bg-black/70 hidden z-[100] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xs rounded-3xl overflow-hidden p-6 text-center shadow-2xl scale-95">
            <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">ğŸ—‘ï¸</div>
            <h3 class="text-lg font-bold text-gray-800 mb-2">ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ</h3>
            <p class="text-sm text-gray-400 mb-6">ç´€éŒ„åˆªé™¤å¾Œå°‡ç„¡æ³•æ¢å¾©ã€‚</p>
            <div class="flex gap-3">
                <button onclick="closeDeleteModal()" class="flex-1 bg-gray-100 text-gray-500 font-bold py-3 rounded-xl active:scale-95">å–æ¶ˆ</button>
                <button onclick="confirmDelete()" class="flex-1 bg-red-500 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95">ç¢ºå®šåˆªé™¤</button>
            </div>
        </div>
    </div>

    <!-- ç‡ˆç®± -->
    <div id="lightbox-overlay" onclick="closeLightbox()" class="fixed inset-0 bg-black/95 hidden z-[200] flex flex-col items-center justify-center p-4">
        <div class="relative w-full max-w-md">
            <img id="lightbox-img" src="" class="w-full h-auto rounded-3xl shadow-2xl">
            <div id="lightbox-info" class="absolute bottom-[-60px] left-0 right-0 text-white text-center">
                <p id="lightbox-name" class="font-black text-lg"></p>
                <p id="lightbox-sub" class="text-white/60 text-xs"></p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (Google ç™»å…¥èˆ‡é›²ç«¯) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'fandom-expense-v9';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.cloud = {
            login: async () => {
                const provider = new GoogleAuthProvider();
                try { await signInWithPopup(auth, provider); } catch (e) { showToast("ç™»å…¥è¢«æ””æˆªï¼Œè«‹å…è¨±å½ˆçª—"); }
            },
            logout: async () => { await signOut(auth); localStorage.clear(); location.reload(); },
            sync: async (expenses, wishlist) => {
                if (!auth.currentUser || auth.currentUser.isAnonymous) return;
                try { await setDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'data'), { expenses, wishlist }); } catch (e) {}
            },
            pull: async () => {
                if (!auth.currentUser || auth.currentUser.isAnonymous) return null;
                try { const snap = await getDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'data')); return snap.exists() ? snap.data() : null; } catch (e) { return null; }
            }
        };

        const init = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } else { await signInAnonymously(auth); }
            onAuthStateChanged(auth, async (user) => {
                state.user = (user && !user.isAnonymous) ? user : null;
                if (state.user) {
                    const data = await window.cloud.pull();
                    if (data) {
                        state.expenses = data.expenses || state.expenses;
                        state.wishlist = data.wishlist || state.wishlist;
                        localStorage.setItem('fe_v5_expenses', JSON.stringify(state.expenses));
                        localStorage.setItem('fe_v5_wishlist', JSON.stringify(state.wishlist));
                        renderContent();
                    }
                }
                if (state.activeTab === 'settings') renderContent();
            });
        };
        init();
    </script>

    <script>
        /**
         * 1. ç‹€æ…‹ç®¡ç†
         */
        let state = {
            activeTab: 'expense',
            subPage: null,
            photoWallTab: 'purchased',
            themeColor: localStorage.getItem('fe_v5_theme') || 'svt', 
            expenses: JSON.parse(localStorage.getItem('fe_v5_expenses')) || [],
            wishlist: JSON.parse(localStorage.getItem('fe_v5_wishlist')) || [],
            filterYear: Number(new Date().getFullYear()),
            filterMonth: Number(new Date().getMonth() + 1),
            reportRange: '6months', 
            reportOffset: 0,
            searchKeyword: '',
            selectedCategory: '',
            wishPhotoCategory: '',
            editingId: null,
            deleteTarget: { type: null, id: null },
            tempImage: null,
            user: null
        };

        const excelHeaderMap = {
            name: "é …ç›®åç¨±", price: "å–®åƒ¹", qty: "æ•¸é‡", category: "åˆ†é¡",
            year: "æ¶ˆè²»å¹´ä»½", month: "æ¶ˆè²»æœˆä»½", platform: "æ”¶ç‰©å¹³å°",
            arrivalStatus: "åˆ°è²¨ç‹€æ…‹", paymentMethod: "ä»˜æ¬¾æ–¹å¼", paidAmount: "å·²ä»˜é‡‘é¡",  tags: "æ¨™ç±¤", remark: "å‚™è¨»"
        };

        const categories = [
            { id: 'å°ˆè¼¯', icon: 'ğŸµ', color: '#818cf8' },
            { id: 'æ¼”å”±æœƒ / è¦‹é¢æœƒé–€ç¥¨', icon: 'ğŸ«', color: '#f87171' },
            { id: 'å‘¨é‚Šå•†å“', icon: 'ğŸ§¸', color: '#fbbf24' },
            { id: 'åœ‹éš›é‹è²»', icon: 'ğŸ“¦', color: '#34d399' },
            { id: 'äº¤é€š / ä½å®¿', icon: 'âœˆï¸', color: '#60a5fa' },
            { id: 'å…¶ä»–è¿½æ˜Ÿæ”¯å‡º', icon: 'ğŸŒˆ', color: '#9ca3af' }
        ];

        const wishCategories = ["å°ˆè¼¯", "å‘¨é‚Š", "å¨ƒå¨ƒ", "å°å¡"];

        const arrivalOptions = ['æœªåˆ°è²¨', 'å¾…å‡ºè²¨', 'å·²å–è²¨'];
        let myChart = null;

        /**
         * 2. å·¥å…·å‡½å¼
         */
        function showToast(msg) {
            const t = document.getElementById("toast");
            if(!t) return;
            t.textContent = msg; t.classList.add("show");
            setTimeout(() => t.classList.remove("show"), 2000);
        }

        function applyTheme(color) {
            state.themeColor = color;
            const root = document.documentElement;
            const body = document.body;
            body.classList.remove('dark-mode');
            if (color === 'svt') {
                root.style.setProperty('--brand-color', '#92A8D1');
                root.style.setProperty('--brand-gradient', 'linear-gradient(135deg, #F7CAC9 0%, #92A8D1 100%)');
            } else if (color === 'bp') {
                root.style.setProperty('--brand-color', '#FF85D0');
                root.style.setProperty('--brand-gradient', '#FF85D0');
                body.classList.add('dark-mode');
            } else {
                root.style.setProperty('--brand-color', color);
                root.style.setProperty('--brand-gradient', color);
            }
            localStorage.setItem('fe_v5_theme', color);
        }

        function compressImage(base64Str, maxWidth = 800, maxHeight = 800) {
            return new Promise((resolve) => {
                const img = new Image(); img.src = base64Str;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if (w > h) { if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; } } 
                    else { if (h > maxHeight) { w *= maxHeight / h; h = maxHeight; } }
                    canvas.width = w; canvas.height = h;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.6));
                };
            });
        }

        function getStatusClass(s) {
            if (s === 'æœªåˆ°è²¨') return 'status-unArrived';
            if (s === 'å¾…å‡ºè²¨') return 'status-toShip';
            return 'status-received';
        }

        /**
         * 3. å°è¦½é‚è¼¯
         */
        function switchTab(tab) {
            state.activeTab = tab; state.subPage = null; state.searchKeyword = ''; state.selectedCategory = '';
            ['expense', 'report', 'wish', 'settings'].forEach(t => {
                const el = document.getElementById(`tab-${t}`);
                if (el) el.className = `flex-1 flex flex-col items-center gap-1 transition-colors ${tab === t ? 'tab-active' : 'text-gray-400'}`;
            });
            document.getElementById('fab').classList.toggle('hidden', tab === 'report' || tab === 'settings');
            renderContent();
        }

        function renderContent() {
            const container = document.getElementById('main-content');
            if(!container) return;
            container.innerHTML = '';
            if (state.activeTab === 'expense') renderExpenseList(container);
            else if (state.activeTab === 'report') renderReport(container);
            else if (state.activeTab === 'wish') renderWishList(container);
            else if (state.activeTab === 'settings') {
                if (state.subPage === 'backup') renderBackupView(container);
                else if (state.subPage === 'appearance') renderAppearanceView(container);
                else if (state.subPage === 'photowall') renderPhotoWall(container);
                else renderSettings(container);
            }
        }

        // --- æ¶ˆè²»æ¸…å–®æ¸²æŸ“ (å«å‚™è¨»æ¢å¾©) ---
        function renderExpenseList(container) {
            container.innerHTML = `
                <div class="p-6 sticky top-0 bg-brand/5 backdrop-blur-md z-30 border-b border-gray-100">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-black tracking-tight">æ¶ˆè²»æ¸…å–®</h2>
                        <div class="flex gap-2 text-gray-800">
                            <select onchange="updateFilter('year', this.value)" class="bg-white border rounded-lg px-2 py-1 text-xs outline-none shadow-sm">${[2024, 2025, 2026].map(y => `<option value="${y}" ${Number(y) === Number(state.filterYear) ? 'selected' : ''}>${y}å¹´</option>`).join('')}</select>
                            <select onchange="updateFilter('month', this.value)" class="bg-white border rounded-lg px-2 py-1 text-xs outline-none shadow-sm">${Array.from({length: 12}, (_, i) => i + 1).map(m => `<option value="${m}" ${Number(m) === Number(state.filterMonth) ? 'selected' : ''}>${m}æœˆ</option>`).join('')}</select>
                        </div>
                    </div>
                    <div class="relative mb-3">
                        <input type="text" placeholder="æœå°‹é …ç›®ã€æ¨™ç±¤æˆ–å‚™è¨»..." oninput="state.searchKeyword=this.value;renderExpenseListItems(document.getElementById('expense-list-items'))" class="w-full bg-white border border-gray-100 rounded-2xl py-3 px-10 text-sm shadow-sm outline-none focus:ring-2 focus:ring-brand focus:ring-opacity-20 transition-all text-gray-800">
                        <svg class="text-brand w-4 h-4 absolute left-4 top-4 opacity-40" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="3"/></svg>
                    </div>
                    <div id="cat-bar" class="flex gap-2 overflow-x-auto no-scrollbar pb-2 mb-1"></div>
                    <div id="tag-bar" class="flex gap-2 overflow-x-auto no-scrollbar pb-2"></div>
                </div>
                <div id="expense-list-items" class="px-6 space-y-4 pb-12 pt-4"></div>
            `;
            renderTagAndCatBar();
            renderExpenseListItems(document.getElementById('expense-list-items'));
        }

        function renderTagAndCatBar() {
            const catBar = document.getElementById('cat-bar'); if (!catBar) return;
            catBar.innerHTML = categories.map(cat => `<div onclick="state.selectedCategory=(state.selectedCategory==='${cat.id}'?'':'${cat.id}');renderTagAndCatBar();renderExpenseListItems(document.getElementById('expense-list-items'))" class="chip ${state.selectedCategory === cat.id ? 'active-cat text-white' : ''}" style="${state.selectedCategory === cat.id ? `background-color:${cat.color}` : `color:${cat.color}; background-color:${cat.color}10; border-color:${cat.color}30`}">${cat.icon} ${cat.id.split(' ')[0]}</div>`).join('');
            const tagBar = document.getElementById('tag-bar');
            const allTags = [...new Set(state.expenses.flatMap(ex => ex.tags || []))].filter(t => t);
            tagBar.innerHTML = allTags.map(tag => `<div onclick="state.searchKeyword=(state.searchKeyword==='${tag}'?'':'${tag}');renderExpenseListItems(document.getElementById('expense-list-items'))" class="chip ${state.searchKeyword === tag ? 'active-tag' : ''}">#${tag}</div>`).join('');
        }

        function renderExpenseListItems(container) {
            if(!container) return;
            const kw = state.searchKeyword.toLowerCase();
            const filtered = state.expenses.filter(ex => 
                (Number(ex.year) === Number(state.filterYear) && Number(ex.month) === Number(state.filterMonth)) && 
                (ex.name.toLowerCase().includes(kw) || (ex.tags && ex.tags.some(t => t.toLowerCase().includes(kw))) || (ex.remark && ex.remark.toLowerCase().includes(kw))) && 
                (state.selectedCategory === '' || ex.category === state.selectedCategory)
            );
            const total = filtered.reduce((sum, item) => sum + (Number(item.price) * Number(item.qty)), 0);
            
            if (filtered.length === 0) { container.innerHTML = `<div class="text-center py-24 text-slate-300 font-bold">ç›®å‰æ²’æœ‰ç´€éŒ„å”·</div>`; return; }
            
            container.innerHTML = `<div class="bg-brand rounded-3xl p-6 text-white card-shadow flex justify-between items-end mb-6"><div><p class="text-white/70 text-[10px] font-bold uppercase tracking-wider mb-1">Monthly Cost</p><h3 class="text-3xl font-black">$ ${total.toLocaleString()}</h3></div><p class="text-xs text-white/80 font-medium">${filtered.length} é …ç´€éŒ„</p></div>` + 
            filtered.sort((a,b) => b.id - a.id).map(item => {
                const catInfo = categories.find(c => c.id === item.category) || { icon: 'ğŸŒˆ' };
                return `
                <div class="bg-white rounded-3xl p-4 card-shadow relative overflow-hidden group">
                    <div class="absolute top-4 right-4 flex gap-2 z-10">
                        <button onclick="handleEdit(event, 'expense', '${item.id}')" class="action-btn p-2 text-slate-300 hover:text-brand transition-colors">âœ</button>
                        <button onclick="handleDelete(event, 'expense', '${item.id}')" class="action-btn p-2 text-slate-300 hover:text-red-500 transition-colors">âœ•</button>
                    </div>
                    <div class="flex gap-4" onclick="${item.image ? `openLightbox('${item.image}', '${item.name}', '${item.year}/${item.month}')` : ''}">
                        ${item.image ? `<img src="${item.image}" class="w-20 h-20 object-cover rounded-2xl">` : 
                        `<div class="w-20 h-20 bg-slate-50 rounded-2xl flex items-center justify-center text-3xl shadow-inner">${catInfo.icon}</div>`}
                        <div class="flex-grow">
                            <div class="flex gap-2 mb-1">
                                <span class="text-[9px] font-bold px-2 py-0.5 rounded-lg bg-slate-50 text-brand font-bold">${catInfo.icon} ${item.category.split(' ')[0]}</span>
                                <span class="text-[9px] font-bold px-2 py-0.5 rounded-lg ${getStatusClass(item.arrivalStatus)} font-bold">${item.arrivalStatus}</span>
                            </div>
                            <h4 class="font-bold text-sm leading-tight text-slate-800">${item.name}</h4>
                            <p class="text-[10px] text-slate-400 mt-1">ğŸ“ ${item.platform || 'æœªæ¨™è¨»'}</p>
                            <!-- æ¢å¾©å‚™è¨»é¡¯ç¤º -->
                            <p class="text-[10px] text-slate-400 mt-1 leading-relaxed opacity-80">${item.remark || ''}</p>
                            <div class="flex justify-between items-end mt-2">
                                <div class="flex flex-wrap gap-1 pr-2">${(item.tags || []).map(t => `<span class="bg-slate-50 text-slate-400 text-[9px] px-2 py-0.5 rounded-md font-bold">#${t}</span>`).join('')}</div>
                                <div class="text-right flex-shrink-0 text-brand font-black text-lg">$${(Number(item.price)*Number(item.qty)).toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                </div>`}).join('');
        }

        // --- è²¡å‹™å ±è¡¨æ¸²æŸ“ ---
        function renderReport(container) {
            const rangeData = calculateReportRange();
            const filteredExpenses = state.expenses.filter(ex => { const d = new Date(ex.year, ex.month - 1); return d >= rangeData.start && d <= rangeData.end; });
            const stats = categories.map(cat => ({ ...cat, amount: filteredExpenses.filter(ex => ex.category === cat.id).reduce((sum, item) => sum + (Number(item.price) * Number(item.qty)), 0) })).filter(s => s.amount > 0).sort((a,b) => b.amount - a.amount);
            const totalSpending = stats.reduce((sum, s) => sum + s.amount, 0);

            container.innerHTML = `<div class="p-6"><h2 class="text-2xl font-black mb-6 tracking-tight text-slate-800">è²¡å‹™åˆ†æå ±å‘Š</h2>
                <div class="flex flex-col gap-4 mb-8">
                    <div class="flex bg-slate-200/50 p-1 rounded-2xl">${['month', '6months', 'year'].map(r => `<button onclick="state.reportRange='${r}';state.reportOffset=0;renderContent()" class="report-range-btn flex-1 py-2 text-xs font-bold rounded-xl transition-all ${state.reportRange===r?'active':''}">${r==='month'?'æœˆ':r==='year'?'å¹´':'è¿‘ 6 å€‹æœˆ'}</button>`).join('')}</div>
                    <div class="flex justify-between items-center bg-white p-4 rounded-2xl card-shadow">
                        <button onclick="state.reportOffset--;renderContent()" class="p-2 text-slate-400">â—€</button>
                        <span class="text-sm font-black text-slate-800">${rangeData.label}</span>
                        <button onclick="state.reportOffset++;renderContent()" class="p-2 text-slate-400">â–¶</button>
                    </div>
                </div>
                ${totalSpending > 0 ? `<div class="bg-white rounded-3xl p-6 card-shadow mb-8 relative"><canvas id="donutChart"></canvas><div class="absolute inset-0 flex flex-col items-center justify-center mt-2 pointer-events-none"><span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">ç¸½æ”¯å‡º</span><span class="text-xl font-black text-slate-800">$${totalSpending.toLocaleString()}</span></div></div><div class="space-y-3">${stats.map(s => `<div class="bg-white rounded-2xl p-4 card-shadow flex items-center gap-4 border-l-4" style="border-color:${s.color}"><div class="w-10 h-10 rounded-xl flex items-center justify-center text-lg" style="background-color:${s.color}20">${s.icon}</div><div class="flex-grow"><span class="text-sm font-bold text-slate-800">${s.id}</span></div><div class="font-black text-slate-800">$${s.amount.toLocaleString()}</div></div>`).join('')}</div>` : `<div class="py-24 text-center text-slate-300 font-bold">ç›®å‰å°šç„¡è³‡æ–™</div>`}</div>`;
            if (totalSpending > 0) setTimeout(() => initChart(stats), 100);
        }

        // --- é¡˜æœ›æ¸…å–® (æ¢å¾©å‚™è¨»é¡¯ç¤º) ---
        function renderWishList(container) {
            container.innerHTML = `<div class="p-6"><h2 class="text-2xl font-black mb-6 tracking-tight text-slate-800">é¡˜æœ›æ¸…å–®</h2><div class="space-y-4 pb-12">${state.wishlist.length === 0 ? `<div class="text-center py-24 text-slate-300 font-bold">å¿«è¨±ä¸‹æ–°çš„é¡˜æœ›å§ï¼</div>` : state.wishlist.map(item => `
                <div class="bg-white rounded-3xl p-4 flex flex-col gap-3 card-shadow relative overflow-hidden group">
                    <div class="absolute top-4 right-4 flex gap-1 z-10">
                        <button onclick="buyWish('${item.id}')" class="action-btn p-2 bg-brand/10 text-brand rounded-full hover:bg-brand hover:text-white shadow-sm transition-all">ğŸ›’</button>
                        <button onclick="handleEdit(event, 'wish', '${item.id}')" class="action-btn p-2 text-slate-300 hover:text-brand transition-all">âœ</button>
                        <button onclick="handleDelete(event, 'wish', '${item.id}')" class="action-btn p-2 text-slate-300 hover:text-red-500 transition-all">âœ•</button>
                    </div>
                    <div class="flex items-center gap-4" onclick="${item.image ? `openLightbox('${item.image}', '${item.name}', '${item.releaseDate || 'æœªå®š'}')` : ''}">
                        ${item.image ? `<img src="${item.image}" class="w-16 h-16 object-cover rounded-2xl shadow-sm">` : `<div class="w-16 h-16 bg-slate-50 rounded-2xl flex items-center justify-center text-2xl shadow-inner">âœ¨</div>`}
                        <div class="flex-grow pr-24">
                            <div class="flex gap-2 mb-1">
                                <span class="text-[9px] font-bold px-2 py-0.5 rounded-lg bg-slate-50 text-brand font-bold">${item.category || 'ä¸€èˆ¬'}</span>
                            </div>
                            <h4 class="font-bold text-sm leading-tight text-slate-800 font-bold">${item.name}</h4>
                            <p class="text-xs font-black text-brand mt-1">$ ${Number(item.price).toLocaleString()}</p>
                            <p class="text-[10px] text-slate-400 mt-1 italic tracking-tight font-bold">ğŸ—“ï¸ ${item.releaseDate || 'æœªå®š'} ${item.releaseTime || ''}</p>
                            <!-- æ¢å¾©é¡˜æœ›å‚™è¨»é¡¯ç¤º -->
                            <p class="text-[10px] text-slate-400 mt-1 leading-relaxed italic opacity-80">${item.remark || ''}</p>
                        </div>
                    </div>
                </div>`).join('')}</div></div>`;
        }

        // --- è¨­å®šé é¢ ---
        function renderSettings(container) {
            const user = state.user;
            container.innerHTML = `<div class="p-6"><h2 class="text-2xl font-black mb-8 tracking-tight text-slate-800">è¨­å®š</h2>
                <div class="bg-white rounded-3xl p-5 card-shadow mb-8 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full overflow-hidden bg-slate-50 border-2 border-brand/20 flex items-center justify-center">
                        ${user ? `<img src="${user.photoURL}" class="w-full h-full object-cover">` : `<span class="text-xl">ğŸ‘¤</span>`}
                    </div>
                    <div class="flex-grow"><h4 class="font-bold text-slate-800 text-sm">${user ? (user.displayName || 'Google ç”¨æˆ¶') : 'è¨ªå®¢æ¨¡å¼'}</h4><p class="text-[10px] text-slate-400">${user ? 'é›²ç«¯è³‡æ–™å·²åŒæ­¥ â˜ï¸' : 'ç™»å…¥å¾Œé–‹å•Ÿé›²ç«¯å‚™ä»½'}</p></div>
                    ${user ? `<button onclick="window.cloud.logout()" class="text-[10px] font-bold text-slate-400 bg-slate-50 px-3 py-2 rounded-xl transition-all active:scale-95">ç™»å‡º</button>` : `<button onclick="window.cloud.login()" class="text-xs bg-brand text-white font-bold px-4 py-2 rounded-xl shadow-md active:scale-95 transition-transform">ç™»å…¥</button>`}
                </div>
                <div class="bg-white rounded-3xl overflow-hidden card-shadow">
                    <div onclick="state.subPage = 'photowall'; renderContent();" class="flex items-center justify-between p-5 hover:bg-slate-50 cursor-pointer border-b border-slate-50"><div class="flex items-center gap-4 text-indigo-500"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h14a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-width="2"/></svg><span class="font-bold text-slate-700">æˆ‘çš„ç…§ç‰‡ç‰†</span></div><span>â–¶</span></div>
                    <div onclick="state.subPage = 'appearance'; renderContent();" class="flex items-center justify-between p-5 hover:bg-slate-50 cursor-pointer border-b border-slate-50"><div class="flex items-center gap-4 text-brand"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" stroke-width="2"/></svg><span class="font-bold text-slate-700">å¤–è§€è¨­å®š</span></div><span>â–¶</span></div>
                    <div onclick="state.subPage = 'backup'; renderContent();" class="flex items-center justify-between p-5 hover:bg-slate-50 cursor-pointer"><div class="flex items-center gap-4 text-slate-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" stroke-width="2"/></svg><span class="font-bold text-slate-700">æ•¸æ“šåŒ¯å…¥èˆ‡åŒ¯å‡º</span></div><span>â–¶</span></div>
                </div></div>`;
        }

        // --- å­é é¢æ¸²æŸ“ ---
        function renderPhotoWall(container) {
            const isWishWall = state.photoWallTab === 'wish';
            let photos = (isWishWall ? state.wishlist : state.expenses).filter(i => i.image);
            if (isWishWall && state.wishPhotoCategory !== '') {
                photos = photos.filter(p => p.category === state.wishPhotoCategory);
            }
            container.innerHTML = `<div class="p-6"><div class="flex items-center gap-3 mb-6"><button onclick="state.subPage=null;renderContent()" class="p-2 -ml-2 text-slate-400 active:scale-90 font-bold">â—€</button><h2 class="text-2xl font-black tracking-tight text-slate-800">ç…§ç‰‡ç‰†</h2></div><div class="flex border-b border-gray-100 mb-6"><button onclick="state.photoWallTab='purchased';state.wishPhotoCategory='';renderContent()" class="photo-tab flex-1 py-3 text-sm font-bold ${state.photoWallTab==='purchased'?'active':'text-gray-400'}">å·²è³¼è²·</button><button onclick="state.photoWallTab='wish';renderContent()" class="photo-tab flex-1 py-3 text-sm font-bold ${state.photoWallTab==='wish'?'active':'text-gray-400'}">å¿ƒé¡˜ç‰†</button></div>${isWishWall ? `<div class="flex gap-2 overflow-x-auto no-scrollbar pb-4 mb-2"><div onclick="state.wishPhotoCategory='';renderContent()" class="chip ${state.wishPhotoCategory === '' ? 'active-tag' : ''}">å…¨éƒ¨</div>${wishCategories.map(c => `<div onclick="state.wishPhotoCategory='${c}';renderContent()" class="chip ${state.wishPhotoCategory === c ? 'active-tag' : ''}">${c}</div>`).join('')}</div>` : ''}<div class="grid grid-cols-2 sm:grid-cols-3 gap-3 pb-20">${photos.length > 0 ? photos.map(item => `<div onclick="openLightbox('${item.image}', '${item.name}', '${isWishWall ? (item.category || 'ä¸€èˆ¬') : (item.year || '')}')" class="relative aspect-square bg-gray-200 rounded-2xl overflow-hidden shadow-sm active:scale-95 transition-all"><img src="${item.image}" class="w-full h-full object-cover"></div>`).join('') : `<div class="col-span-full py-24 text-center text-slate-300 font-bold">ç›®å‰å°šç„¡ç…§ç‰‡</div>`}</div></div>`;
        }
        function renderAppearanceView(container) {
            const presets = [{name:'SVT', c:'svt', g: 'linear-gradient(135deg, #F7CAC9 0%, #92A8D1 100%)'},{name:'å¹»ç´«', c:'#BB96FF'}, {name:'æ²è—', c:'#69C4E0'}, {name:'è¢ç¶ ', c:'#B6ED00'},{name:'é»‘ç²‰', c:'bp', g: 'linear-gradient(135deg, #000000 0%, #FF85D0 100%)'},{name:'æ¥µå…‰', c:'#6C3591'}, {name:'ç† é‡‘', c:'#E2B216'}];
            container.innerHTML = `<div class="p-6"><div class="flex items-center gap-3 mb-8"><button onclick="state.subPage=null;renderContent()" class="p-2 -ml-2 text-slate-400 font-bold">â—€</button><h2 class="text-2xl font-black tracking-tight text-slate-800">å¤–è§€è¨­å®š</h2></div><div class="bg-white rounded-3xl p-6 card-shadow text-slate-800"><h3 class="text-sm font-bold text-slate-600 mb-6 tracking-wide">é¸æ“‡ä¸»é¡Œè‰²</h3><div class="grid grid-cols-4 gap-y-8 gap-x-4 place-items-center mb-10">${presets.map(p => `<div class="flex flex-col items-center gap-2"><div onclick="applyTheme('${p.c}');renderContent()" class="color-preset ${state.themeColor===p.c?'active':''}" style="background:${p.g || p.c}"></div><span class="text-[10px] font-bold text-slate-400 font-bold">${p.name}</span></div>`).join('')}<div class="flex flex-col items-center gap-2"><input type="color" onchange="applyTheme(this.value);renderContent()" value="${state.themeColor==='svt'?'#92A8D1':state.themeColor==='bp'?'#FF85D0':state.themeColor}" class="w-10 h-10 rounded-full border-none cursor-pointer bg-slate-200 shadow-sm"><span class="text-[10px] font-bold text-slate-400 font-bold">è‡ªé¸</span></div></div></div></div>`;
        }
        function renderBackupView(container) {
            container.innerHTML = `<div class="p-6"><div class="flex items-center gap-3 mb-8"><button onclick="state.subPage=null;renderContent()" class="p-2 -ml-2 text-slate-400 active:scale-90 font-bold">â—€</button><h2 class="text-2xl font-black tracking-tight text-slate-800 font-bold">æ•¸æ“šåŒ¯å…¥èˆ‡åŒ¯å‡º</h2></div><div class="bg-white rounded-3xl p-8 card-shadow border-2 border-dashed border-slate-200 text-center text-slate-800"><div class="w-20 h-20 bg-slate-50 text-slate-400 rounded-3xl flex items-center justify-center mx-auto mb-6 text-3xl">ğŸ“Š</div><h3 class="text-lg font-bold mb-2 tracking-tight">Excel ç®¡ç†</h3><p class="text-sm text-slate-400 mb-8 px-4 leading-relaxed font-bold">æœ¬åœ° Excel å‚™ä»½ä¸åŒ…å«åœ–ç‰‡è³‡æ–™ã€‚</p><div class="grid grid-cols-1 gap-4"><button onclick="exportToExcel()" class="bg-brand text-white font-black py-5 rounded-2xl shadow-lg active:scale-95 transition-transform font-bold">åŒ¯å‡º Excel å‚™ä»½</button><label class="bg-slate-800 text-white font-black py-5 rounded-2xl active:scale-95 cursor-pointer text-center font-bold">åŒ¯å…¥ Excel é‚„åŸ<input type="file" class="hidden" accept=".xlsx, .xls" onchange="importFromExcel(this)"></label></div></div></div>`;
        }

        /**
         * 4. æ•¸æ“šèˆ‡æ¨¡çª—é‚è¼¯
         */
        function calculateReportRange() {
            let start, end, label; const now = new Date();
            if (state.reportRange === 'month') { start = new Date(now.getFullYear(), now.getMonth() + state.reportOffset, 1); end = new Date(start.getFullYear(), start.getMonth() + 1, 0); label = `${start.getFullYear()} å¹´ ${start.getMonth() + 1} æœˆ`; }
            else if (state.reportRange === '6months') { end = new Date(now.getFullYear(), now.getMonth() + state.reportOffset + 1, 0); start = new Date(end.getFullYear(), end.getMonth() - 5, 1); label = `${start.getFullYear()}.${start.getMonth()+1} ï½ ${end.getFullYear()}.${end.getMonth()+1}`; }
            else { start = new Date(now.getFullYear() + state.reportOffset, 0, 1); end = new Date(start.getFullYear(), 11, 31); label = `${start.getFullYear()} å¹´åº¦å ±å‘Š`; }
            return { start, end, label };
        }

        function initChart(stats) {
            const ctx = document.getElementById('donutChart'); if (!ctx) return;
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, { type: 'doughnut', data: { labels: stats.map(s => s.id), datasets: [{ data: stats.map(s => s.amount), backgroundColor: stats.map(s => s.color), borderWidth: 0 }] }, options: { cutout: '75%', plugins: { legend: { display: false } } } });
        }

        function openAddModal(itemData = null) {
            state.editingId = itemData?.id ? String(itemData.id) : null;
            state.tempImage = itemData?.image || null;
            const form = document.getElementById('data-form');
            const isWish = (state.activeTab === 'wish' && !itemData?.qty);
            document.getElementById('modal-title').textContent = isWish ? (state.editingId ? "ç·¨è¼¯å¿ƒé¡˜" : "æ–°å¢å¿ƒé¡˜") : (state.editingId ? "ç·¨è¼¯ç´€éŒ„" : "æ–°å¢è³‡æ–™");
            const isExp = (state.activeTab === 'expense' || itemData?.qty);
            const defaultMonthStr = String(state.filterMonth).padStart(2,'0');
            const defaultDate = `${state.filterYear}-${defaultMonthStr}`;
            
            if (isExp) {
                form.innerHTML = `<div class="space-y-4"><div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">é …ç›®åç¨±</label><input type="text" id="m-name" required value="${itemData?.name || ''}" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none border-2 border-transparent focus:border-brand text-gray-800"></div><div class="grid grid-cols-2 gap-4"><div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">å–®åƒ¹</label><input type="number" id="m-price" required value="${itemData?.price || ''}" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800"></div><div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">æ•¸é‡</label><input type="number" id="m-qty" required value="${itemData?.qty || 1}" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800"></div></div><div class="grid grid-cols-2 gap-4"><div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">åˆ†é¡</label><select id="m-cat" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800">${categories.map(c => `<option ${itemData?.category == c.id ? 'selected' : ''}>${c.id}</option>`).join('')}</select></div><div class="space-y-1 flex flex-col"><label class="text-[10px] font-bold text-slate-400 uppercase mb-1">æ¶ˆè²»å¹´æœˆ</label><input type="month" id="m-date" value="${itemData?.year ? `${itemData.year}-${String(itemData.month).padStart(2,'0')}` : defaultDate}" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800"></div></div><div class="grid grid-cols-2 gap-4"><div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">æ”¶ç‰©å¹³å°</label><input type="text" id="m-platform" value="${itemData?.platform || ''}" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800"></div><div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">åˆ°è²¨ç‹€æ…‹</label><select id="m-status" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800">${arrivalOptions.map(o => `<option ${itemData?.arrivalStatus == o ? 'selected' : ''}>${o}</option>`).join('')}</select></div></div><div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">æ¨™ç±¤</label><input type="text" id="m-tags" value="${itemData?.tags?.join(', ') || ''}" placeholder="ç”¨é€—è™Ÿåˆ†éš”" class="w-full bg-slate-50 rounded-xl p-3 text-sm text-gray-800"></div><div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">å‚™è¨»</label><textarea id="m-remark" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none h-16 resize-none text-gray-800">${itemData?.remark || ''}</textarea></div><div onclick="document.getElementById('m-img').click()" id="img-placeholder" class="bg-slate-50 border-2 border-dashed border-slate-100 rounded-3xl h-24 flex items-center justify-center overflow-hidden cursor-pointer shadow-inner">${state.tempImage ? `<img src="${state.tempImage}" class="w-full h-full object-cover">` : `<span class="text-slate-300 text-[10px] font-bold uppercase tracking-widest font-bold">ä¸Šå‚³ç›¸ç‰‡</span>`}</div><input type="file" id="m-img" accept="image/*" class="hidden" onchange="handleImage(this)"></div>`;
            } else {
                const today = new Date().toISOString().split('T')[0];
                form.innerHTML = `<div class="space-y-4"><div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">å•†å“åç¨±</label><input type="text" id="m-name" required value="${itemData?.name || ''}" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800 font-bold"></div><div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">é ä¼°åƒ¹æ ¼</label><input type="number" id="m-price" value="${itemData?.price || ''}" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800 font-bold"></div><div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">åˆ†é¡</label><select id="m-wish-cat" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800">${wishCategories.map(c => `<option value="${c}" ${itemData?.category == c ? 'selected' : ''}>${c}</option>`).join('')}</select></div><div class="grid grid-cols-2 gap-4"><div class="space-y-1 flex flex-col"><label class="text-[10px] font-bold text-slate-400 uppercase mb-1">ç™¼å”®æ—¥æœŸ</label><input type="date" id="m-release-date" value="${itemData?.releaseDate || today}" class="w-full bg-slate-50 rounded-xl p-3 text-sm text-gray-800"></div><div class="space-y-1 flex flex-col"><label class="text-[10px] font-bold text-slate-400 uppercase mb-1">æ™‚é–“</label><input type="time" id="m-release-time" value="${itemData?.releaseTime || '10:00'}" class="w-full bg-slate-50 rounded-xl p-3 text-sm text-gray-800"></div></div><div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">é¡˜æœ›å‚™è¨»</label><textarea id="m-remark" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none h-16 resize-none text-gray-800">${itemData?.remark || ''}</textarea></div><div onclick="document.getElementById('m-img').click()" id="img-placeholder" class="bg-slate-50 border-2 border-dashed rounded-3xl h-24 flex items-center justify-center cursor-pointer shadow-inner">${state.tempImage ? `<img src="${state.tempImage}" class="w-full h-full object-cover">` : `<span class="text-slate-300 text-xs font-bold">ä¸Šå‚³ç›¸ç‰‡</span>`}</div><input type="file" id="m-img" accept="image/*" class="hidden" onchange="handleImage(this)"></div>`;
            }
            
            document.getElementById('modal-overlay').classList.remove('hidden');
            setTimeout(() => { if (form) form.scrollTop = 0; }, 50);
        }

        async function saveData() {
            const n = document.getElementById('m-name')?.value; if (!n) return;
            const isExp = (state.activeTab === 'expense' || document.getElementById('m-qty'));
            const key = isExp ? 'expenses' : 'wishlist';
            let item;
            if (isExp) {
                const dateParts = document.getElementById('m-date').value.split('-');
                const y = Number(dateParts[0]), m = Number(dateParts[1]);
                const p = Number(document.getElementById('m-price').value), q = Number(document.getElementById('m-qty').value);
                item = { id: state.editingId || String(Date.now()), name: n, price: p, qty: q, total: p * q, category: document.getElementById('m-cat').value, year: y, month: m, image: state.tempImage, platform: document.getElementById('m-platform').value || 'æœªæ¨™è¨»', arrivalStatus: document.getElementById('m-status').value, tags: document.getElementById('m-tags').value.split(/[,ï¼Œ]/).map(t => t.trim()).filter(t => t), remark: document.getElementById('m-remark').value || '' };
            } else {
                item = { id: state.editingId || String(Date.now()), name: n, price: Number(document.getElementById('m-price').value) || 0, category: document.getElementById('m-wish-cat').value, releaseDate: document.getElementById('m-release-date').value, releaseTime: document.getElementById('m-release-time').value, remark: document.getElementById('m-remark').value || '', image: state.tempImage };
            }
            if (state.editingId) { const idx = state[key].findIndex(i => String(i.id) === state.editingId); if (idx !== -1) state[key][idx] = item; } else { state[key].push(item); }
            localStorage.setItem(`fe_v5_${key}`, JSON.stringify(state[key]));
            if (window.cloud) window.cloud.sync(state.expenses, state.wishlist);
            closeModal(); renderContent(); showToast("å·²å„²å­˜");
        }

        function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); }
        function closeDeleteModal() { document.getElementById('delete-modal-overlay').classList.add('hidden'); }
        function handleDelete(e, type, id) { e.stopPropagation(); state.deleteTarget = { type, id }; document.getElementById('delete-modal-overlay').classList.remove('hidden'); }
        async function confirmDelete() { const { type, id } = state.deleteTarget; const key = type === 'expense' ? 'expenses' : 'wishlist'; state[key] = state[key].filter(i => String(i.id) !== String(id)); localStorage.setItem(`fe_v5_${key}`, JSON.stringify(state[key])); if (window.cloud) window.cloud.sync(state.expenses, state.wishlist); closeDeleteModal(); renderContent(); }
        function handleEdit(e, type, id) { e.stopPropagation(); const list = type === 'expense' ? state.expenses : state.wishlist; const item = list.find(i => String(i.id) === String(id)); if (item) openAddModal(item); }
        function updateFilter(k, v) { if (k === 'year') state.filterYear = Number(v); else state.filterMonth = Number(v); renderContent(); }
        async function handleImage(input) { const file = input.files[0]; if (file) { const reader = new FileReader(); reader.onload = async (e) => { state.tempImage = await compressImage(e.target.result); document.getElementById('img-placeholder').innerHTML = `<img src="${state.tempImage}" class="w-full h-full object-cover">`; }; reader.readAsDataURL(file); } }
        function buyWish(id) { const wish = state.wishlist.find(i => String(i.id) === String(id)); if (wish) { state.activeTab = 'expense'; openAddModal({ ...wish, qty: 1, category: 'å‘¨é‚Šå•†å“', tags: ['é¡˜æœ›é”æˆ'], arrivalStatus: 'æœªåˆ°è²¨' }); } }
        function openLightbox(url, name, sub) { const overlay = document.getElementById('lightbox-overlay'); const img = document.getElementById('lightbox-img'); document.getElementById('lightbox-name').textContent = name; document.getElementById('lightbox-sub').textContent = sub; img.src = url; overlay.classList.remove('hidden'); }
        function closeLightbox() { document.getElementById('lightbox-overlay').classList.add('hidden'); }

        /**
         * 5. æ•¸æ“šåŒ¯å…¥èˆ‡åŒ¯å‡º (è¡Œåˆ—ç´¢å¼•æƒæç‰ˆ)
         */
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            const headers = Object.values(excelHeaderMap);
            const rows = state.expenses.map(i => { return Object.keys(excelHeaderMap).map(engKey => { let val = i[engKey]; if (engKey === 'tags' && Array.isArray(val)) return val.join(','); return (val !== undefined && val !== null) ? val : ""; }); });
            const wsExp = XLSX.utils.aoa_to_sheet([headers, ...rows]);
            XLSX.utils.book_append_sheet(wb, wsExp, "æ¶ˆè²»æ¸…å–®");
            XLSX.writeFile(wb, `è¿½æ˜Ÿè¨˜å¸³_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        function importFromExcel(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    if (!workbook.SheetNames.includes("æ¶ˆè²»æ¸…å–®")) { showToast("æ‰¾ä¸åˆ°ã€Œæ¶ˆè²»æ¸…å–®ã€å·¥ä½œè¡¨"); return; }
                    const worksheet = workbook.Sheets["æ¶ˆè²»æ¸…å–®"];
                    const aoa = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    if (aoa.length < 1) { showToast("æª”æ¡ˆç‚ºç©º"); return; }
                    const fileHeaders = aoa[0].map(h => String(h || "").trim());
                    const nameIdx = fileHeaders.indexOf("é …ç›®åç¨±");
                    if (nameIdx === -1) { showToast("æ‰¾ä¸åˆ°ã€Œé …ç›®åç¨±ã€æ¬„ä½"); return; }
                    const importedData = [];
                    for (let r = 1; r < aoa.length; r++) {
                        const row = aoa[r]; if (!row[nameIdx]) continue;
                        let item = { id: String(Date.now() + r), image: null };
                        Object.keys(excelHeaderMap).forEach(engKey => {
                            const chiKey = excelHeaderMap[engKey]; const colIdx = fileHeaders.indexOf(chiKey);
                            let val = colIdx > -1 ? row[colIdx] : "";
                            if (engKey === 'tags') item[engKey] = val ? String(val).split(',').map(t => t.trim()) : [];
                            else if (['year', 'month', 'price', 'qty'].includes(engKey)) item[engKey] = Number(val) || 0;
                            else item[engKey] = (val === undefined || val === null) ? "" : String(val);
                        });
                        item.total = Number(item.price) * Number(item.qty);
                        importedData.push(item);
                    }
                    if (importedData.length > 0) {
                        state.expenses = importedData;
                        localStorage.setItem('fe_v5_expenses', JSON.stringify(state.expenses));
                        if (window.cloud) window.cloud.sync(state.expenses, state.wishlist);
                        renderContent(); showToast(`åŒ¯å…¥æˆåŠŸï¼šå…± ${importedData.length} ç­†`);
                    } else { showToast("æœªåµæ¸¬åˆ°æœ‰æ•ˆé …ç›®"); }
                } catch (err) { showToast("æª”æ¡ˆæ ¼å¼éŒ¯èª¤"); }
            };
            reader.readAsArrayBuffer(file);
            input.value = "";
        }

        window.onload = () => { applyTheme(state.themeColor); switchTab('expense'); };
    </script>
</body>
</html>