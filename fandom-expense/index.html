<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- PWA ç›¸é—œæ¨™ç±¤ -->
    <meta name="theme-color" content="#92A8D1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="è¿½æ˜ŸéŒ¢åŒ…">
    <link rel="manifest" href="./manifest.json">
    <title>è¿½æ˜ŸéŒ¢åŒ…-è¨˜éŒ„ä½ çš„è¿½æ˜Ÿæ¶ˆè²»</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100..900&display=swap" rel="stylesheet">
    <style>
        *{
            font-family: "Noto Sans TC", sans-serif;
        }
        :root {
            --brand-color: #92A8D1; 
            --brand-gradient: linear-gradient(135deg, #F7CAC9 0%, #92A8D1 100%);
            --app-bg: #f8fafc;
            --card-bg: #ffffff;
            --income-color: #10b981;
            --income-bg-soft: #ecfdf5; /* äº®è‰²æ¨¡å¼ä¸‹çš„ç¶  */
            --income-bg: #ecfdf5;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --border-color: #f1f5f9;
            --hover-bg: #eeeeef;
        }

        body.dark-mode {
            --app-bg: #1a1a1a;
            --card-bg: #282828;
            --text-main: #ffffffe8;
            --text-sub: #94a3b8;
            --border-color: #2d2d2d;
            --income-bg: #326a63;
            --income-bg-soft: rgba(16, 185, 129, 0.1); /* æ·±è‰²æ¨¡å¼ä¸‹ç”¨ 10% çš„å“ç‰Œç¶  */
            --hover-bg: #363636;
        }
        /* ä¿®æ­£ iOS input å¯¬åº¦èˆ‡åŸç”Ÿæ¨£å¼ */
        input[type="month"], 
        input[type="date"] {
            -webkit-appearance: none; /* ç§»é™¤ iOS é è¨­å¤–è§€ */
            appearance: none;
            min-height: 44px;
            display: block;
            width: 100%;
            background-color: rgb(248 250 252 / var(--tw-bg-opacity, 1));
        }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--app-bg);
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s, color 0.3s;
        }

        .bg-brand { background: var(--brand-gradient) !important; }
        .text-brand { color: var(--brand-color) !important; }
        .text-income { color: var(--income-color) !important; }
        .tab-active { color: var(--brand-color) !important; font-weight: 900; }
        .custom-hover:hover {
            background-color: var(--hover-bg) !important;
        }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-enter { animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        .card-shadow { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); }
        body.dark-mode .card-shadow { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4); }
        
        .type-switcher button.active { background-color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); color: var(--brand-color); }
        .type-switcher button.active.income { color: var(--income-color); }

        .status-unArrived { background-color: #fee2e2; color: #ef4444; }
        .status-freight { background-color: #bcd7fa; color: #3170fa; }
        .status-toShip { background-color: #fef3c7; color: #d97706; }
        .status-soldout { background-color: #ffffff; color: #10b981; }
        .status-received { background-color: #dcfce7; color: #16a34a; }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none !important;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield !important;
            appearance: none !important;
        }

        .chip {
            flex-shrink: 0; padding: 6px 14px; border-radius: 12px; font-size: 11px;
            font-weight: 600; transition: all 0.2s; cursor: pointer;
            border: 1px solid var(--border-color); background-color: var(--card-bg); color: var(--text-sub);
        }
        .chip.active-tag { background: var(--brand-gradient) !important; color: #fff !important; border-color: transparent !important; }
        .report-range-btn.active { background: var(--brand-gradient); color: white; }
        
        .color-preset { width: 42px; height: 42px; border-radius: 50%; cursor: pointer; border: 2px solid #e2e8f0; transition: all 0.2s; }
        .color-preset.active { border-color: #fff !important; outline: 3px solid var(--brand-color); }
        .photo-tab.active { border-bottom: 3px solid var(--brand-color); color: var(--brand-color); font-weight: 900; }

        body.dark-mode .bg-white { background-color: var(--card-bg) !important; }
        body.dark-mode .bg-emerald-50{background-color: var(--income-bg) !important;}
        body.dark-mode .text-slate-800, body.dark-mode .text-gray-800{ color: #ffffffe8 !important; }
        body.dark-mode .text-slate-700, body.dark-mode .text-gray-700,body.dark-mode .text-slate-400,body.dark-mode .text-emerald-400  { color: #e9e9e9 !important; }
        body.dark-mode .text-slate-500 { color: #fcfcfc !important; }
        body.dark-mode .bg-slate-100 { background-color: #1a1a1a !important; }
        body.dark-mode .bg-slate-50 { background-color: #363636 !important; }
        body.dark-mode .border-gray-100 { border-color: #282828 !important; }
        body.dark-mode .bg-emerald-100{background-color: #a8d8b9 !important;}

        #toast {
            visibility: hidden; min-width: 200px; background-color: rgba(30, 41, 59, 0.95);
            color: #fff; text-align: center; border-radius: 16px; padding: 12px 24px;
            position: fixed; z-index: 999; left: 50%; bottom: 100px; transform: translateX(-50%);
            font-size: 14px; font-weight: 600; backdrop-filter: blur(8px); opacity: 0;
            transition: all 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 120px; }
        /* åˆ‡æ›é–‹é—œæ¨£å¼ */
        .inline-switcher {
            display: flex; background: #f1f5f9; padding: 2px; border-radius: 10px;
        }
        .dark-mode .inline-switcher { background: #1a1a1a; }
        .inline-switcher button { padding: 4px 12px; border-radius: 8px; font-size: 10px; font-weight: 900; transition: all 0.2s; }
        .inline-switcher button.active { background: white; color: var(--brand-color); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .dark-mode .inline-switcher button.active { background: #334155; color: white; }

        /* åˆ†äº«å¡æ¸²æŸ“å€å°ˆç”¨æ¨£å¼ï¼šå›ºå®šå¯¬åº¦èˆ‡éš±è— */
        #share-capture-zone {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 800px;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-card { animation: fadeInScale 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <main id="main-content" class="flex-grow overflow-y-auto no-scrollbar pb-20 sm:pb-36"></main>
    <div id="toast">æç¤ºè¨Šæ¯</div>
    <!-- æ‡¸æµ®æŒ‰éˆ•ç¾¤çµ„ -->
    <div class="fixed bottom-28 right-6 flex flex-col gap-4 z-40">
        <!-- åˆ†äº«æŒ‰éˆ• -->
        <button id="share" onclick="showShareConfirm()" class="share-btn-float w-14 h-14 bg-white/20 backdrop-blur-xl text-brand rounded-full shadow-lg flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 48 48" fill="currentColor">
                <path d="M 35.478516 5.9804688 A 2.0002 2.0002 0 0 0 34.085938 9.4140625 L 35.179688 10.507812 C 23.476587 10.680668 14 20.256715 14 32 A 2.0002 2.0002 0 1 0 18 32 C 18 22.427546 25.627423 14.702715 35.154297 14.517578 L 34.085938 15.585938 A 2.0002 2.0002 0 1 0 36.914062 18.414062 L 41.236328 14.091797 A 2.0002 2.0002 0 0 0 41.228516 10.900391 L 36.914062 6.5859375 A 2.0002 2.0002 0 0 0 35.478516 5.9804688 z M 12.5 6 C 8.9338464 6 6 8.9338464 6 12.5 L 6 35.5 C 6 39.066154 8.9338464 42 12.5 42 L 35.5 42 C 39.066154 42 42 39.066154 42 35.5 L 42 28 A 2.0002 2.0002 0 1 0 38 28 L 38 35.5 C 38 36.903846 36.903846 38 35.5 38 L 12.5 38 C 11.096154 38 10 36.903846 10 35.5 L 10 12.5 C 10 11.096154 11.096154 10 12.5 10 L 20 10 A 2.0002 2.0002 0 1 0 20 6 L 12.5 6 z"></path>
            </svg>
        </button>
        
        <!-- åŠ è™ŸæŒ‰éˆ• -->
        <button id="fab" onclick="openAddModal()" class="bg-brand w-14 h-14 text-white rounded-full flex items-center justify-center text-3xl shadow-lg active:scale-90 transition-transform">ï¼‹</button>
    </div>
    <!-- åº•éƒ¨å°è¦½ -->
    <footer class="fixed bottom-0 w-full bg-white backdrop-blur-md border-t border-gray-100 flex justify-around items-center h-20 safe-area-bottom z-50 px-2 shadow-[0_-4px_10px_rgba(0,0,0,0.03)]">
        <button onclick="switchTab('expense')" id="tab-expense" class="flex-1 flex flex-col items-center gap-1 text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 012-2h2a2 2 0 012 2" stroke-width="2"/></svg>
            <span class="text-[10px] font-bold">æ¶ˆè²»æ¸…å–®</span>
        </button>
        <button onclick="switchTab('report')" id="tab-report" class="flex-1 flex flex-col items-center gap-1 text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" stroke-width="2"/><path d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" stroke-width="2"/></svg>
            <span class="text-[10px] font-bold">è²¡å‹™å ±è¡¨</span>
        </button>
        <button onclick="switchTab('wish')" id="tab-wish" class="flex-1 flex flex-col items-center gap-1 text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" stroke-width="2"/></svg>
            <span class="text-[10px] font-bold">é¡˜æœ›æ¸…å–®</span>
        </button>
        <button onclick="switchTab('settings')" id="tab-settings" class="flex-1 flex flex-col items-center gap-1 text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" stroke-width="2"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke-width="2"/></svg>
            <span class="text-[10px] font-bold">è¨­å®š</span>
        </button>
    </footer>

    <!-- å½ˆçª—å…§å®¹ -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/60 hidden z-[60] flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div id="modal-container" class="bg-white w-full max-w-lg rounded-t-3xl sm:rounded-3xl overflow-hidden modal-enter shadow-2xl">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="modal-title" class="text-xl font-bold text-gray-800">æ–°å¢æ¶ˆè²»</h3>
                    <button onclick="closeModal()" class="text-gray-400 p-2 text-xl">âœ•</button>
                </div>
                <form id="data-form" class="space-y-4 max-h-[60vh] overflow-y-auto no-scrollbar pb-6 px-1"></form>
                <div class="pt-4 border-t border-gray-50 flex gap-3">
                    <button onclick="closeModal()" class="flex-1 bg-gray-100 text-gray-500 font-bold py-4 rounded-2xl active:scale-95 transition-transform">å–æ¶ˆ</button>
                    <button onclick="saveData()" class="bg-brand flex-[2] text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-transform">ç¢ºèªå„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ“ä½œé¸å–®å…±ç”¨å½ˆçª— -->
    <div id="action-modal-overlay" onclick="closeActionModal()" class="fixed inset-0 bg-black/60 hidden z-[70] flex items-end justify-center p-0">
        <div id="action-modal-container" onclick="event.stopPropagation()" class="bg-slate-100 w-full max-w-lg rounded-t-[2.5rem] overflow-hidden modal-enter p-8 space-y-4 shadow-2xl">
            <!-- é ‚éƒ¨è£é£¾æ¢ -->
            <div class="w-12 h-1.5 bg-slate-300 rounded-full mx-auto mb-4"></div>
            <div class="space-y-3">
                <button id="action-convert-btn" onclick="triggerConvertToExpense()" class="hidden w-full flex items-center justify-between p-2 bg-white rounded-2xl font-bold text-slate-700 active:scale-[0.98] transition-all">
                    <div class="flex items-center gap-4">
                        <span>åŠ å…¥æ¶ˆè²»æ¸…å–®</span>
                    </div>
                    <div class="w-10 h-10 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="23" height="23" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path><line x1="12" y1="10" x2="18" y2="10"></line><line x1="15" y1="6" x2="15" y2="13"></line></svg>
                    </div>
                </button>
                <!-- ç·¨è¼¯æŒ‰éˆ• -->
                <button onclick="triggerEditFromAction()" class="w-full flex items-center justify-between p-2 bg-white rounded-2xl font-bold text-slate-700 active:scale-[0.98] transition-all">
                    <div class="flex items-center gap-4">
                        <span>ç·¨è¼¯è³‡æ–™</span>
                    </div>
                    <div class="w-10 h-10 flex items-center justify-center ">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" stroke-width="2"/></svg>
                    </div>
                </button>
                <!-- è¤‡è£½æŒ‰éˆ• -->
                <button onclick="triggerCopyFromAction()" class="w-full flex items-center justify-between p-2 bg-white rounded-2xl font-bold text-slate-700 active:scale-[0.98] transition-all">
                    <div class="flex items-center gap-4">
                        <span>è¤‡è£½ä¸¦æ–°å¢</span>
                    </div>
                    <div class="w-10 h-10 flex items-center justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                </button>
                <!-- åˆªé™¤æŒ‰éˆ• -->
                <button onclick="triggerDeleteFromAction()" class="w-full flex items-center justify-between p-2 bg-white rounded-2xl font-bold text-red-500 active:scale-[0.98] transition-all">
                    <div class="flex items-center gap-4">
                        <span>åˆªé™¤è³‡æ–™</span>
                    </div>
                     <div class="w-10 h-10 rounded-xl flex items-center justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2"/></svg>
                    </div> 
                </button>
            </div>
        </div>
    </div>
    
     <!-- é€šç”¨ç¢ºèªå½ˆçª— -->
    <div id="common-confirm-overlay" class="fixed inset-0 bg-black/70 hidden z-[110] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xs rounded-3xl overflow-hidden p-6 text-center shadow-2xl scale-95">
            <div id="confirm-icon" class="w-16 h-16 bg-brand/10 text-brand rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">ğŸ—‘ï¸</div>
            <h3 id="confirm-title" class="text-lg font-bold text-gray-800 mb-2">ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ</h3>
            <p id="confirm-desc" class="text-sm text-gray-400 mb-6">ç´€éŒ„åˆªé™¤å¾Œå°‡ç„¡æ³•æ¢å¾©ã€‚</p>
            <div class="flex gap-3">
                <button id="confirm-btn-cancel" class="flex-1 bg-gray-100 text-gray-500 font-bold py-3 rounded-xl active:scale-95">å–æ¶ˆ</button>
                <button id="confirm-btn-ok" class="bg-brand flex-1 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95">ç¢ºå®š</button>
            </div>
        </div>
    </div>
    <!-- è‡ªè¨‚æ¼¸å±¤å½ˆçª— -->
    <div id="grad-modal" class="fixed inset-0 bg-black/70 hidden z-[110] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl">
            <h3 class="text-lg font-bold text-center text-slate-800">è¨­å®šè‡ªè¨‚æ¼¸å±¤</h3>
            <p class="text-[10px] font-bold text-slate-400 mb-4 text-center">è‹¥ä½¿ç”¨æ·±è‰²æ¨¡å¼ï¼Œå»ºè­°å°‡æ·ºè‰²è¨­ç‚ºèµ·å§‹å€¼</p>
            
            <div class="space-y-4 mb-6">
                <div class="space-y-1">
                    <div class="flex items-center gap-1 mb-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">èµ·å§‹é¡è‰² (HEX)</label>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="g1-hex" placeholder="#000000" oninput="syncGradInput('g1')" 
                            class="flex-grow bg-slate-50 border-2 border-transparent focus:border-brand rounded-xl px-3 py-2 text-sm font-mono outline-none">
                        <input type="color" id="g1-picker" oninput="syncGradPicker('g1')" class="w-10 h-10 border-none bg-transparent cursor-pointer">
                    </div>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase">çµæŸé¡è‰² (HEX)</label>
                    <div class="flex gap-2">
                        <input type="text" id="g2-hex" placeholder="#FF85D0" oninput="syncGradInput('g2')" 
                            class="flex-grow bg-slate-50 border-2 border-transparent focus:border-brand rounded-xl px-3 py-2 text-sm font-mono outline-none">
                        <input type="color" id="g2-picker" oninput="syncGradPicker('g2')" class="w-10 h-10 border-none bg-transparent cursor-pointer">
                    </div>
                </div>

                <div id="grad-preview-box" class="w-full h-10 rounded-xl border border-slate-100 shadow-inner"></div>
            </div>

            <div class="flex gap-3">
                <button onclick="document.getElementById('grad-modal').classList.add('hidden')" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button>
                <button onclick="saveGrad()" class="bg-brand flex-[2] text-white py-3 rounded-xl shadow-lg font-bold">å„²å­˜ä¸¦å¥—ç”¨</button>
            </div>
        </div>
    </div>
    <!-- ç‡ˆç®± -->
    <div id="lightbox-overlay" onclick="closeLightbox()" class="fixed inset-0 bg-black/95 hidden z-[200] flex flex-col items-center justify-center p-4">
        <div class="relative w-full max-w-md">
            <img id="lightbox-img" src="" class="w-full h-auto rounded-3xl shadow-2xl">
            <div id="lightbox-info" class="absolute bottom-5 left-0 right-0 text-white text-center">
                <p id="lightbox-name" class="font-black text-lg"></p>
                <p id="lightbox-sub" class="text-white/60 text-xs"></p>
            </div>
        </div>
    </div>

    <!-- åˆ†äº«ç¢ºèªå½ˆçª— -->
    <div id="share-confirm-overlay" class="fixed inset-0 bg-black/70 hidden z-[90] flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 w-full max-w-xs rounded-[2.5rem] p-8 text-center card-shadow animate-card">
            <div class="w-16 h-16 bg-brand/10 text-brand rounded-full flex items-center justify-center mx-auto mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 20v-8m0 0l-4 4m4-4l4 4M4 12V7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
            <h3 class="text-xl font-black text-slate-800 dark:text-white mb-3">ç”Ÿæˆåˆ†äº«åœ–ï¼Ÿ</h3>
            <p class="text-sm text-slate-400 leading-relaxed mb-8"><b>(ç›®å‰å¯èƒ½æœƒå¤±æ•— æ¸¬è©¦ä¸­è«‹ç¨å¾ŒTT)</b> <br>ç³»çµ±å°‡æ ¹æ“šæ‚¨ç›®å‰ç¯©é¸æœˆä»½çš„æ¶ˆè²»æ•¸æ“šç”Ÿæˆåœ–ç‰‡ä¹å®®æ ¼åˆ†äº«å¡ç‰‡ã€‚ç¬¬ä¸€æ¬¡è¼‰å…¥éœ€ 2-3 ç§’è™•ç†åœ–ç‰‡ã€‚</p>
            <div class="flex flex-col gap-3">
                <button onclick="startShareGeneration()" class="w-full bg-brand text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition-all">é–‹å§‹ç”Ÿæˆ</button>
                <button onclick="document.getElementById('share-confirm-overlay').classList.add('hidden')" class="w-full text-slate-400 font-bold py-2 text-sm">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- åˆ†äº«åœ–ç‰‡é è¦½å½ˆçª— -->
    <div id="share-modal" class="fixed inset-0 bg-black/90 hidden z-[100] flex flex-col items-center p-6 overflow-y-scroll md:justify-start justify-center" onclick="this.classList.add('hidden')">
        <div class="w-full max-w-sm relative" onclick="event.stopPropagation()">
            
            <div class="flex justify-end mb-4">
                <button onclick="drawShareCard(true)" class="text-white/60 hover:text-white flex items-center gap-2 text-xs font-bold transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    <span>é‡æ–°ç”Ÿæˆ</span>
                </button>
            </div>

            <div id="share-result-container" class="rounded-[2.5rem]  shadow-2xl bg-white min-h-[400px] flex justify-center">
                <div class="p-10 text-center">
                    <div class="w-12 h-12 border-4 border-brand border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                    <p class="text-slate-400 text-sm font-bold tracking-widest uppercase italic leading-loose">æ­£åœ¨ç”Ÿæˆåœ–ç‰‡ä¸­...</p>
                </div>
            </div>
            <div class="mt-8 flex gap-3 w-full">
                <button onclick="document.getElementById('share-modal').classList.add('hidden')" class="flex-1 bg-white/20 text-white font-bold py-4 rounded-2xl">è¿”å›</button>
                <button id="download-trigger" class="flex-[1.5] bg-brand text-white font-black py-4 rounded-2xl shadow-lg uppercase tracking-widest">å„²å­˜</button>
            </div>
        </div>
    </div>
        <!-- åˆ†äº«å¡æ•æ‰å€åŸŸ (éš±è—åœ¨è¦–çª—å¤–) -->
    <div id="share-capture-zone">
        <div id="share-card" class="relative w-[1080px] h-[1920px] rounded-[60px] overflow-hidden bg-brand text-white flex flex-col">
            <!-- è£é£¾å…ƒç´  -->
            <div class="absolute -top-[300px] -right-[300px] w-[700px] h-[700px] rounded-full bg-white/10"></div>
            <div class="absolute -bottom-[200px] -left-[200px] w-[500px] h-[500px] rounded-full bg-white/10"></div>

            <div class="relative px-[100px] pt-[150px] flex-grow">
                <!-- æ¨™é¡Œå€åŸŸ (è‹±æ–‡æœˆä»½) -->
                <div class="flex items-end">
                    <div id="share-title" class="text-[110px] font-black leading-none tracking-tighter italic uppercase">JANUARY</div>
                    <div id="share-title-sub" class="text-[50px] font-black leading-none tracking-tighter italic uppercase">2026</div>
                </div>

                <div class="mt-4 text-[26px] tracking-[0.2em] opacity-60 font-black uppercase">Bankruptcy Report of the Month</div>

                <!-- è¿½æ˜Ÿäººæ ¼å€ -->
                <div class="mt-[80px]">
                    <div class="text-[36px] font-bold opacity-70 tracking-widest uppercase mb-4 italic">è¿½æ˜Ÿæ¶ˆè²»åˆ†æ</div>
                    <div id="share-personality" class="text-[50px] font-black leading-tight tracking-tighter drop-shadow-xl min-h-[120px]">è¿½æ˜Ÿç©å®¶ï½œå°ç²‰çµ²</div>
                </div>

                <!-- ç…§ç‰‡ä¹å®®æ ¼ (ç¢ºä¿å›ºå®šé«˜åº¦èˆ‡æ ¼å­é–“è·) -->
                <div id="share-photo-grid" class="mt-[60px] grid grid-cols-3 gap-[30px]">
                    <!-- JS å‹•æ…‹æ’å…¥ 9 å€‹æ ¼å­ -->
                </div>
            </div>

            <!-- åº•éƒ¨æµ®æ°´å° -->
            <div class="relative pb-[120px] px-[100px]">
            <div class="w-full h-px bg-white/20 mb-12"></div>

            <div class="flex items-center justify-between">
                <!-- å·¦å´ï¼šIcon + æ¨™é¡Œ -->
                <div class="flex items-center gap-6">
                    <div class="bg-white w-[132px] h-[132px] rounded-xl justify-items-center content-center"><img src="qrcode.png"class="w-[120px] h-[120px]" alt=""></div>
                    <div class="flex-row">
                        <div class="text-[46px] font-black leading-tight">
                            è¿½æ˜ŸéŒ¢åŒ…<span class="ml-2 text-[25px] opacity-70 uppercase">FANDOM WALLET</span>
                        </div>
                        <div class="mt-2 text-[28px] opacity-70">ç®¡ç†ä½ çš„å‘¨é‚Šï¼Œè¨˜éŒ„ä½ çš„è¿½æ˜Ÿæ­·ç¨‹</div>
                    </div>
                </div>
            </div>
            </div>

        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject, listAll} from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";
    import { getAnalytics,logEvent } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-analytics.js";

    const firebaseConfig = {
        apiKey:"AIzaSyCiJHNQcqr07KVu4Xh6KjOQ9KmVS9YG78A",
        authDomain: "fandom-expense.firebaseapp.com",
        projectId: "fandom-expense",
        storageBucket: "fandom-expense.firebasestorage.app",
        messagingSenderId: "275234127604",
        appId: "1:275234127604:web:af62f27f272290236ae8a1",
        measurementId: "G-4QE8P5ZDQ6"
    };

    const appId = 'fandom-expense-v11'; 
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    window.cloud = {
        login: async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (err) {
                console.error("Login Error:", err);
                showToast("ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥å½ˆçª—è¨­å®š");
            }
        },
        logout: async () => { await signOut(auth); localStorage.clear(); location.reload(); },
        uploadFile: async (blob, fileName) => {
            if (!auth.currentUser) return null;
            try {
                const fileRef = ref(storage, `users/${auth.currentUser.uid}/images/${fileName}`);
                
                const metadata = {
                    cacheControl: 'public, max-age=31536000', // ç¶­æŒå¿«å–ä¸€å¹´
                    contentType: blob.type // <--- é€™è£¡æ”¹ç‚ºå‹•æ…‹ç²å–ï¼Œä¸ç®¡æ˜¯ png, jpeg, webp éƒ½æœƒæ­£ç¢ºæ¨™è¨˜
                };
                
                const snapshot = await uploadBytes(fileRef, blob, metadata);
                return await getDownloadURL(snapshot.ref);
            } catch (e) {
                console.error("Upload failed:", e);
                showToast("é›²ç«¯ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ‰‹æ©Ÿæ¬Šé™",e);
                return null;
            }
        },
        deleteFile: async (url) => {
            if (!url) return;
            try {
                // åœ¨æ¨¡çµ„å…§éƒ¨ï¼Œref æ˜¯å¯ä»¥è¢«å­˜å–çš„
                const fileRef = ref(storage, url);
                await deleteObject(fileRef);
                console.log("é›²ç«¯æª”æ¡ˆåˆªé™¤æˆåŠŸ");
                return true;
            } catch (e) {
                console.error("é›²ç«¯æª”æ¡ˆåˆªé™¤å¤±æ•—:", e);
                return false;
            }
        },
        cleanupOrphanedFiles: async (activeUrls) => {
            if (!auth.currentUser) return;
            try {
                const listRef = ref(storage, `users/${auth.currentUser.uid}/images/`);
                const res = await listAll(listRef);
                
                let deleteCount = 0;
                for (const itemRef of res.items) {
                    // å–å¾—è©²æª”æ¡ˆçš„ä¸‹è¼‰ç¶²å€ä¾†åšæ¯”å°
                    const downloadUrl = await getDownloadURL(itemRef);
                    if (!activeUrls.includes(downloadUrl)) {
                        await deleteObject(itemRef);
                        deleteCount++;
                        console.log(`å·²æ¸…ç†å­¤å…’æª”æ¡ˆ: ${itemRef.name}`);
                    }
                }
                return deleteCount;
            } catch (e) {
                console.error("æ¸…ç†å¤±æ•—:", e);
                return -1;
            }
        },
        sync: async (expenses, wishlist) => {
            if (!auth.currentUser || auth.currentUser.isAnonymous) return;
            try {
                // ä¿®æ­£ï¼šè·¯å¾‘å¢åŠ  'main' ä½¿å…¶è®Šç‚ºå¶æ•¸å° (6å±¤)
                const userDoc = doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'userData', 'main');
                await setDoc(userDoc, { expenses, wishlist }, { merge: true });
            } catch (e) { console.error("Sync failed:", e); }
        },
        pull: async () => {
            if (!auth.currentUser || auth.currentUser.isAnonymous) return null;
            try {
                // ä¿®æ­£ï¼šè·¯å¾‘å¿…é ˆèˆ‡ sync ä¸€è‡´
                const userDoc = doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'userData', 'main');
                const snap = await getDoc(userDoc);
                return snap.exists() ? snap.data() : null;
            } catch (e) { return null; }
        }
    };

    onAuthStateChanged(auth, async (user) => {
        state.user = (user && !user.isAnonymous) ? user : null;
        if (state.user) {
            const data = await window.cloud.pull();
            if (data) {
                state.expenses = data.expenses || state.expenses;
                state.wishlist = data.wishlist || state.wishlist;
                localStorage.setItem(`fe_v11_expenses`, JSON.stringify(state.expenses));
                localStorage.setItem(`fe_v11_wishlist`, JSON.stringify(state.wishlist));
            }
        }
        renderContent();
    });
    window.onerror = function (message, source, lineno, colno, error) {
        reportEvent('js_error', {
            message: String(message),
            source,
            lineno,
            colno
        });
    };
    function reportEvent(name, params = {}) {
        if (!analytics) return;
        try {
            logEvent(analytics, name, params);
        } catch (e) {
            console.warn('Analytics logEvent failed', e);
        }
    }
</script>


    <script>
        /**
         * 1. ç‹€æ…‹ç®¡ç†
         */
        let state = {
            activeTab: 'expense',
            subPage: null,
            photoWallTab: 'purchased',
            themeColor: localStorage.getItem('fe_v11_theme') || 'svt', 
            tempType: 'expense',
            expenses: JSON.parse(localStorage.getItem('fe_v11_expenses')) || [],
            tempImage: null,     // ç”¨ä¾†å­˜æ—¢æœ‰çš„åœ–ç‰‡ç¶²å€ (URL)
            tempImageBlob: null, // ç”¨ä¾†å­˜æ–°é¸å–çš„åœ–ç‰‡æª”æ¡ˆ (Blob)
            wishlist: JSON.parse(localStorage.getItem('fe_v11_wishlist')) || [],
            wishSourceId: null, // ç”¨ä¾†æš«å­˜è½‰æ›ä¸­çš„é¡˜æœ› ID
            filterYear: Number(new Date().getFullYear()),
            filterMonth: Number(new Date().getMonth() + 1),
            reportRange: '6months', 
            reportOffset: 0,
            searchKeyword: '',
            selectedCategory: '',
            photoFilterCat: '',
            editingId: null,
            actionTarget: { type: null, id: null },
            user: null,
            hideAmount: JSON.parse(localStorage.getItem('fe_v11_hideAmount')) || false, //ç¸½é‡‘é¡éš±è—ç‹€æ…‹
            reportType: 'expense',
            categorySet: 'categories',//kpop/acgn
            WishcategorySet:'wishCategories',
            rates: { KRW: 0.022, JPY: 0.21, CNY: 4.5, USD: 32.0, HKD: 4.05 },
            rateStatusText: 'åŒ¯ç‡å·²å°±ç·’',
            enableExchange :false,
            defaultCurrency:'TWD'
        };

        function setTempType(type) { //åˆ‡æ›æ¶ˆè²»/å”®å‡º
            state.tempType = type;
            const isExp = type === 'expense';
            const btnExp = document.getElementById('btn-type-exp');
            const btnInc = document.getElementById('btn-type-inc');
            if(btnExp && btnInc) {
                btnExp.className = `flex-1 py-2 text-xs font-bold rounded-xl transition-all ${isExp ? 'active shadow-sm' : 'text-slate-400'}`;
                btnInc.className = `flex-1 py-2 text-xs font-bold rounded-xl transition-all ${!isExp ? 'active shadow-sm income' : 'text-slate-400'}`;
            }
            const shippingFee = document.getElementById('shipping-fee');
            const shippingPay = document.getElementById('shipping-payment');
            const shippingState = document.getElementById('shipping-state');
            const statusSelect = document.getElementById('m-status');
            if (statusSelect) {
                const optionsToShow = isExp  ? arrivalOptions.filter(o => o !== 'å·²å”®å‡º') : ['å·²å”®å‡º'];
                statusSelect.innerHTML = optionsToShow.map(o => `<option value="${o}">${o}</option>`).join('');
                //if (!isExp) { statusSelect.value = 'å·²å”®å‡º'; }
                //ç·¨è¼¯æ™‚è£œå›åŸæœ¬çš„ç‹€æ…‹
                if (!isExp) {
                    // å”®å‡ºæ¨¡å¼
                    if (state.editingId !== null) {
                        const item = state.expenses.find(e => e.id === state.editingId);
                        statusSelect.value = 'å·²å”®å‡º';
                    } else {
                        statusSelect.value = 'å·²å”®å‡º';
                    }
                } else if (state.editingId !== null) {
                    // æ¶ˆè²»æ¨¡å¼ï¼Œç·¨è¼¯æ™‚é‚„åŸåŸæœ¬ç‹€æ…‹
                    const item = state.expenses.find(e => e.id === state.editingId);
                   // if (item?.arrivalStatus) statusSelect.value = item.arrivalStatus;
                   if (item?.arrivalStatus) {
                        // å¦‚æœåŸæœ¬æ˜¯å·²å”®å‡ºåˆ‡æ›å›æ¶ˆè²»æ¨¡å¼ï¼Œæ”¹æˆæœªåˆ°è²¨
                        statusSelect.value = item.arrivalStatus === 'å·²å”®å‡º' ? 'æœªåˆ°è²¨' : item.arrivalStatus;
                    }
                    
                }
            }
           if (isExp) {
                shippingFee.classList.remove('hidden');
                shippingState.classList.remove('hidden');
                shippingPay.classList.remove('hidden');
            } else {
                shippingFee.classList.add('hidden');
                //shippingState.classList.add('hidden');
                shippingPay.classList.add('hidden');
            }
        }

        const excelHeaderMap = {
            type: "æ”¶æ”¯é¡å‹",name: "é …ç›®åç¨±", price: "å–®åƒ¹", qty: "æ•¸é‡",shipping:"é‹è²»",category: "åˆ†é¡",
            year: "æ¶ˆè²»å¹´ä»½", month: "æ¶ˆè²»æœˆä»½",day:"æ¶ˆè²»æ—¥æœŸ", platform: "æ”¶ç‰©å¹³å°",
            arrivalStatus: "åˆ°è²¨ç‹€æ…‹", paymentMethod: "ä»˜æ¬¾æ–¹å¼", paidAmount: "å·²ä»˜é‡‘é¡", tags: "æ¨™ç±¤", remark: "å‚™è¨»"
        };

        const categories = [
            { id: 'å°ˆè¼¯', icon: 'ğŸµ', color: '#6366f1' },            
            { id: 'å°å¡', icon: 'âœ¨', color: '#eab308' },               
            { id: 'æ¼”å”±æœƒ / è¦‹é¢æœƒé–€ç¥¨', icon: 'ğŸ«', color: '#f43f5e' },  
            { id: 'å‘¨é‚Šå•†å“', icon: 'ğŸ’', color: '#0ea5e9' },     
            { id: 'å¨ƒå¨ƒ', icon: 'ğŸ§¸', color: '#f97316' },               
            { id: 'æœƒå“¡è²»', icon: 'ğŸ«§', color: '#8b5cf6' },             
            { id: 'äº¤é€š / ä½å®¿', icon: 'âœˆï¸', color: '#10b981' },          
            { id: 'å…¶ä»–è¿½æ˜Ÿæ”¯å‡º', icon: 'ğŸŒˆ', color: '#64748b' }           
        ];

        const categoriesACGN = [
            { id: 'æ¼«ç•« / è¼•å°èªª', icon: 'ğŸ“–', color: '#6366f1' },        
            { id: 'ç«‹ç‰Œ / åŠé£¾', icon: 'ğŸª§', color: '#f59e0b' },          
            { id: 'å°å¡ / è‰²ç´™', icon: 'ğŸƒ', color: '#d946ef' },          
            { id: 'æ˜ä¿¡ç‰‡ / æµ·å ±', icon: 'ğŸ–¼ï¸', color: '#ec4899' },       
            { id: 'å¾½ç«  / å£“å…‹åŠ›', icon: 'ğŸ“', color: '#0ea5e9' },        
            { id: 'å…¬ä»” / å¨ƒå¨ƒ', icon: 'ğŸ§¸', color: '#f97316' },          
            { id: 'ä¸€ç•ªè³', icon: 'ğŸ¯', color: '#eab308' },              
            { id: 'è¯åæœé£¾', icon: 'ğŸ‘•', color: '#22c55e' },             
            { id: 'æ´»å‹•é–€ç¥¨ / å±•è¦½ / é›»å½±ç¥¨', icon: 'ğŸŸï¸', color: '#f43f5e' }, 
            { id: 'å…¶ä»–æ”¯å‡º', icon: 'ğŸ“¦', color: '#64748b' }             
        ];
        const wishCategories = ["å°ˆè¼¯", "å‘¨é‚Šå•†å“", "å¨ƒå¨ƒ", "å°å¡","æ¼”å”±æœƒ / è¦‹é¢æœƒé–€ç¥¨"];
        const wishCategoriesACGN = ["æ¼«ç•« / è¼•å°èªª", "ç«‹ç‰Œ / åŠé£¾", "å°å¡ / è‰²ç´™","æ˜ä¿¡ç‰‡ / æµ·å ±","å¾½ç«  / å£“å…‹åŠ›","å…¬ä»” / å¨ƒå¨ƒ","å…¶ä»–å‘¨é‚Š"];
        const arrivalOptions = ['æœªåˆ°è²¨','å¾…äºŒè£œ', 'å¾…å‡ºè²¨', 'å·²å–è²¨','å·²å”®å‡º'];
        const paymentOptions = ['å¾…ä»˜æ¬¾', 'è²¨åˆ°ä»˜æ¬¾', 'åŒ¯æ¬¾å…¨é¡', 'å·²ä»˜è¨‚é‡‘','ä¿¡ç”¨å¡','ç¾é‡‘'];
        let myChart = null;
        /**æ»‘å‹•é—œé–‰ç·¨è¼¯é‚è¼¯ */
        let touchStartY = 0;
        let isDragging = false;
        // å–å¾—ç•¶å‰çµ„åˆ¥çš„åˆ†é¡é™£åˆ—
        function getCurrentCategories() {
            return state.categorySet === 'categories' ? categories : categoriesACGN;
        }
        function getCurrentWishCategories() {
            return state.WishcategorySet === 'wishCategories' ? wishCategories : wishCategoriesACGN;
        }
        function switchCatSet(setName) {
            state.categorySet = setName;
            if(setName =='categories'){state.WishcategorySet = wishCategories;}else{state.WishcategorySet = wishCategoriesACGN;}
            state.selectedCategory = ''; // åˆ‡æ›çµ„åˆ¥æ™‚é‡è¨­é¸æ“‡
            localStorage.setItem('fe_cat_set', setName);
            renderContent();
            showToast(`å·²åˆ‡æ›è‡³ ${setName === 'categories' ? 'KPOPåˆ†é¡' : 'ACGNåˆ†é¡'}`);
        }
        function initSwipeToClose() {
            const container = document.getElementById('action-modal-container');
            const overlay = document.getElementById('action-modal-overlay');
            
            container.addEventListener('touchstart', (e) => {
                touchStartY = e.touches[0].clientY;
                isDragging = true;
                container.classList.add('dragging');
            }, { passive: true });

            container.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                const currentY = e.touches[0].clientY;
                const deltaY = currentY - touchStartY;
                
                if (deltaY > 0) { // åªæœ‰å‘ä¸‹åŠƒæ™‚æœ‰åæ‡‰
                    container.style.transform = `translateY(${deltaY}px)`;
                    // èƒŒæ™¯é€æ˜åº¦éš¨æ»‘å‹•è·é›¢è®Šæ·¡
                    const opacity = Math.max(0, 0.6 - (deltaY / 500));
                    overlay.style.backgroundColor = `rgba(0, 0, 0, ${opacity})`;
                }
            }, { passive: true });

            container.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                isDragging = false;
                container.classList.remove('dragging');
                
                const currentY = e.changedTouches[0].clientY;
                const deltaY = currentY - touchStartY;

                if (deltaY > 120) { // æ»‘å‹•é–€æª»ï¼š120px
                    closeActionModal();
                } else {
                    // å½ˆå›åŸä½
                    container.style.transform = 'translateY(0)';
                    overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.6)';
                }
            });
        }

        /**
         * 2. å·¥å…·å‡½å¼
         */
        function showToast(msg) {
            const t = document.getElementById("toast");
            if(!t) return;
            t.textContent = msg; t.classList.add("show");
            setTimeout(() => t.classList.remove("show"), 2000);
        }
        //æ¼¸å±¤å·¥å…·
        // åŒæ­¥ï¼šè¼¸å…¥æ–‡å­—æ¡† -> è‰²ç›¤
        function syncGradInput(id) {
            const inputEl = document.getElementById(`${id}-hex`);
            let hex = inputEl.value.trim();
            // 1. è‡ªå‹•è£œäº•å­—è™Ÿ
            if (hex.length > 0 && !hex.startsWith('#')) {
                hex = '#' + hex;
                inputEl.value = hex;
            }
            const isValid = /^#[0-9A-F]{6}$/i.test(hex);

            if (isValid) {
                document.getElementById(`${id}-picker`).value = hex;
                inputEl.style.borderColor = 'transparent'; // ç§»é™¤ç´…æ¡†
                updateGradPreview();
            } else {// å¦‚æœé•·åº¦å·²ç¶“å¤ äº†(7ç¢¼)ä½†æ ¼å¼ä¸å°ï¼Œæˆ–æ˜¯è¼¸å…¥ä¸­
                if (hex.length >= 7) {
                    inputEl.style.borderColor = '#ef4444'; 
                } else {
                    inputEl.style.borderColor = 'transparent';
                }
            }
        }

        // åŒæ­¥ï¼šè‰²ç›¤ -> è¼¸å…¥æ–‡å­—æ¡†
        function syncGradPicker(id) {
            const val = document.getElementById(`${id}-picker`).value;
            document.getElementById(`${id}-hex`).value = val.toUpperCase();
            updateGradPreview();
        }

        // æ›´æ–°é è¦½å€
        function updateGradPreview() {
            const c1 = document.getElementById('g1-picker').value;
            const c2 = document.getElementById('g2-picker').value;
            document.getElementById('grad-preview-box').style.background = `linear-gradient(135deg, ${c1}, ${c2})`;
        }

        // é–‹å•Ÿä¸¦åˆå§‹åŒ–å½ˆçª—
        function openGradModal() {
            // 1. é¡¯ç¤ºå½ˆçª—
            document.getElementById('grad-modal').classList.remove('hidden');
            
            // 2. è¨­å®šé è¨­å€¼ (é¿å…æ²’æŠ“åˆ°é¡è‰²æ™‚å ±éŒ¯)
            let color1 = "#F7CAC9"; 
            let color2 = "#92A8D1"; 

            // 3. æ ¹æ“šç›®å‰çš„ç‹€æ…‹ state.themeColor è§£æé¡è‰²
            if (state.themeColor.includes('gradient') && state.themeColor !== 'svt') {
                // å¦‚æœæ˜¯è‡ªè¨‚æ¼¸å±¤ï¼Œç”¨æ­£å‰‡è¡¨é”å¼æŠ“å–è‰²ç¢¼
                const matchedColors = state.themeColor.match(/#[A-Fa-f0-9]{3,6}/g);
                if (matchedColors && matchedColors.length >= 2) {
                    color1 = matchedColors[0];
                    color2 = matchedColors[1];
                }
            } else if (state.themeColor === 'svt') {
                color1 = "#F7CAC9";
                color2 = "#92A8D1";
            } else if (state.themeColor.startsWith('#')) {
                // å¦‚æœæ˜¯ç´”è‰²ï¼Œèµ·å§‹è¨­ç‚ºè©²è‰²ï¼ŒçµæŸè¨­ç‚ºç™½è‰²
                color1 = state.themeColor;
                color2 = "#FFFFFF";
            }
            document.getElementById('g1-hex').value = color1.toUpperCase();
            document.getElementById('g1-picker').value = color1;
            document.getElementById('g2-hex').value = color2.toUpperCase();
            document.getElementById('g2-picker').value = color2;
            // æ–°å¢ï¼šåµæ¸¬ body æ˜¯å¦æœ‰ dark-mode classï¼Œæœ‰çš„è©±å°±æŠŠé–‹é—œæ‰“å‹¾
            const isDark = document.body.classList.contains('dark-mode');
            document.getElementById('grad-dark-toggle').checked = isDark;
            updateGradPreview();
        }

        function saveGrad() {
            const c1 = document.getElementById('g1-picker').value;
            const c2 = document.getElementById('g2-picker').value;
            const grad = `linear-gradient(135deg, ${c1}, ${c2})`;
            const isDark = document.getElementById('grad-dark-toggle').checked;
            // å¥—ç”¨ä¸»é¡Œï¼Œå¤šå‚³ä¸€å€‹ isDark åƒæ•¸
            applyTheme(grad, isDark);
            document.getElementById('grad-modal').classList.add('hidden');
            renderContent();
            showToast("æ¼¸å±¤å·²æ›´æ–°ï¼");
        }

        //æ‡‰ç”¨ä¸»é¡Œé¡è‰²
        function applyTheme(color, isDarkMode = null) {
            state.themeColor = color;
            const root = document.documentElement;
            const body = document.body;

            // --- æ·±è‰²æ¨¡å¼åˆ¤æ–·é‚è¼¯ ---
            let targetDark;
            
            if (isDarkMode !== null) {
                // å¦‚æœæœ‰å¾ saveGrad å‚³é€²ä¾† (true æˆ– false)ï¼Œå°±ç”¨å‚³é€²ä¾†çš„
                targetDark = isDarkMode;
            } else {
                // å¦‚æœæ˜¯é»æ“Šã€Œç²‰è—ã€æˆ–å…¶ä»–é è¨­é¡è‰²ï¼ˆåªå‚³ä¸€å€‹åƒæ•¸æ™‚ï¼‰ï¼Œå°±è®€å–åŸæœ¬å­˜çš„ç‹€æ…‹
                targetDark = localStorage.getItem('fe_v11_darkMode') === 'true';
            }

            localStorage.setItem('fe_v11_darkMode', targetDark);
            if (targetDark) {
                body.classList.add('dark-mode');
            } else {
                body.classList.remove('dark-mode');
            }

            if (color === 'svt') {
                root.style.setProperty('--brand-color', '#92A8D1');
                root.style.setProperty('--brand-gradient', 'linear-gradient(135deg, #F7CAC9 0%, #92A8D1 100%)');
            } else if (color.includes('gradient')) {
                root.style.setProperty('--brand-gradient', color);
                const match = color.match(/#[A-Fa-f0-9]{6}/);
                root.style.setProperty('--brand-color', match ? match[0] : '#92A8D1');
            } else {
                root.style.setProperty('--brand-color', color);
                root.style.setProperty('--brand-gradient', color);
            }
            localStorage.setItem('fe_v11_theme', color);
        }

        function compressImage(base64Str, maxWidth = 600) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;

                    // 1. å¼·åˆ¶èª¿æ•´å°ºå¯¸
                    if (w > maxWidth) {
                        h *= maxWidth / w;
                        w = maxWidth;
                    }
                    canvas.width = w;
                    canvas.height = h;

                    const ctx = canvas.getContext('2d');
                    // 2. ä½¿ç”¨æ›´å¹³æ»‘çš„ç¸®æ”¾ç¹ªè£½
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, w, h);

                    // 3. å„ªå…ˆä½¿ç”¨ webp æ ¼å¼ (é«”ç©æ¸›å°‘ç´„ 30%)ï¼Œå“è³ªè¨­ç‚º 0.4
                    // å¦‚æœç€è¦½å™¨ä¸æ”¯æ´ webpï¼Œå®ƒæœƒè‡ªå‹•é€€å›åˆ° image/jpeg
                    let outputFormat = "image/webp";
                    let quality = 0.4; 

                    const compressedBase64 = canvas.toDataURL(outputFormat, quality);
                    resolve(compressedBase64);
                };
            });
        }

        function getStatusClass(s) {
            if (s === 'æœªåˆ°è²¨') return 'status-unArrived';
            if (s === 'å¾…äºŒè£œ') return 'status-freight';
            if (s === 'å¾…å‡ºè²¨') return 'status-toShip';
            if (s === 'å·²å”®å‡º') return 'status-soldout';
            return 'status-received';
        }

        /**
         * 3. å°è¦½èˆ‡æ¸²æŸ“
         */
        function switchTab(tab) {
            state.activeTab = tab; state.subPage = null; state.searchKeyword = ''; state.selectedCategory = '';
            ['expense', 'report', 'wish', 'settings'].forEach(t => {
                const el = document.getElementById(`tab-${t}`);
                if (el) el.className = `flex-1 flex flex-col items-center gap-1 transition-colors ${tab === t ? 'tab-active' : 'text-gray-400'}`;
            });
            document.getElementById('fab').classList.toggle('hidden', tab === 'report' || tab === 'settings');
            document.getElementById('share').classList.toggle('hidden', tab === 'report' || tab === 'settings'|| tab === 'wish');
            // é‡å°å…¨åŸŸè¦–çª—èˆ‡ä¸»è¦çš„å…§å®¹å®¹å™¨é€²è¡Œæ²å‹•é‡è¨­
            window.scrollTo(0, 0); 
            const container = document.getElementById('main-content');
            if (container) {
                container.scrollTop = 0;
            }
            renderContent();
        }

        function renderContent() {
            const container = document.getElementById('main-content');
            if(!container) return;
            container.innerHTML = '';
            if (state.activeTab === 'expense') renderExpenseList(container);
            else if (state.activeTab === 'report') renderReport(container);
            else if (state.activeTab === 'wish') renderWishList(container);
            else if (state.activeTab === 'settings') {
                if (state.subPage === 'backup') renderBackupView(container);
                else if (state.subPage === 'appearance') renderAppearanceView(container);
                else if (state.subPage === 'photowall') renderPhotoWall(container);
                else if (state.subPage === 'version') renderVersionView(container);
                else if (state.subPage === 'accountConfig') renderAccountConfig(container);
                else renderSettings(container);
            }
        }

        function renderExpenseList(container) {
            container.innerHTML = `
                <div class="pt-6 px-6 sticky top-0 bg-brand/5 backdrop-blur-md z-30 border-b border-gray-100">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-black tracking-tight">æ¶ˆè²»æ¸…å–®</h2>
                        <div class="flex gap-2 text-gray-800">
                            <select onchange="updateFilter('year', this.value)" class="bg-white border rounded-lg px-2 py-1 text-xs outline-none shadow-sm">
                                <option value="0" ${state.filterYear === 0 ? 'selected' : ''}>ä¸é™</option>
                               ${[2020,2021,2022,2023,2024, 2025, 2026].map(y => `<option value="${y}" ${Number(y) === Number(state.filterYear) ? 'selected' : ''}>${y}å¹´</option>`).join('')}
                            </select>
                            <select onchange="updateFilter('month', this.value)" class="bg-white border rounded-lg px-2 py-1 text-xs outline-none shadow-sm">
                                <option value="0" ${state.filterMonth === 0 ? 'selected' : ''}>ä¸é™</option>
                                ${Array.from({length: 12}, (_, i) => i + 1).map(m => `<option value="${m}" ${Number(m) === Number(state.filterMonth) ? 'selected' : ''}>${m}æœˆ</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="relative mb-3">
                        <input type="text" placeholder="æœå°‹é …ç›®ã€åˆ°è²¨ç‹€æ…‹ã€å‚™è¨»..." oninput="state.searchKeyword=this.value;renderExpenseListItems(document.getElementById('expense-list-items'))" class="w-full bg-white border border-gray-100 rounded-2xl py-3 px-10 text-sm shadow-sm outline-none focus:ring-2 focus:ring-brand focus:ring-opacity-20 transition-all text-gray-800">
                        <svg class="text-brand w-4 h-4 absolute left-4 top-4 opacity-40" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="3"/></svg>
                    </div>
                    <div id="cat-bar" class="flex gap-2 overflow-x-auto no-scrollbar pb-2 mb-1"></div>
                    <div id="tag-bar" class="flex gap-2 overflow-x-auto no-scrollbar pb-2"></div>
                </div>
                <div id="expense-list-items" class="px-6 space-y-4 pb-12 pt-4"></div>
            `;
            renderTagAndCatBar();
            renderExpenseListItems(document.getElementById('expense-list-items'));
        }

        function quickFilter(type, value) {
            const input = document.querySelector('input[placeholder*="æœå°‹"]');
            
            if (type === 'category') {
                state.selectedCategory = value;
            } else {
                state.searchKeyword = value;
                if (input) input.value = value;
            }

            // åŸ·è¡Œæ¸²æŸ“ï¼šæ›´æ–°åˆ†é¡åˆ—èˆ‡æ¸…å–®å…§å®¹
            renderTagAndCatBar(); 
            renderExpenseListItems(document.getElementById('expense-list-items'));
        }
        function renderTagAndCatBar() {
            const catBar = document.getElementById('cat-bar'); 
            if (!catBar) return;
            const currentCats = getCurrentCategories();
            // --- ç¬¬ä¸€å±¤ï¼šåˆ†é¡ (Categories) æ¸²æŸ“ ---
            catBar.innerHTML = currentCats.map(cat => {
                const isActive = state.selectedCategory === cat.id;
                return `
                    <div onclick="state.selectedCategory=(state.selectedCategory==='${cat.id}'?'':'${cat.id}'); 
                                renderTagAndCatBar(); 
                                renderExpenseListItems(document.getElementById('expense-list-items'))" 
                        class="chip ${isActive ? 'active-cat text-white' : ''}" 
                        style="${isActive ? `background-color:${cat.color}` : `color:${cat.color}; background-color:${cat.color}10; border-color:${cat.color}30`}">
                        ${cat.icon} ${cat.id.split(' ')[0]}
                    </div>`;
            }).join('');

            // --- ç¬¬äºŒå±¤ï¼šé€£å‹•æ¨™ç±¤ (Filtered Tags) é‚è¼¯ ---
            const tagBar = document.getElementById('tag-bar');
            if (!tagBar) return;

            //åŒæ™‚éæ¿¾ å¹´ä»½ã€æœˆä»½ ä»¥åŠ åˆ†é¡
            const filteredExpensesForTags = state.expenses.filter(ex => {
                // 1. æª¢æŸ¥å¹´ä»½èˆ‡æœˆä»½æ˜¯å¦ç¬¦åˆç›®å‰çš„é¸æ“‡   
                const dateMatch = (state.filterYear === 0 || Number(ex.year) === Number(state.filterYear)) && (state.filterMonth === 0 || Number(ex.month) === Number(state.filterMonth));
               // 2. æª¢æŸ¥åˆ†é¡æ˜¯å¦ç¬¦åˆç›®å‰çš„é¸æ“‡
                const catMatch = (state.selectedCategory === '' || ex.category === state.selectedCategory);
                
                return dateMatch && catMatch;
         });

        // 2. æå–é€™äº›ç´€éŒ„ä¸­ä¸é‡è¤‡çš„æ¨™ç±¤
            const relevantTags = [...new Set(filteredExpensesForTags.flatMap(ex => ex.tags || []))].filter(t => t);

            // 3. æ¸²æŸ“æ¨™ç±¤åˆ—
            if (relevantTags.length === 0) {
                tagBar.innerHTML = `<span class="text-[10px] text-slate-300 py-2 ml-1">æ­¤åˆ†é¡æš«ç„¡æ¨™ç±¤</span>`;
            } else {
                tagBar.innerHTML = relevantTags.map(tag => {
                    const isActive = state.searchKeyword === tag;
                    return `
                        <div onclick="state.searchKeyword=(state.searchKeyword==='${tag}'?'':'${tag}'); 
                                    renderTagAndCatBar(); 
                                    renderExpenseListItems(document.getElementById('expense-list-items'))" 
                            class="chip ${isActive ? 'active-tag' : ''}">
                            #${tag}
                        </div>`;
                }).join('');
            }
        }

        function renderExpenseListItems(container) { //æ¶ˆè²»æ¸…å–®æ¸²æŸ“
            if(!container) return;
            const kw = state.searchKeyword.toLowerCase();
            const filtered = state.expenses.filter(ex => {
            // 1. åŸºæœ¬æ™‚é–“éæ¿¾
            const dateMatch = (state.filterYear === 0 || Number(ex.year) === Number(state.filterYear)) && (state.filterMonth === 0 || Number(ex.month) === Number(state.filterMonth));
            // 2. åˆ†é¡éæ¿¾
            const catMatch = (state.selectedCategory === '' || ex.category === state.selectedCategory);
            
            // 3. é€²éšé—œéµå­—éæ¿¾ (åŒ…å«ï¼šåç¨±ã€æ¨™ç±¤ã€å‚™è¨»ã€åˆ°è²¨ç‹€æ…‹ã€æ”¶ç‰©å¹³å°)
            const keywordMatch = (
                ex.name.toLowerCase().includes(kw) || 
                (ex.tags && ex.tags.some(t => t.toLowerCase().includes(kw))) || 
                (ex.remark && ex.remark.toLowerCase().includes(kw)) ||
                (ex.arrivalStatus && ex.arrivalStatus.toLowerCase().includes(kw)) || // æ–°å¢ï¼šæœå°‹åˆ°è²¨ç‹€æ…‹
                (ex.platform && ex.platform.toLowerCase().includes(kw))             // æ–°å¢ï¼šæœå°‹æ”¶ç‰©å¹³å°
            );

            return dateMatch && catMatch && keywordMatch;
            });
            //const total = filtered.reduce((sum, item) => sum + (Number(item.total) || 0), 0);
            //const total = filtered.filter(i => i.type !== 'income').reduce((sum, i) => sum + i.total, 0);
            const totalExp = filtered.filter(i => i.type !== 'income').reduce((sum, i) => sum + i.total, 0);
            const totalInc = filtered.filter(i => i.type === 'income').reduce((sum, i) => sum + i.total, 0);
            const netTotal = totalExp - totalInc;
            const totalDisplay = state.hideAmount ? 'â€¢â€¢â€¢â€¢â€¢' : `$ ${netTotal.toLocaleString()}`;
            const totalExpDisplay= state.hideAmount ? 'â€¢â€¢â€¢' : `$ ${totalExp.toLocaleString()}`;
            const summaryLabel = state.filterYear === 0 ? 'Total Cost' : (state.filterMonth === 0 ? 'æœ¬å¹´æ·¨æ”¯å‡º' : 'æœ¬æœˆæ·¨æ”¯å‡º');


            if (filtered.length === 0) { container.innerHTML = `<div class="text-center py-24 text-slate-300 font-bold">é€™å€‹æœˆä»½ç›®å‰æ²’æœ‰ç´€éŒ„å”·</div>`; return; }
            
            container.innerHTML = `<div class="bg-brand rounded-3xl p-6 text-white card-shadow flex justify-between items-end mb-6">
                <div>
                    <div class="flex items-center mb-1"><p class="text-white/70 text-[10px] font-bold uppercase tracking-wider ">${summaryLabel}</p>                     
                        <button onclick="toggleAmountVisibility()" class="text-white/60 hover:text-white transition-colors p-1">
                                ${state.hideAmount ? 
                                    `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>` : 
                                    `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5 " stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`
                                }
                        </button></div>
                    <h3 class="text-3xl font-black">${totalDisplay}</h3>
                    </div>
                    <div class="text-right flex-row">
                        ${totalInc > 0 ? `<p class="text-[10px] font-bold bg-white/20 px-2 py-1 rounded-lg mb-1">æ”¯å‡º: ${totalExpDisplay}</p>` : ''}
                        ${totalInc > 0 ? `<p class="text-[10px] font-bold bg-emerald-400/40 px-2 py-1 rounded-lg">å”®å‡º: +$${totalInc.toLocaleString()}</p>` : ''}
                        <p class="text-xs text-white/80 font-medium">å…± ${filtered.length} é …ç´€éŒ„</p>
                    </div>
                </div>` + 
                filtered.sort((a, b) => 
                    Number(b.year) - Number(a.year) ||
                    Number(b.month) - Number(a.month) ||
                    Number(b.day  || 1) - Number(a.day  || 1) || //æ²’æœ‰æ—¥æœŸå°±é è¨­1è™Ÿ
                    Number(b.id) - Number(a.id) //å…ˆæ¯”å¹´æœˆæ—¥åœ¨æ¯”idé †åº
                ).map(item => {
                const allCats = [...categories, ...categoriesACGN];
                const catInfo = allCats.find(c => c.id === item.category) || { icon: 'ğŸŒˆ' };
                const isIncome = item.type === 'income';
                const cardBg = isIncome ? 'bg-[var(--income-bg-soft)]' : 'bg-white border-transparent';
                const payInfo = item.paymentMethod === 'å·²ä»˜è¨‚é‡‘' ? `å·²ä»˜è¨‚é‡‘ $${item.paidAmount || 0}` : (item.paymentMethod || 'å¾…ä»˜æ¬¾');
                return `<div class="${cardBg} rounded-3xl p-4 card-shadow relative overflow-hidden group">
                    <div class="absolute top-4 right-4 z-10">
                        <button onclick="openActionModal(event, 'expense', '${item.id}')" class="p-2 text-slate-300 hover:text-slate-600 active:scale-90 transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                        </button>
                    </div>
                    <div class="flex gap-4" >
                        ${item.image ? `<img src="${item.image}" loading="lazy" class="w-20 h-20 object-cover rounded-2xl" onclick="${item.image ? `openLightbox('${item.image}', '${item.name}', '${item.year}/${item.month}')` : ''}">` : 
                        `<div class="w-20 h-20  ${isIncome ? 'bg-emerald-100' : 'bg-slate-50'} rounded-2xl flex items-center justify-center text-3xl shadow-inner">${catInfo.icon}</div>`}
                        <div class="flex-grow">
                            <div class="flex gap-2 mb-1">
                                <span onclick="quickFilter('category', '${item.category}')" class="cursor-pointer text-[9px] font-bold px-2 py-0.5 rounded-lg"  style="background-color: ${catInfo.color}1A; color: ${catInfo.color};">${catInfo.icon} ${item.category}</span>
                                <span onclick="quickFilter('status', '${item.arrivalStatus}')" class="cursor-pointer text-[9px] font-bold px-2 py-0.5 rounded-lg ${getStatusClass(item.arrivalStatus)}">${item.arrivalStatus}</span>
                                 ${state.filterMonth === 0 ? `<span class="text-[9px] font-bold px-2 py-0.5 rounded-lg bg-slate-50 text-slate-400">${item.month}æœˆ</span>` : ''}
                            </div>
                            <h4 class="font-bold text-slate-800 text-sm leading-tight">${item.name}</h4>
                            ${item.remark ? `<div class="text-[10px] text-slate-400 mt-1"><span class="text-brand font-bold mr-1 opacity-70">å‚™è¨»:</span>${item.remark}</div>` : ''}

                            <div class="flex justify-between items-end mt-2">
                                <div class="flex flex-wrap gap-1 pr-2">${(item.tags || []).map(t => `<span class="bg-slate-50 text-slate-400 text-[9px] px-2 py-0.5 rounded-md">#${t}</span>`).join('')}</div>
                                <div class="text-right flex-shrink-0 text-brand"><p class="text-[9px] text-slate-300 font-normal">$${item.price} Ã— ${item.qty} ${item.shipping > 0 ? `+ é‹$${item.shipping}` : ''}</p><p class="font-black text-lg leading-none">${state.hideAmount ? 'â€¢â€¢â€¢' : `$${(Number(item.total)).toLocaleString()}`}</p></div>
                            </div>
                        </div>
                    </div>
                    ${!isIncome ? ` 
                    <div class="mt-4 pt-3 border-t border-slate-100">
                            <div class="flex justify-between items-center">
                                <div class="text-[10px] text-slate-400">
                                    <span class="font-bold text-brand">ä»˜æ¬¾:</span> ${item.paymentMethod} ${item.paymentMethod === 'å·²ä»˜è¨‚é‡‘' ? `(å·²ä»˜:$${item.paidAmount})` : ''}</div>
                                    ${item.shipping > 0 ? `<div class="text-[10px] text-slate-400 font-bold"><span class="opacity-70">é‹è²»:</span> $${item.shipping}</div>
                                ` : ''}
                                </div>
                            ${item.platform ? `<div class="bg-slate-50 p-2 rounded-xl mt-2 border border-slate-100 text-[10px] text-slate-500 leading-relaxed">ğŸ“ ${item.platform}</div>` : ''}
                    </div>` : ''}
                </div>`;
            }).join('');
        }
        // é€šç”¨ç¢ºèªå·¥å…·ï¼Œæœƒå›å‚³ true æˆ– false

        function askUser(title, desc, icon = 'ğŸ’¸') {
            const overlay = document.getElementById('common-confirm-overlay');
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-desc').textContent = desc;
            document.getElementById('confirm-icon').textContent = icon;
            
            // æ ¹æ“šåœ–ç¤ºè‡ªå‹•èª¿æ•´èƒŒæ™¯è‰²ï¼ˆå¦‚æœæ˜¯åƒåœ¾æ¡¶å°±è®Šç´…è‰²ç³»ï¼Œå¦å‰‡ç”¨å“ç‰Œè‰²ï¼‰
            const iconBg = document.getElementById('confirm-icon');
            if (icon === 'ğŸ—‘ï¸') {
                iconBg.className = "w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl";
            } else {
                iconBg.className = "w-16 h-16 bg-brand/10 text-brand rounded-full flex items-center justify-center mx-auto mb-4 text-2xl";
            }

            overlay.classList.remove('hidden');

            return new Promise((resolve) => {
                document.getElementById('confirm-btn-ok').onclick = () => { overlay.classList.add('hidden'); resolve(true); };
                document.getElementById('confirm-btn-cancel').onclick = () => { overlay.classList.add('hidden'); resolve(false); };
            });
        }

        // é¡¯ç¤º/éš±è—é‡‘é¡å‡½æ•¸
        async function toggleAmountVisibility() {
            // é—œéµé‚è¼¯ï¼šå¦‚æœæ˜¯ true (è¦é¡¯ç¤º)ï¼Œå°±ç­‰å¾…å½ˆçª—å›å‚³ã€‚å¦‚æœä½¿ç”¨è€…æŒ‰å–æ¶ˆ (!true)ï¼Œå°±ä¸­æ–·
            if (state.hideAmount && !(await askUser("ç¢ºå®šè¦é¡¯ç¤ºé‡‘é¡å—ï¼Ÿ", "é¡¯ç¤ºå¾Œå°‡å¯æŸ¥çœ‹å®Œæ•´çš„æ¶ˆè²»æ˜ç´°èˆ‡ç¸½è¨ˆã€‚"))) {
                return;
            }
            state.hideAmount = !state.hideAmount;
            localStorage.setItem('fe_v11_hideAmount', JSON.stringify(state.hideAmount));
            renderContent();
        }

        function renderWishList(container) {
            // 1. æ ¹æ“šç›®å‰é¸ä¸­çš„åˆ†é¡éæ¿¾æ¸…å–®
            const filtered = state.selectedCategory === '' 
                ? state.wishlist 
                : state.wishlist.filter(item => item.category === state.selectedCategory);

            container.innerHTML = `
                <div class="pt-6 px-6 sticky top-0 bg-brand/5 backdrop-blur-md z-30 border-b border-gray-100">
                    <h2 class="text-2xl font-black mb-4 tracking-tight text-slate-800">é¡˜æœ›æ¸…å–®</h2>
                    <div id="wish-cat-bar" class="flex gap-2 overflow-x-auto no-scrollbar pb-3 mb-1"></div>
                </div>

                <div class="p-6 space-y-4 pb-12">
                    ${filtered.length === 0 
                        ? `<div class="text-center py-24 text-slate-300 font-bold">
                            ${state.selectedCategory ? 'æ­¤åˆ†é¡æš«ç„¡é¡˜æœ›' : 'å¿«è¨±ä¸‹æ–°çš„é¡˜æœ›å§ï¼'}
                        </div>` 
                        : filtered.map(item => `
                        <div class="bg-white rounded-3xl p-4 flex flex-col gap-3 card-shadow relative overflow-hidden">
                            <div class="absolute top-4 right-4 z-10">
                                <button onclick="openActionModal(event,'wish', '${item.id}')" class="p-2 text-slate-300 hover:text-slate-600 active:scale-90 transition-all">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                                </button>
                            </div>
                            <div class="flex items-center gap-4" onclick="${item.image ? `openLightbox('${item.image}', '${item.name}', '${item.releaseDate || 'æœªå®š'}')` : ''}">
                                ${item.image ? `<img src="${item.image}" loading="lazy" class="w-16 h-16 object-cover rounded-2xl shadow-sm">` : `<div class="w-16 h-16 bg-slate-50 rounded-2xl flex items-center justify-center text-2xl shadow-inner">âœ¨</div>`}
                                <div class="flex-grow pr-24">
                                    <span class="text-[9px] font-bold px-2 py-0.5 rounded-lg bg-slate-50 text-brand mb-1 inline-block">${item.category || 'ä¸€èˆ¬'}</span>
                                    <h4 class="font-bold text-sm leading-tight text-slate-800">${item.name}</h4>
                                    <p class="text-xs font-black text-brand mt-1">$ ${Number(item.price).toLocaleString()}</p>
                                    <p class="text-[10px] text-slate-400 mt-1 font-bold">ğŸ—“ï¸ ${item.releaseDate || 'æœªå®š'} ${item.releaseTime || ''}</p>
                                </div>
                            </div>
                            ${item.remark ? `
                                <div class="mt-2 pt-2 border-t border-slate-100 flex flex-col gap-1">
                                    <div class="bg-slate-50 p-2 rounded-xl mt-1 border border-slate-100 text-[10px] text-slate-500 leading-relaxed">
                                        <span class="text-brand font-bold mr-1 opacity-70">å‚™è¨»:</span>${item.remark}
                                    </div>
                                </div>` : ''}
                        </div>`).join('')}
                </div>`;

            // æ¸²æŸ“å®Œ HTML å¾Œï¼Œå¡«å……åˆ†é¡åˆ—
            renderWishCatBar();
        }
        function renderWishCatBar() { // æ¸²æŸ“åˆ†é¡æŒ‰éˆ•
            const bar = document.getElementById('wish-cat-bar');
            const currentCats = getCurrentWishCategories();
            if (!bar) return;
            
            bar.innerHTML = currentCats.map(cat => {
                const isActive = state.selectedCategory === cat;
                return `
                    <div onclick="state.selectedCategory=(state.selectedCategory==='${cat}'?'':'${cat}'); renderContent();"
                        class="chip ${isActive ? 'active-tag' : ''}">
                        ${cat}
                    </div>
                    `;
            }).join('');
        }

        // --- è²¡å‹™å ±è¡¨ ---
        function changeReportType(type) {
            state.reportType = type;
            renderContent(); // é‡æ–°æ¸²æŸ“å ±è¡¨
        }
        function renderReport(container) {
            const rangeData = calculateReportRange();
            const currentCats = getCurrentCategories();
            const currentCatIds = currentCats.map(c => c.id);
            // 1. éæ¿¾å‡ºè©²æ™‚æ®µçš„æ‰€æœ‰ç´€éŒ„
            const periodRecords = state.expenses.filter(ex => {
                const d = new Date(ex.year, ex.month - 1);
                const dateMatch = d >= rangeData.start && d <= rangeData.end;
                const categoryMatch = currentCatIds.includes(ex.category);
                return dateMatch && categoryMatch;
            });

            // 2. åŸºæœ¬é‡‘é¡è¨ˆç®—
            const totalExp = periodRecords.filter(i => i.type !== 'income').reduce((sum, i) => sum + (Number(i.total) || 0), 0);
            const totalInc = periodRecords.filter(i => i.type === 'income').reduce((sum, i) => sum + (Number(i.total) || 0), 0);
            const netBalance = totalExp - totalInc;

            // 3. åˆ¤æ–·ç›®å‰çš„å ±è¡¨æ¨¡å¼ (expense / income / net)
            const reportMode = (totalInc > 0) ? (state.reportType || 'expense') : 'expense';
            let stats = [];
            let chartTitle = "";
            let centerAmount = 0;

            if (reportMode === 'net') {
                // --- æ·¨æ”¯å‡ºæ¨¡å¼ï¼šé¡¯ç¤º æ”¯å‡º vs æ”¶å…¥ çš„å°æ¯” ---
                chartTitle = "æ·¨æ”¯å‡º";
                centerAmount = netBalance;
                stats = [
                    { id: 'ç¸½æ”¯å‡º', amount: totalExp, color: '#92A8D1', icon: 'ğŸ’¸' },
                    { id: 'ç¸½æ”¶å…¥', amount: totalInc, color: '#10b981', icon: 'ğŸ’°' }
                ].filter(s => s.amount > 0);
            } else {
                // --- æ”¯å‡ºæˆ–æ”¶å…¥æ¨¡å¼ï¼šé¡¯ç¤ºè©³ç´°åˆ†é¡ ---
                const isInc = reportMode === 'income';
                const targetRecords = periodRecords.filter(i => (isInc ? i.type === 'income' : i.type !== 'income'));
                chartTitle = isInc ? "ç¸½æ”¶å…¥" : "ç¸½æ”¯å‡º";
                centerAmount = isInc ? totalInc : totalExp;
                const currentCats = getCurrentCategories();
                stats = currentCats.map(cat => ({
                    ...cat,
                    amount: targetRecords
                        .filter(ex => ex.category === cat.id)
                        .reduce((sum, item) => sum + (Number(item.total) || 0), 0)
                })).filter(s => s.amount > 0).sort((a, b) => b.amount - a.amount);
            }

            const formatAmt = (num) => state.hideAmount ? 'â€¢â€¢â€¢' : num.toLocaleString();
            
            container.innerHTML = `
                <div class="p-6">
                    <h2 class="text-2xl font-black text-slate-800 mb-6 tracking-tight">è²¡å‹™åˆ†æå ±å‘Š</h2>
                    
                    <div class="flex flex-col gap-4 mb-8">
                        <div class="flex bg-slate-200/50 p-1 rounded-2xl">
                            ${['month', '6months', 'year'].map(r => `
                                <button onclick="changeReportRange('${r}')" class="report-range-btn flex-1 py-2 text-xs font-bold rounded-xl transition-all ${state.reportRange === r ? 'active' : ''}">
                                    ${r === 'month' ? 'æœˆ' : r === 'year' ? 'å¹´' : 'è¿‘ 6 å€‹æœˆ'}
                                </button>
                            `).join('')}
                        </div>
                        <div class="flex justify-between items-center bg-white p-4 rounded-2xl card-shadow">
                            <button onclick="shiftRange(-1)" class="p-2 text-slate-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2"/></svg></button>
                            <span class="text-sm font-black text-slate-700">${rangeData.label}</span>
                            <button onclick="shiftRange(1)" class="p-2 text-slate-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="2"/></svg></button>
                        </div>
                    </div>
                    ${totalInc > 0 ? `
                        <div class="grid grid-cols-3 gap-3 mb-8">
                            <div onclick="changeReportType('expense')" 
                                class="cursor-pointer transition-all ${reportMode === 'expense' ? 'bg-brand shadow-lg' : 'bg-white/60'} p-3 rounded-2xl card-shadow text-center">
                                <p class="text-[9px] font-bold ${reportMode === 'expense' ? 'text-white' : 'text-slate-400'} uppercase mb-1">ç¸½æ”¯å‡º</p>
                                <p class="text-sm font-black ${reportMode === 'expense' ? 'text-white' : 'text-slate-700'}">$${formatAmt(totalExp)}</p>
                            </div>
                            <div onclick="changeReportType('income')" 
                                class="cursor-pointer transition-all ${reportMode === 'income' ? 'bg-brand shadow-lg' : 'bg-white/60'} p-3 rounded-2xl card-shadow text-center">
                                <p class="text-[9px] font-bold ${reportMode === 'income' ? 'text-white' : 'text-emerald-400'} uppercase mb-1">ç¸½æ”¶å…¥</p>
                                <p class="text-sm font-black ${reportMode === 'income' ? 'text-white' : 'text-emerald-400'}">+$${formatAmt(totalInc)}</p>
                            </div>
                            <div onclick="changeReportType('net')" 
                                class="cursor-pointer transition-all ${reportMode === 'net' ? 'bg-brand shadow-lg' : 'bg-white/60'} p-3 rounded-2xl card-shadow text-center">
                                <p class="text-[9px] font-bold ${reportMode === 'net' ? 'text-white' : 'text-slate-400'} uppercase mb-1">æ·¨æ”¯å‡º</p>
                                <p class="text-sm font-black ${reportMode === 'net' ? 'text-white' : 'text-slate-700'}">$${formatAmt(netBalance)}</p>
                            </div>
                        </div>
                    ` : ``
                    }

                    ${stats.length > 0 ? `
                        <div class="bg-white rounded-3xl p-6 card-shadow mb-8 relative">
                            <div class="w-full max-w-[240px] mx-auto relative">
                                <canvas id="donutChart"></canvas>
                                <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none mt-2">
                                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">${chartTitle}</span>
                                    <span class="text-xl font-black text-slate-800">$${formatAmt(centerAmount)}</span>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <h3 class="text-xs font-black text-slate-400 uppercase mb-4 tracking-widest">
                                ${reportMode === 'net' ? 'æ”¶æ”¯å¹³è¡¡åˆ†æ' : (reportMode === 'income' ? 'æ”¶å…¥ä¾†æºæ’å' : 'æ”¯å‡ºä½”æ¯”æ’å')}
                            </h3>
                            ${stats.map(s => { 
                                const p = ((s.amount / (reportMode === 'net' ? (totalExp + totalInc) : centerAmount)) * 100).toFixed(1); 
                                return `
                                    <div class="bg-white rounded-2xl p-4 card-shadow flex items-center gap-4 border-l-4" style="border-color:${s.color}">
                                        <div class="w-10 h-10 rounded-xl flex items-center justify-center text-lg" style="background-color:${s.color}20">${s.icon}</div>
                                        <div class="flex-grow">
                                            <div class="flex justify-between items-center mb-1">
                                                <span class="text-sm font-bold text-slate-700">${s.id}</span>
                                                <span class="text-xs font-black text-slate-400">${p} %</span>
                                            </div>
                                            <div class="w-full bg-slate-50 h-1.5 rounded-full overflow-hidden">
                                                <div class="h-full rounded-full transition-all duration-1000" style="width:${p}%; background-color:${s.color}"></div>
                                            </div>
                                        </div>
                                        <div class="text-right flex-shrink-0 font-black text-slate-800">$${formatAmt(s.amount)}</div>
                                    </div>`; 
                            }).join('')}
                        </div>
                    ` : `
                        <div class="py-24 text-center bg-white rounded-3xl border-2 border-dashed border-slate-200 font-bold text-slate-300">
                            ç›®å‰æ™‚æ®µå°šç„¡æ•¸æ“šå¯åˆ†æ
                        </div>
                    `}
                </div>`;

            if (stats.length > 0) initChart(stats);
        }
        /*** å ±è¡¨ç¯„åœåˆ‡æ› (æœˆ/åŠå¹´/å¹´)*/
        function changeReportRange(range) {
            state.reportRange = range;
            state.reportOffset = 0; // åˆ‡æ›æ™‚é‡è¨­åç§»é‡
            renderContent();
        }

        //å ±è¡¨æ™‚é–“è»¸å‰å¾Œç§»å‹•
        function shiftRange(delta) {
            state.reportOffset += delta;
            renderContent();
        }
        //è¨­å®š
        function renderSettings(container) {
            const user = state.user;
            container.innerHTML = `
            <div class="p-6 h-screen"><h2 class="text-2xl font-black mb-8 tracking-tight">è¨­å®š</h2>
                <div class="bg-white rounded-3xl p-5 card-shadow mb-8 flex items-center gap-4 ">
                    <div class="w-12 h-12 rounded-full overflow-hidden bg-slate-50 border-2 border-brand/20 flex items-center justify-center">
                        ${state.user 
                        ? `<img src="${state.user.photoURL}" class="w-full h-full object-cover" alt="ä½¿ç”¨è€…é ­åƒ">` 
                        : `<span class="text-xl">ğŸ‘¤</span>`}
                    </div>
                    
                    <div class="flex-grow">
                        <h4 class="font-bold text-slate-800 text-sm">
                        ${state.user ? (state.user.displayName || 'Google ç”¨æˆ¶') : 'è¨ªå®¢æ¨¡å¼'}
                        </h4>
                        <p class="text-[10px] text-slate-400">
                        ${state.user ? 'é›²ç«¯è³‡æ–™å·²åŒæ­¥ â˜ï¸' : 'ç™»å…¥å¾Œé–‹å•Ÿé›²ç«¯å‚™ä»½'}
                        </p>
                    </div>
                    
                    <div>
                        ${state.user 
                        ? `<button onclick="window.cloud.logout()" class="text-[10px] font-bold text-slate-400 bg-slate-50 px-3 py-2 rounded-xl active:scale-95 transition-all">ç™»å‡º</button>` 
                        : `<button onclick="window.cloud.login()" class="text-xs bg-brand text-white font-bold px-4 py-2 rounded-xl shadow-md active:scale-95 transition-transform">ç™»å…¥</button>`}
                    </div>
                    </div>
                <div class="bg-white rounded-3xl overflow-hidden card-shadow">
                    <div onclick="state.subPage = 'photowall'; renderContent();" class="flex items-center justify-between p-5 custom-hover cursor-pointer border-b border-slate-50"><div class="flex items-center gap-4 text-brand"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h14a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-width="2"/></svg><span class="font-bold text-slate-700">æˆ‘çš„ç…§ç‰‡ç‰†</span></div><span>â–¶</span></div>
                    <div onclick="state.subPage = 'appearance'; renderContent();" class="flex items-center justify-between p-5 custom-hover cursor-pointer border-b border-slate-50"><div class="flex items-center gap-4 text-brand"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" stroke-width="2"/></svg><span class="font-bold text-slate-700">å¤–è§€è¨­å®š</span></div><span>â–¶</span></div>
                    <div onclick="state.subPage = 'backup'; renderContent();" class="flex items-center justify-between p-5 custom-hover cursor-pointer border-b border-slate-50"><div class="flex items-center gap-4 text-brand"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" stroke-width="2"/></svg><span class="font-bold text-slate-700">æ•¸æ“šåŒ¯å…¥èˆ‡åŒ¯å‡º</span></div><span>â–¶</span></div>
                    <div onclick="runStorageCleanup()" class="flex items-center justify-between p-5 custom-hover cursor-pointer border-b border-slate-50">
                        <div class="flex items-center gap-4 text-brand">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2"/>
                            </svg>
                            <span class="font-bold text-slate-700">æ¸…ç†å†—é¤˜åœ–æª”</span>
                        </div><span>â–¶</span>
                    </div>  
                    <div onclick="state.subPage = 'accountConfig'; renderContent();" class="flex items-center justify-between p-5 custom-hover cursor-pointer border-b border-slate-50">
                        <div class="flex items-center gap-4 text-brand">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            <span class="font-bold text-slate-700">å¸³æœ¬èˆ‡åŠŸèƒ½è¨­å®š</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-slate-300 font-bold">${state.categorySet === 'categories' ? 'KPOP' : 'ACGN'}${state.enableExchange ? ' / åŒ¯ç‡é–‹' : ''}</span>
                            <span>â–¶</span>
                        </div>
                    </div>              
                    <div onclick="state.subPage = 'version'; renderContent();" class="flex items-center justify-between p-5 custom-hover cursor-pointer border-b border-slate-50">
                        <div class="flex items-center gap-4 text-brand">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><span class="font-bold text-slate-700">ç‰ˆæœ¬èªªæ˜</span></div>
                        <div class="flex items-center gap-2"><span class="text-[10px] text-slate-300 font-mono text-right">v8.0</span><span>â–¶</span></div>
                    </div>

                </div>
                        

            </div>
                `;
        }
        //ç…§ç‰‡ç‰†
        function renderPhotoWall(container) {
            const isWishWall = state.photoWallTab === 'wish';
            // æ ¹æ“šæ¨™ç±¤æ±ºå®šè³‡æ–™ä¾†æºèˆ‡åˆ†é¡æ¸…å–®
            const dataSource = isWishWall ? state.wishlist : state.expenses;
            const BuyCats = getCurrentCategories();
            const WishCats = getCurrentWishCategories();
            const currentCats = isWishWall ? WishCats : BuyCats.map(c => c.id);

            // å–å¾—æœ‰ç…§ç‰‡çš„è³‡æ–™ä¸¦éæ¿¾åˆ†é¡
            let photos = dataSource.filter(i => i.image && i.type !== 'income');
            if (state.photoFilterCat && state.photoFilterCat !== '') {
                photos = photos.filter(p => p.category === state.photoFilterCat);
            }
            photos.sort((a, b) => 
                Number(b.year) - Number(a.year) ||
                Number(b.month) - Number(a.month) ||
                Number(b.day || 1) - Number(a.day || 1) ||
                Number(b.id) - Number(a.id)
            );

            container.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center gap-3 mb-6">
                        <div class="flex items-center gap-3 mb-6">
                            <button onclick="state.subPage=null;state.photoFilterCat='';renderContent()" class="p-2 -ml-2 text-slate-400 active:scale-90 font-bold">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2"/></svg>
                            </button>
                            <h2 class="text-2xl font-black tracking-tight text-slate-800">ç…§ç‰‡ç‰†</h2>
                        </div>
                    </div>

                    <div class="flex border-b border-gray-100 mb-6">
                        <button onclick="state.photoWallTab='purchased';state.photoFilterCat='';renderContent()" 
                            class="photo-tab flex-1 py-3 text-sm font-bold ${state.photoWallTab==='purchased'?'active':'text-gray-400'}">å·²è³¼è²·</button>
                        <button onclick="state.photoWallTab='wish';state.photoFilterCat='';renderContent()" 
                            class="photo-tab flex-1 py-3 text-sm font-bold ${state.photoWallTab==='wish'?'active':'text-gray-400'}">å¿ƒé¡˜ç‰†</button>
                    </div>

                    <div class="flex gap-2 overflow-x-auto no-scrollbar pb-4 mb-2">
                        <div onclick="state.photoFilterCat='';renderContent()" 
                            class="chip ${state.photoFilterCat === '' ? 'active-tag' : ''}">å…¨éƒ¨</div>
                        ${currentCats.map(c => `
                            <div onclick="state.photoFilterCat='${c}';renderContent()" 
                                class="chip ${state.photoFilterCat === c ? 'active-tag' : ''}">${c.split(' ')[0]}</div>
                        `).join('')}
                    </div>

                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 pb-20">
                        ${photos.length > 0 ? photos.map(item => `
                            <div onclick="openLightbox('${item.image}', '${item.name}', '${isWishWall ? (item.category || 'ä¸€èˆ¬') : (item.year + '/' + item.month)}')" 
                                class="relative aspect-square bg-gray-200 rounded-2xl overflow-hidden shadow-sm active:scale-95 transition-all">
                                <img src="${item.image}" loading="lazy" class="w-full h-full object-cover">
                            </div>
                        `).join('') : `
                            <div class="col-span-full py-24 text-center text-slate-300 font-bold">ç›®å‰å°šç„¡ç…§ç‰‡</div>
                        `}
                    </div>
                </div>`;
             // ä¿®æ­£ï¼šæ¸²æŸ“å®Œå¾Œï¼Œè‡ªå‹•å°‡å•Ÿå‹•ä¸­çš„ Chip æ²å‹•åˆ°å¯è¦–ç¯„åœ
            requestAnimationFrame(() => {
                const activeChip = container.querySelector('.active-tag');
                if (activeChip) {
                    activeChip.scrollIntoView({
                        behavior: 'auto', // ç›´æ¥åˆ‡æ›
                        inline: 'center',   // å°‡è©²å…ƒç´ ç½®ä¸­é¡¯ç¤º
                        block: 'nearest'    // å‚ç›´æ–¹å‘ä¸è®Š
                    });
                }
            });
        }

        // --- å¤–è§€è¨­å®š ---
        function renderAppearanceView(container) {
            const presets = [
                {name:'ç²‰è—', c:'svt', g: 'linear-gradient(135deg, #F7CAC9 0%, #92A8D1 100%)'},
                {name:'å¹»ç´«', c:'#BB96FF'},
                {name:'æ²è—', c:'#69C4E0'},
                {name:'è¢ç¶ ', c:'#B6ED00'},
                {name:'æ¥µå…‰', c:'#6C3591'},
                {name:'ç† é‡‘', c:'#E2B216'}
            ];
            const currentHex = (state.themeColor && state.themeColor.startsWith('#')) ? state.themeColor : '';
            const isCustomGrad = state.themeColor.includes('gradient') && state.themeColor !== 'svt';
            const btnGrad = isCustomGrad ? state.themeColor : 'linear-gradient(135deg, #FEBEBE 0%,#85D0FF 100%)';
            container.innerHTML = `
                    <div class="p-6">
                        <div class="flex items-center gap-3 mb-8">
                            <button onclick="state.subPage=null;renderContent()" class="p-2 -ml-2 text-slate-400">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2"/></svg>
                            </button>
                            <h2 class="text-2xl font-black tracking-tight text-slate-800">å¤–è§€è¨­å®š</h2>
                        </div>
                        
                        <div class="bg-white rounded-3xl p-6 card-shadow text-slate-800">
                            <div class="flex mb-6 justify-between">
                                <h3 class="text-sm font-bold text-slate-500 tracking-wide">é¸æ“‡é è¨­ä¸»é¡Œ</h3>
                                <div class="flex justify-center border-slate-50">
                                    <label class="inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="grad-dark-toggle" class="sr-only peer" onchange="toggleDarkMode(this.checked)" ${document.body.classList.contains('dark-mode') ? 'checked' : ''}>
                                        <div class="relative w-10 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer 
                                                    peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full 
                                                    after:content-[''] after:absolute after:top-[2px] after:start-[2px] 
                                                    after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all 
                                                    peer-checked:bg-slate-700"></div>
                                        
                                        <span class="select-none text-sm font-bold text-slate-500">æ·±è‰²æ¨¡å¼</span>
                                    </label>
                                </div>
                            </div>
                            <div class="grid grid-cols-4 gap-y-8 gap-x-4 place-items-center mb-10">
                                ${presets.map(p => `
                                    <div class="flex flex-col items-center gap-2">
                                        <div onclick="applyTheme('${p.c}');renderContent()" 
                                            class="color-preset ${state.themeColor===p.c?'active':''}" 
                                            style="background:${p.g || p.c}"></div>
                                        <span class="text-[10px] font-bold text-slate-400">${p.name}</span>
                                    </div>
                                `).join('')}
                                <div class="flex flex-col items-center gap-2">
                                    <input type="color" onchange="applyTheme(this.value);renderContent()" 
                                        value="${state.themeColor==='svt'?'#92A8D1':state.themeColor==='bp'?'#FF85D0':state.themeColor}" 
                                        class="w-10 h-10 rounded-full border-none cursor-pointer bg-slate-200 shadow-sm">
                                    <span class="text-[10px] font-bold text-slate-400">æ»´ç®¡é¸è‰²</span>
                                </div>
                                <div class="flex flex-col items-center gap-2">
                                    <div onclick="openGradModal()" 
                                        class="color-preset flex items-center justify-center text-white text-[10px] font-bold ${state.themeColor.includes('gradient') && state.themeColor!=='svt'?'active':''}" 
                                        style="background:white">ğŸ¨</div>
                                    <span class="text-[10px] font-bold text-slate-400">è‡ªè¨‚æ¼¸å±¤</span>
                                </div>
                            </div>

                            <div class="mt-8 pt-6 border-t border-slate-50">
                                <h3 class="text-xs font-black text-slate-400 mb-4 uppercase tracking-widest">è¼¸å…¥è‡ªè¨‚è‰²ç¢¼</h3>
                                <div class="flex gap-2">
                                    <input type="text" id="custom-hex-input" placeholder="#RRGGBB" 
                                        value="${currentHex}"
                                        class="flex-grow bg-slate-50 border-2 border-transparent focus:border-brand rounded-2xl px-4 py-3 text-sm outline-none font-mono text-slate-700">
                                    <button onclick="applyHexColor()" 
                                            class="bg-brand text-white font-bold px-6 py-3 rounded-2xl shadow-lg active:scale-95 transition-all">
                                        å¥—ç”¨
                                    </button>
                                </div>
                                <p class="text-[10px] text-slate-300 mt-2 ml-1">è«‹è¼¸å…¥åŒ…å« # çš„å…­ä½æ•¸è‰²ç¢¼ï¼Œä¾‹å¦‚ #92A8D1</p>
                            </div>
                        </div>
                    </div>`;
            }
        function toggleDarkMode(isDark) {
            // å¥—ç”¨ç›®å‰çš„é¡è‰²ï¼Œä½†å‚³å…¥æ–°çš„æ·±æ·ºè¨­å®š
            applyTheme(state.themeColor, isDark);
            showToast(isDark ? "æ·±è‰²æ¨¡å¼å·²é–‹å•Ÿ" : "æ·±è‰²æ¨¡å¼å·²é—œé–‰");
        }
        function applyHexColor() {
            const hexInput = document.getElementById('custom-hex-input');
            const color = hexInput.value.trim();
            
            // é©—è­‰æ ¼å¼æ˜¯å¦ç‚ºæœ‰æ•ˆçš„ Hex è‰²ç¢¼ (ä¾‹å¦‚ #FFFFFF æˆ– #FFF)
            const isHex = /^#([A-Fa-f0-9]{3}){1,2}$/.test(color);
            
            if (isHex) {
                applyTheme(color);
                renderContent();
                showToast("å·²æ›´æ›è‡ªè¨‚ä¸»é¡Œè‰²ï¼");
            } else {
                showToast("æ ¼å¼éŒ¯èª¤ï¼è«‹è¼¸å…¥å¦‚ #92A8D1 çš„è‰²ç¢¼");
            }
        }

        // --- æ•¸æ“šå‚™ä»½ ---
        function renderBackupView(container) {
            container.innerHTML = `<div class="p-6"><div class="flex items-center gap-3 mb-8"><button onclick="state.subPage=null;renderContent()" class="p-2 -ml-2 text-slate-400 active:scale-90"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2"/></svg></button><h2 class="text-2xl font-black tracking-tight text-slate-800">åŒ¯å…¥èˆ‡åŒ¯å‡º</h2></div>
                <div class="bg-white rounded-3xl p-8 card-shadow border-2 border-dashed border-slate-200 text-center text-slate-800"><div class="w-20 h-20 bg-slate-50 text-slate-400 rounded-3xl flex items-center justify-center mx-auto mb-6 text-3xl">ğŸ“Š</div><h3 class="text-lg font-bold mb-2">Excel ç®¡ç†</h3><p class="text-sm text-slate-400 mb-8 px-4">æœ¬åœ° Excel å‚™ä»½ä¸åŒ…å«åœ–ç‰‡è³‡æ–™<br>âš ï¸åŒ¯å…¥å¾Œæœƒè¦†è“‹ç¾æœ‰è³‡æ–™ä¸¦æ¸…é™¤åœ–ç‰‡</p><div class="grid grid-cols-1 gap-4"><button onclick="exportToExcel()" class="bg-brand text-white font-black py-5 rounded-2xl shadow-lg active:scale-95 transition-transform">åŒ¯å‡º Excel å‚™ä»½</button><label class="bg-slate-800 text-white font-black py-5 rounded-2xl active:scale-95 cursor-pointer text-center">åŒ¯å…¥ Excel é‚„åŸ<input type="file" class="hidden" accept=".xlsx, .xls" onchange="importFromExcel(this)"></label></div></div></div>`;
        }
        // --- å¸³æœ¬èˆ‡åŠŸèƒ½è¨­å®š ---
        function renderAccountConfig(container) {
        container.innerHTML = `
            <div class="p-6">
                <div class="flex items-center gap-3 mb-8">
                    <button onclick="state.subPage=null;renderContent()" class="p-2 -ml-2 text-slate-400 active:scale-90 font-bold text-xl">â—€</button>
                    <h2 class="text-2xl font-black tracking-tight text-slate-800">å¸³æœ¬èˆ‡åŠŸèƒ½</h2>
                </div>
                <div class="space-y-6">
                    <div class="bg-white rounded-3xl p-6 card-shadow">
                        <h3 class="text-sm font-bold text-slate-500 uppercase mb-4 tracking-widest">å¸³æœ¬åˆ†é¡æ¨¡å¼</h3>
                        <div class="flex bg-slate-100 p-1 rounded-2xl">
                            <button onclick="switchCatSet('categories')" class="flex-1 py-3 text-sm font-bold rounded-xl transition-all ${state.categorySet === 'categories' ? 'bg-white text-brand shadow-sm' : 'text-slate-400'}">KPOP æ¨¡å¼</button>
                            <button onclick="switchCatSet('categoriesACGN')" class="flex-1 py-3 text-sm font-bold rounded-xl transition-all ${state.categorySet === 'categoriesACGN' ? 'bg-white text-brand shadow-sm' : 'text-slate-400'}">ACGN æ¨¡å¼</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-3xl p-6 card-shadow">
                        <div class="flex items-center justify-between ${state.enableExchange ? 'mb-6 border-b border-slate-50' : ''}">
                            <div>
                                <h3 class="text-sm font-bold text-slate-500 tracking-widest">é–‹å•ŸåŒ¯ç‡æ›ç®—å·¥å…·</h3>
                                <p class="text-[10px] text-slate-400">åœ¨æ–°å¢ç´€éŒ„æ™‚é¡¯ç¤ºå¤–å¹£æ›ç®—å€</p>
                                <p class="text-[10px] text-slate-400">è‹¥åœ¨é—œé–‰æ™‚ç·¨è¼¯ç´€éŒ„ï¼ŒåŒ¯ç‡è³‡æ–™æœƒæ¶ˆå¤±</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer" onchange="toggleExchange(this.checked)" ${state.enableExchange ? 'checked' : ''}>
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-slate-700 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                            </label>
                        </div>
                     ${state.enableExchange ? `
                    <div class="animate-enter">
                        <h3 class="text-xs  text-slate-400 mb-4 tracking-widest uppercase">é è¨­è¨˜å¸³å¹£åˆ¥</h3>
                        <div class="relative">
                            <select onchange="updateDefaultCurrency(this.value)" class="w-full bg-slate-50 rounded-2xl p-4 text-sm font-bold text-slate-700 outline-none border-2 border-transparent focus:border-brand appearance-none">
                                <option value="TWD" ${state.defaultCurrency === 'TWD' ? 'selected' : ''}>TWD - æ–°å°å¹£</option>
                                <option value="HKD" ${state.defaultCurrency === 'HKD' ? 'selected' : ''}>HKD - æ¸¯å¹£</option>
                                <option value="USD" ${state.defaultCurrency === 'USD' ? 'selected' : ''}>USD - ç¾é‡‘</option>
                                <option value="JPY" ${state.defaultCurrency === 'JPY' ? 'selected' : ''}>JPY - æ—¥åœ“</option>
                                <option value="KRW" ${state.defaultCurrency === 'KRW' ? 'selected' : ''}>KRW - éŸ“å¹£</option>
                                <option value="CNY" ${state.defaultCurrency === 'CNY' ? 'selected' : ''}>CNY - äººæ°‘å¹£</option>
                            </select>
                            <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">â–¼</div>
                        </div>
                        <p class="text-[10px] text-slate-400 mt-2 px-1">æ›´æ”¹æ­¤è™•å°‡æœƒå½±éŸ¿åŒ¯ç‡æ›ç®—çš„åŸºæº–å¹£åˆ¥ã€‚</p>
                    </div>
                    ` : ''}
                    </div>
                </div>
            </div>`;
        }
        function updateDefaultCurrency(val) {
            state.defaultCurrency = val;
            localStorage.setItem('fe_v11_defaultCurrency', val);
            localStorage.removeItem('fandom_rates_timestamp'); //æ¸…é™¤åŸæœ¬å¿«å–
            fetchRates(); 
            showToast(`é è¨­å¹£åˆ¥å·²æ›´æ”¹ç‚º ${val}`);
            renderContent();
        }

        function toggleExchange(val) {
            state.enableExchange = val;
            localStorage.setItem('fe_v11_enableExchange', val);
            if (val) fetchRates();
            renderContent(); // é‡æ–°æ¸²æŸ“ä»¥å¯¦ç¾ toggle æ•ˆæœ
            showToast(val ? "å·²é–‹å•Ÿæ›ç®—å·¥å…·" : "å·²é—œé–‰æ›ç®—å·¥å…·");
        }
     // å¿«å–ç²å–åŒ¯ç‡
        async function fetchRates() {
            if (!state.enableExchange) return;
            const CACHE_KEY = 'fandom_rates_data';
            const CACHE_TIME_KEY = 'fandom_rates_timestamp';
            const FIVE_DAY = 5 * 24 * 60 * 60 * 1000; // 5å¤©çš„æ¯«ç§’æ•¸

            const cachedData = localStorage.getItem(CACHE_KEY);
            const cachedTime = localStorage.getItem(CACHE_TIME_KEY);
            const now = Date.now();

            // å¦‚æœæœ‰å¿«å–ä¸”æœªéæœŸï¼Œç›´æ¥ä½¿ç”¨
            if (cachedData && cachedTime && (now - cachedTime < FIVE_DAY)) {
                state.rates = JSON.parse(cachedData);
                state.rateStatusText = "åŒ¯ç‡å·²å°±ç·’ (å¿«å–)";
                console.log("Using cached rates from:", new Date(parseInt(cachedTime)).toLocaleString());
                return;
            }

            // å¦å‰‡ï¼Œå‘ç¶²è·¯è«‹æ±‚æ–°çš„åŒ¯ç‡
            state.rateStatusText = "æ­£åœ¨æ›´æ–°æœ€æ–°åŒ¯ç‡...";
            updateRateUI();
            try {
                const base = state.defaultCurrency || 'TWD';
                const res = await fetch(`https://v6.exchangerate-api.com/v6/50ae63bdd687e4ec0781ce85/latest/${base}`);
                const data = await res.json();
                if (data?.conversion_rates) {
                    const newRates = {
                        KRW: 1 / data.conversion_rates.KRW,
                        JPY: 1 / data.conversion_rates.JPY,
                        CNY: 1 / data.conversion_rates.CNY,
                        USD: 1 / data.conversion_rates.USD,
                        HKD: 1 / data.conversion_rates.HKD,
                        TWD: 1 / data.conversion_rates.TWD
                    };
                    // æ›´æ–°ç‹€æ…‹ä¸¦å­˜å…¥æœ¬åœ°å„²å­˜
                    state.rates = newRates;
                    localStorage.setItem(CACHE_KEY, JSON.stringify(newRates));
                    localStorage.setItem(CACHE_TIME_KEY, now.toString());
                    state.rateStatusText = "åŒ¯ç‡å·²æ›´æ–°(ç¶²è·¯)";
                    console.log("Rates updated from API");
                }
                else {
                    if (cachedData) state.rates = JSON.parse(cachedData);
                    state.rateStatusText = "åŒ¯ç‡é€£ç·šå¤±æ•—ï¼Œä½¿ç”¨é›¢ç·šæ•¸æ“š";
                }
            } catch (e) {
                console.warn("API æŠ“å–å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼æˆ–èˆŠå¿«å–",e);
                if (cachedData) state.rates = JSON.parse(cachedData);
                state.rateStatusText = "åŒ¯ç‡é€£ç·šå¤±æ•—ï¼Œä½¿ç”¨é›¢ç·šæ•¸æ“š";
            }
            updateRateUI();
        }
        // æ›´æ–°ä»‹é¢ä¸Šçš„æ–‡å­— (è‹¥å…ƒç´ å­˜åœ¨)
        function updateRateUI() {
            const tag = document.getElementById('rate-tag');
            if (tag) tag.innerText = state.rateStatusText;
        }
        function convertCurrency() { //åŒ¯ç‡æ›ç®—
            const currency = document.getElementById('currency-select').value;
            const amount = parseFloat(document.getElementById('foreign-amount').value);
            const priceInput = document.getElementById('m-u-p');
            const rateTag = document.getElementById('rate-tag');

            if (!amount) return;

            const rate = state.rates[currency];
            const result = Math.round(amount * rate);
            
            priceInput.value = result;
            rateTag.innerText = `1 ${currency} â‰ˆ ${rate.toFixed(4)} ${state.defaultCurrency}`;
            rateTag.classList.add('text-brand');
        }
        // --- ç‰ˆæœ¬èªªæ˜ ---
        function renderVersionView(container) { 
            const logs = [
                { version: 'v8.0', date: '2026.02.05', updates: ['ç”Ÿæˆåˆ†äº«åœ–åŠŸèƒ½ï¼šå°‡ç•¶æœˆæ¶ˆè²»èˆ‡æ”¶è—ç…§ç‰‡æ•´ç†æˆä¸€å¼µé•·åœ– <br> è¼•é¬†åˆ†äº«ä½ çš„è¿½æ˜Ÿ Photo Dump' ]},
                { version: 'v7.0', date: '2026.01.24', updates: ['åŒ¯ç‡æ›ç®—å·¥å…·ï¼Œå•Ÿç”¨å¾Œæ”¯æ´å¤–å¹£é‡‘é¡èˆ‡åŸå¹£åˆ¥ç´€éŒ„','æ–°å¢æ—¥æœŸåŠŸèƒ½ï¼Œä¿æŒè¨˜å¸³é †åºä¸è¢«æ‰“äº‚']},
                { version: 'v6.0', date: '2026.01.11', updates: ['å…¨é¢å‡ç´šã€Œå¸³æœ¬åˆ†é¡æ¨¡å¼ã€ï¼Œå°ˆç‚º KPOP èˆ‡ ACGN æ¶ˆè²»æƒ…å¢ƒè¨­è¨ˆ','ç›®å‰è²¡å‹™å ±è¡¨åƒ…æ”¯æ´æŸ¥çœ‹å„å¸³æœ¬é‡‘é¡ç„¡æ³•åˆä½µæŸ¥çœ‹']},
                { version: 'v5.0', date: '2026.01.04', updates: ['ã€Œå”®å‡ºã€åŠŸèƒ½ï¼Œå®Œæ•´ç´€éŒ„è¿½æ˜Ÿè³‡ç”¢æµå‘', 'å„ªåŒ–è²¡å‹™å ±è¡¨ï¼šæ”¯æ´æ”¯å‡ºã€æ”¶å…¥ã€æ·¨æ”¯å‡ºåˆ†æ', 'ä¿®æ­£ Excel åŒ¯å…¥/åŒ¯å‡ºä¹‹æ•¸æ“šæº–ç¢ºæ€§','ã€Œè¤‡è£½ä¸¦æ–°å¢ã€åŠŸèƒ½ï¼Œå¿«é€Ÿè¨˜éŒ„ç›¸ä¼¼æ”¯å‡º'] },
                { version: 'v4.0', date: '2025.12.29', updates: ['æ™ºæ…§æ¨™ç±¤å»ºè­°ï¼Œå¿«é€Ÿå®Œæˆåˆ†é¡', 'è‡ªè¨‚ä¸»é¡Œæ¼¸å±¤èˆ‡æ·±è‰²æ¨¡å¼', 'æ¸…é™¤å†—é¤˜åœ–æª”ï¼Œæå‡æ•´é«”æ•ˆèƒ½'] },
                { version: 'v3.0', date: '2025.12.27', updates: ['é‡‘é¡éš±è—åŠŸèƒ½ï¼Œçœ‹ä¸è¦‹ä»£è¡¨æ²’æœ‰èŠ±', 'æ–°å¢é‹è²»æ¬„ä½ï¼Œæ¶ˆè²»ç´€éŒ„æ›´å®Œæ•´', 'å¤–è§€è¨­å®šæ”¯æ´è‡ªè¡Œè¼¸å…¥è‰²ç¢¼'] },
                { version: 'v2.0', date: '2025.12.25', updates: ['æ”¯æ´åŒæ™‚éæ¿¾å¹´ä»½ã€æœˆä»½èˆ‡åˆ†é¡', 'å„ªåŒ–åœ–ç‰‡å£“ç¸®ç®—æ³•', 'å„ªåŒ– Excel åŒ¯å…¥æµç¨‹ï¼Œæ”¯æ´é è¨­å€¼'] },
                { version: 'v1.0', date: '2025.12.25', updates: ['è¿½æ˜ŸéŒ¢åŒ…æ­£å¼ä¸Šç·š', 'æ¶ˆè²»ç´€éŒ„ã€è²¡å‹™å ±è¡¨ã€é¡˜æœ›æ¸…å–®', 'ç…§ç‰‡ç‰†ã€å¤–è§€è¨­å®š'] }
            ];

            container.innerHTML = `
                <div class="p-6">
                    <div class="flex items-center gap-3 mb-8">
                        <button onclick="state.subPage=null;renderContent()" class="p-2 -ml-2 text-slate-400 active:scale-90">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2"/></svg>
                        </button>
                        <h2 class="text-2xl font-black tracking-tight text-slate-800">ç‰ˆæœ¬èªªæ˜</h2>
                    </div>
                    
                    <div class="flex flex-col items-center mb-10">
                        <div class="w-20 h-20 bg-brand rounded-[2rem] flex items-center justify-center text-white text-3xl shadow-xl mb-4">ğŸ’</div>
                        <h3 class="text-lg font-black text-slate-800">è¿½æ˜ŸéŒ¢åŒ… Fandom Wallet</h3>
                        <p class="text-[10px] text-slate-400 font-mono uppercase tracking-widest mt-1">Version 8.0</p>
                    </div>

                    <div class="space-y-6">
                        ${logs.map(log => `
                            <div class="relative pl-6 border-l-2 border-slate-100">
                                <div class="absolute -left-[9px] top-0 w-4 h-4 bg-white border-2 border-brand rounded-full"></div>
                                <div class="flex justify-between items-end mb-2">
                                    <h4 class="font-black text-brand">${log.version}</h4>
                                    <span class="text-[9px] font-bold text-slate-300 font-mono">${log.date}</span>
                                </div>
                                <ul class="space-y-1">
                                    ${log.updates.map(u => `<li class="text-xs text-slate-500 font-medium leading-relaxed flex gap-2">
                                        <span class="text-brand/40">â€¢</span>${u}
                                    </li>`).join('')}
                                </ul>
                            </div>
                        `).join('')}
                    </div>

                    <div class="mt-8 border-t border-slate-50 text-center">
                        <p class="text-[9px] text-slate-300 font-medium">Made for Fans , by fan. </p>
                        <p class="text-[8px] text-slate-300 mt-1 uppercase tracking-widest">Â©2026 bobi_9yu </p>
                    </div>
                </div>
            `;
        }

        /**
         * 4. ä»˜æ¬¾æ–¹å¼å‹•æ…‹ç›£è½
         */
        function handlePaymentChange(val) {
            const amountContainer = document.getElementById('paid-amount-container');
            if (amountContainer) {
                amountContainer.classList.toggle('hidden', val !== 'å·²ä»˜è¨‚é‡‘');
            }
        }
        function openActionModal(e, type, id) { //å…±ç”¨ç·¨è¼¯å½ˆçª—
            e.stopPropagation();
            state.actionTarget = { type, id };
            
            const convertBtn = document.getElementById('action-convert-btn');
            if (convertBtn) {
                // å¦‚æœé»æ“Šçš„æ˜¯ã€Œå¿ƒé¡˜æ¸…å–® (wish)ã€ï¼Œæ‰é¡¯ç¤ºè½‰æ›æŒ‰éˆ•
                if (type === 'wish') {
                    convertBtn.classList.remove('hidden');
                } else {
                    convertBtn.classList.add('hidden');
                }
            }
            
            // å‘¼å«å‹•ç•«é–‹å•Ÿ
            openModalAnimation('action-modal-overlay', 'action-modal-container');
        }

        function triggerEditFromAction() {
            const { type, id } = state.actionTarget; closeActionModal();
            const list = type === 'expense' ? state.expenses : state.wishlist;
            const item = list.find(i => i.id === id);
            if (item) openAddModal(item);
        }

        function triggerDeleteFromAction() { 
            const { type, id } = state.actionTarget; closeActionModal();
        }
        function triggerCopyFromAction() {
            const { type, id } = state.actionTarget; 
            closeActionModal();
            //æ ¹æ“šé¡å‹ï¼ˆæ¶ˆè²»æˆ–é¡˜æœ›ï¼‰æ‰¾åˆ°åŸå§‹è³‡æ–™
            const list = type === 'expense' ? state.expenses : state.wishlist;
            const originalItem = list.find(i => String(i.id) === String(id));
            if (originalItem) {
                const copiedData = { 
                    ...originalItem, 
                    id: null,
                    //year: now.getFullYear(),   // è‡ªå‹•è¨­ç‚ºä»Šå¹´ åœ¨çœ‹ä½¿ç”¨ä¸Šéœ€ä¸éœ€è¦
                    //month: now.getMonth() + 1  // è‡ªå‹•è¨­ç‚ºä»Šæœˆ
                };
                openAddModal(copiedData);
                showToast("å·²è¼‰å…¥è¤‡è£½è³‡æ–™ï¼Œä¿®æ”¹å¾Œè«‹å„²å­˜");
            }
        }

        function triggerConvertToExpense() {
            const { id } = state.actionTarget; closeActionModal();
            const wish = state.wishlist.find(w => w.id === id);
            if(wish) {
                state.wishSourceId = id;
                const categoryMap = { //å› ç‚ºåŸæœ¬é¡˜æœ›åˆ†é¡è·Ÿæ¶ˆè²»åˆ†é¡ä¸ä¸€è‡´
                    'å‘¨é‚Š': 'å‘¨é‚Šå•†å“',
                    'æ¼”å”±æœƒ': 'æ¼”å”±æœƒ / è¦‹é¢æœƒé–€ç¥¨',
                };
                const targetCategory = categoryMap[wish.category] || wish.category || 'å‘¨é‚Šå•†å“';
                openAddModal({ ...wish,id: null, qty: 1, category: targetCategory, arrivalStatus: 'æœªåˆ°è²¨', paymentMethod: 'å¾…ä»˜æ¬¾' });
            }
        }
        function openModalAnimation(overlayId, containerId) {
            const overlay = document.getElementById(overlayId);
            const container = document.getElementById(containerId);
            if (!overlay || !container) return;
            overlay.classList.remove('hidden');
            container.style.transform = 'translateY(100%)';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0)';
            container.offsetHeight; // force reflow
            container.style.transform = 'translateY(0)';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.6)';
        }

        function closeModalAnimation(overlayId, containerId) {
            const overlay = document.getElementById(overlayId);
            const container = document.getElementById(containerId);
            if (!overlay || !container) return;
            container.style.transform = 'translateY(100%)';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0)';
            setTimeout(() => {
                overlay.classList.add('hidden');
                container.style.transform = ''; 
            }, 300);
        }

        function closeModal() {state.wishSourceId = null; closeModalAnimation('modal-overlay', 'modal-container'); }
        function closeActionModal() { closeModalAnimation('action-modal-overlay', 'action-modal-container'); }

        /**
         * 5. æ•¸æ“šè™•ç†
         */
        function openAddModal(itemData = null) {
            state.editingId = itemData?.id ? String(itemData.id) : null;
            state.tempImage = itemData?.image || null; // æ—¢æœ‰ç¶²å€å­˜åœ¨é€™è£¡
            state.tempImageBlob = null;               // é–‹å•Ÿæ™‚æ¸…ç©ºæ–°é¸å–çš„æª”æ¡ˆ
            const form = document.getElementById('data-form');
            const modalTitle = document.getElementById('modal-title');
            // ä¿®æ”¹åˆ¤æ–·é‚è¼¯ï¼šå¦‚æœè³‡æ–™è£¡æœ‰ qtyï¼Œæˆ–è€…ç›®å‰ç¢ºå¯¦åœ¨ expense åˆ†é ï¼Œæ‰é¡¯ç¤ºæ¶ˆè²»æ¨¡å¼
            const isWishMode = (state.activeTab === 'wish' && !itemData?.qty);
         // --- æ¨™é¡Œåˆ¤æ–·é‚è¼¯å„ªåŒ– ---
            if (isWishMode) {
                modalTitle.textContent = state.editingId ? "ç·¨è¼¯å¿ƒé¡˜" : "æ–°å¢å¿ƒé¡˜";
            } else {
                // æ¶ˆè²»æ¨¡å¼ä¸‹çš„ä¸‰ç¨®æƒ…æ³ï¼š
                if (state.wishSourceId) {
                    // 1. å¾é¡˜æœ›æ¸…å–®è½‰æ›è€Œä¾†
                    modalTitle.textContent = "åŠ å…¥æ¶ˆè²»æ¸…å–®";
                } else if (state.editingId) {
                    // 2. ç·¨è¼¯ç¾æœ‰æ¶ˆè²»ç´€éŒ„
                    modalTitle.textContent = "ç·¨è¼¯ç´€éŒ„";
                } else {
                    // 3. ä¸€èˆ¬æ–°å¢æ¶ˆè²»
                    modalTitle.textContent = "æ–°å¢ç´€éŒ„";
                }
            }
            if (!isWishMode) { //æ–°å¢æ¶ˆè²»
                const defaultMonthStr = String(state.filterMonth).padStart(2,'0');
                const yStr = state.filterYear === 0 ? String(new Date().getFullYear()) : String(state.filterYear);//å¦‚æœå¹´åˆ†é¸ä¸é™çš„æ™‚å€™æ–°å¢
                const mStr = state.filterMonth === 0  ? String(new Date().getMonth() + 1).padStart(2, '0'): String(state.filterMonth).padStart(2, '0'); 
                const dStr = String(new Date().getDate()).padStart(2, '0');//é è¨­ç•¶å¤©
                const defaultDate = `${yStr}-${mStr}-${dStr}`;
                const isPaidDeposit = itemData?.paymentMethod === 'å·²ä»˜è¨‚é‡‘';
                const filteredOptions = state.tempType === 'expense' ? arrivalOptions.filter(o => o !== 'å·²å”®å‡º') : ['å·²å”®å‡º'];
                const isConvertingWish = state.wishSourceId !== null;//æ˜¯å¦ç‚ºå¿ƒé¡˜æ¸…å–®é€²ä¾†çš„
                const currentCats = getCurrentCategories();
                let dropdownOptions = [...currentCats];
                if (itemData) {
                    // æª¢æŸ¥ç·¨è¼¯ä¸­é …ç›®çš„åˆ†é¡æ˜¯å¦åœ¨ç›®å‰çš„æ¸…å–®ä¸­
                    const exists = currentCats.some(c => c.id === itemData.category);
                    if (!exists) {
                        // å¦‚æœä¸åœ¨ï¼ˆè·¨çµ„ç·¨è¼¯ï¼‰ï¼Œå¾æ‰€æœ‰åˆ†é¡ä¸­æ‰¾å‡ºè©²åˆ†é¡ä¸¦å¼·åˆ¶è£œé€²ä¸‹æ‹‰é¸å–®
                        const allCats = [...categories, ...categoriesACGN];
                        const originalCat = allCats.find(c => c.id === itemData.category);
                        if (originalCat) {
                            dropdownOptions.unshift(originalCat); // è£œåœ¨æœ€å‰é¢
                        }
                    }
                }
                form.innerHTML = `
                    <div class="space-y-4">
                        <div id="type-switcher" class="flex bg-slate-100 p-1 rounded-2xl mb-6 type-switcher">
                            <button type="button" onclick="setTempType('expense')" id="btn-type-exp" class="flex-1 py-2 text-xs font-bold rounded-xl transition-all active shadow-sm">æ”¯å‡º</button>
                            <button type="button" onclick="setTempType('income')" id="btn-type-inc" ${isConvertingWish ? 'disabled' : ''} class="flex-1 py-2 text-xs font-bold rounded-xl transition-all text-slate-400">å”®å‡º</button>
                        </div>
                        <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">å•†&#8203;å“&#8203;å&#8203;ç¨±</label><input type="text" id="m-t-l" autocomplete="one-time-code" autocorrect="off" required value="${itemData?.name || ''}" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none border-2 border-transparent focus:border-brand text-gray-800"></div>
                        <div class="flex gap-4">
                            <div class="flex-1 space-y-1">
                                <label class="text-[10px] font-bold text-slate-400 uppercase">å–®&#8203;åƒ¹</label>
                                <input type="number" id="m-u-p" inputmode="decimal" autocomplete="one-time-code" autocorrect="off" required value="${itemData?.price || ''}" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800">
                            </div>
                            <div class="flex-1 space-y-1 relative" id="qty-combobox">
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">æ•¸é‡</label>
                                <div class="relative flex items-center">
                                    <input type="number" id="m-qty" inputmode="numeric" value="${itemData?.qty || 1}" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800 border-2 border-transparent focus:border-brand">
                                    <div id="qty-toggle" class="absolute right-3 cursor-pointer text-slate-400"><svg class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" stroke-width="2"/></svg></div>
                                </div>
                                <ul id="qty-options" class="absolute z-50 w-full mt-1 bg-white border border-slate-100 rounded-xl shadow-xl max-h-40 overflow-y-auto hidden custom-scrollbar"></ul>
                            </div>
                            <div class="flex-1 space-y-1" id="shipping-fee">
                                <label class="text-[10px] font-bold text-slate-400 uppercase">é‹è²»</label>
                                <input type="number" id="m-shipping" inputmode="numeric" value="${itemData?.shipping || ''}" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800">
                            </div>
                        </div>
                    
                        ${state.enableExchange ?`
                            <div id="converter-section" class="space-y-1 transition-all duration-300 origin-top overflow-hidden">
                                <div class="flex justify-between items-end">
                                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em]">åŸå§‹å¹£å€¼</label>
                                    <span id="rate-tag" class="text-[9px] text-slate-300 italic mr-1">æ­£åœ¨è¼‰å…¥åŒ¯ç‡...</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="relative flex-1 flex items-center bg-slate-50 rounded-2xl border border-transparent focus-within:border-slate-100 transition-all overflow-hidden">
                                        <select id="currency-select" class="bg-transparent border-none py-4 pl-4 pr-1 text-xs font-bold text-slate-300 focus:ring-0 appearance-none">
                                            <option value="KRW" ${itemData?.currency === 'KRW' ? 'selected' : ''}>KRW</option>
                                            <option value="JPY" ${itemData?.currency === 'JPY' ? 'selected' : ''}>JPY</option>
                                            <option value="CNY" ${itemData?.currency === 'CNY' ? 'selected' : ''}>CNY</option>
                                            <option value="USD" ${itemData?.currency === 'USD' ? 'selected' : ''}>USD</option>
                                            <option value="HKD" ${itemData?.currency === 'HKD' ? 'selected' : ''}>HKD</option>
                                        </select>
                                        <input type="number" id="foreign-amount" value="${itemData?.foreign_amount || ''}" class="w-full bg-transparent border-none p-4 text-sm font-medium focus:ring-0" placeholder="0">
                                        <button type="button" onclick="convertCurrency()" class="p-4 text-brand hover:bg-brand/5 transition-colors group">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 group-active:scale-90 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">åˆ†é¡</label><select id="m-cat" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800">${dropdownOptions.map(c => `<option ${itemData?.category == c.id ? 'selected' : ''}>${c.id}</option>`).join('')}</select></div>
                            <div class="space-y-1 flex flex-col"><label class="text-[10px] font-bold text-slate-400 uppercase mb-1">æ¶ˆè²»å¹´æœˆæ—¥</label><input type="date" id="m-date"     value="${itemData?.year && itemData?.month ? 
                                `${itemData.year}-${String(itemData.month).padStart(2,'0')}-${String(itemData.day? String(itemData.day).padStart(2,'0') : '01').padStart(2,'0')}` : defaultDate}" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800"></div>
                        </div>
                        <div class="flex gap-4" id="shipping-state">
                            <div class="flex-1 space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">è³¼ç‰©å¹³å°</label><input type="text" id="m-platform" autocomplete="one-time-code" autocorrect="off" placeholder="LINEç¤¾ç¾¤ã€WVS" value="${itemData?.platform || ''}" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800"></div>
                            <div class="flex-1 space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">åˆ°è²¨ç‹€æ…‹</label><select id="m-status" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800">${filteredOptions.map(o => `<option ${itemData?.arrivalStatus == o ? 'selected' : ''}>${o}</option>`).join('')}</select></div>
                        </div>
                
                        <div class="grid grid-cols-2 gap-4" id="shipping-payment">
                            <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">ä»˜æ¬¾æ–¹å¼</label><select id="m-pay-method" onchange="handlePaymentChange(this.value)" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800">${paymentOptions.map(o => `<option ${itemData?.paymentMethod == o ? 'selected' : ''}>${o}</option>`).join('')}</select></div>
                            <div id="paid-amount-container" class="space-y-1 ${isPaidDeposit ? '' : 'hidden'}"><label class="text-[10px] font-bold text-slate-400 uppercase">å·²ä»˜é‡‘é¡</label><input type="number" id="m-paid-amount" autocomplete="one-time-code" autocorrect="off" value="${itemData?.paidAmount || ''}" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800"></div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">æ¨™ç±¤</label>
                            <div class="relative">
                                <div id="m-tag-container" class="flex flex-wrap gap-2 p-2 bg-slate-50 rounded-xl border-2 border-transparent focus-within:border-brand min-h-[46px] items-center transition-all">
                                    <input type="text" id="m-tag-input" autocomplete="off" placeholder="è¼¸å…¥å®Œæ¨™ç±¤å¾Œï¼Œè¨˜å¾—åŠ é€—è™ŸåŠ å…¥" class="flex-1 bg-transparent outline-none text-sm text-gray-800 min-w-[120px]">
                                </div>
                                <ul id="m-tag-suggestions" class="hidden absolute z-[60] left-0 right-0 mt-1 bg-white border border-slate-100 rounded-xl shadow-xl max-h-40 overflow-y-auto custom-scrollbar"></ul>
                            </div>
                        </div>
                        <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">å‚™è¨»</label><textarea id="m-remark" autocomplete="one-time-code" autocorrect="off" placeholder="é€šè·¯ã€ooä»£è³¼ã€é è¨ˆå‡ºè²¨æ—¥æœŸç­‰ç­‰" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none h-16 resize-none text-gray-800">${itemData?.remark || ''}</textarea></div>
                        <div onclick="const el=document.getElementById('m-img'); if(el){ el.value=''; el.click(); }" id="img-placeholder" class="bg-slate-50 border-2 border-dashed border-slate-100 rounded-3xl h-24 flex items-center justify-center overflow-hidden cursor-pointer shadow-inner">${state.tempImage ? `<img src="${state.tempImage}" class="w-full h-full object-cover">` : `<span class="text-slate-300 text-[10px] font-bold uppercase tracking-widest">ä¸Šå‚³ç›¸ç‰‡</span>`}</div>
                        <input type="file" id="m-img" accept="image/*" style="position: fixed;bottom: 0;left: 0;width: 48px;height: 48px;opacity: 0;z-index: 10;" onchange="handleImage(this)">
                    </div>`;
                    if(state.enableExchange) {updateRateUI();}
                    initQtyPicker();
                    const currentType = (itemData?.type === 'income') ? 'income' : 'expense';
                    setTempType(currentType);
                    window.getSmartTags = initSmartTags(itemData?.tags || []);
                        
            } else {
                // é¡˜æœ›æ¨¡å¼ - ä¾ç…§è¦æ±‚è¨­å®šé è¨­æ—¥æœŸæ™‚é–“
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                const defaultTime = "12:00";
                const currentCats = getCurrentWishCategories();
                let dropdownOptions = [...currentCats];
                if (itemData) {
                    const exists = currentCats.includes(itemData.category);//é¡˜æœ›æ¸…å–®ç›´æ¥æ¯”å°å­—ä¸²
                    if (!exists) {
                        const allWishPool = [...wishCategories, ...wishCategoriesACGN]; 
                        const originalCat = allWishPool.find(c => c === itemData.category);
                        if (originalCat) {
                            dropdownOptions.unshift(originalCat); 
                        }
                    }
                }
                form.innerHTML = `<div class="space-y-4">
                    <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">å•†&#8203;å“&#8203;å&#8203;ç¨±</label><input type="text" id="m-t-l" autocomplete="one-time-code" autocorrect="off" required value="${itemData?.name || ''}" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800 font-bold"></div>
                    <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">é &#8203;ä¼°&#8203;åƒ¹&#8203;æ ¼</label><input type="number" id="m-u-p" inputmode="decimal" autocomplete="one-time-code" autocorrect="off" value="${itemData?.price || ''}" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800 font-bold"></div>
                        ${state.enableExchange ?`
                            <div id="converter-section" class="space-y-1 transition-all duration-300 origin-top overflow-hidden">
                                <div class="flex justify-between items-end ml-1">
                                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em]">åŸå§‹å¹£å€¼</label>
                                    <span id="rate-tag" class="text-[9px] text-slate-300 italic">æ­£åœ¨è¼‰å…¥åŒ¯ç‡...</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="relative flex-1 flex items-center bg-slate-50 rounded-2xl border border-transparent focus-within:border-slate-100 transition-all overflow-hidden">
                                        <select id="currency-select" class="bg-transparent border-none py-4 pl-4 pr-1 text-xs font-bold text-slate-300 focus:ring-0 appearance-none">
                                            <option value="KRW" ${itemData?.currency === 'KRW' ? 'selected' : ''}>KRW</option>
                                            <option value="JPY" ${itemData?.currency === 'JPY' ? 'selected' : ''}>JPY</option>
                                            <option value="CNY" ${itemData?.currency === 'CNY' ? 'selected' : ''}>CNY</option>
                                            <option value="USD" ${itemData?.currency === 'USD' ? 'selected' : ''}>USD</option>
                                            <option value="HKD" ${itemData?.currency === 'HKD' ? 'selected' : ''}>HKD</option>
                                        </select>
                                        <input type="number" id="foreign-amount" value="${itemData?.foreign_amount || ''}" class="w-full bg-transparent border-none p-4 text-sm font-medium focus:ring-0" placeholder="0">
                                        <button type="button" onclick="convertCurrency()" class="p-4 text-brand hover:bg-brand/5 transition-colors group">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 group-active:scale-90 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">åˆ†é¡</label><select id="m-wish-cat" autocomplete="one-time-code" autocorrect="off" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800">${dropdownOptions.map(c => `<option value="${c}" ${itemData?.category == c ? 'selected' : ''}>${c}</option>`).join('')}</select></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1 flex flex-col"><label class="text-[10px] font-bold text-slate-400 uppercase mb-1">ç™¼å”®æ—¥æœŸ</label><input type="date" id="m-release-date" value="${itemData?.releaseDate || today}" class="w-full bg-slate-50 rounded-xl p-3 text-sm text-gray-800 font-bold"></div>
                        <div class="space-y-1 flex flex-col"><label class="text-[10px] font-bold text-slate-400 uppercase mb-1">æ™‚é–“</label><input type="time" id="m-release-time" value="${itemData?.releaseTime || defaultTime}" class="w-full bg-slate-50 rounded-xl p-3 text-sm text-gray-800 font-bold"></div>
                    </div>
                    <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase font-black">å¿ƒé¡˜å‚™è¨»</label><textarea id="m-remark" autocomplete="one-time-code" autocorrect="off" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none h-16 resize-none text-gray-800 font-bold">${itemData?.remark || ''}</textarea></div>
                    <div onclick="const el=document.getElementById('m-img'); if(el){ el.value=''; el.click(); }" id="img-placeholder" class="bg-slate-50 border-2 border-dashed border-slate-100 rounded-3xl h-24 flex items-center justify-center overflow-hidden cursor-pointer shadow-inner">${state.tempImage ? `<img src="${state.tempImage}" class="w-full h-full object-cover">` : `<span class="text-slate-300 text-[10px] font-bold uppercase tracking-widest">ä¸Šå‚³ç›¸ç‰‡</span>`}</div>
                    <input type="file" id="m-img" accept="image/*" style="position: fixed;bottom: 0;left: 0;width: 48px;height: 48px;opacity: 0;z-index: 10;" onchange="handleImage(this)">
                </div>`;
                if(state.enableExchange) {updateRateUI();}
            }
                        
            document.getElementById('modal-overlay').classList.remove('hidden');
            setTimeout(() => { if (form) form.scrollTop = 0; }, 50);//æ¯æ¬¡é–‹å•Ÿéƒ½åœ¨å½ˆçª—æœ€ä¸Šæ–¹
        }
    function initQtyPicker() { //æ•¸é‡é¸æ“‡
        const input = document.getElementById('m-qty');
        const list = document.getElementById('qty-options');
        const toggle = document.getElementById('qty-toggle');
        const arrow = toggle.querySelector('svg');
        list.innerHTML = Array.from({length: 10}, (_, i) => i + 1).map(num => `<li class="px-4 py-3 text-sm hover:bg-slate-50 cursor-pointer text-gray-700 border-b border-slate-50 last:border-none font-bold" data-val="${num}">${num}</li>`).join('');
        const toggleShow = (show) => { list.classList.toggle('hidden', !show); arrow.style.transform = show ? 'rotate(180deg)' : 'rotate(0deg)'; };
        input.addEventListener('focus', () => toggleShow(true));
        toggle.onclick = (e) => { e.stopPropagation(); toggleShow(list.classList.contains('hidden')); };
        list.querySelectorAll('li').forEach(li => { li.onclick = () => { input.value = li.dataset.val; toggleShow(false); }; });
        document.addEventListener('click', (e) => { if (!document.getElementById('qty-combobox')?.contains(e.target)) toggleShow(false); }, { once: true });
    }
    async function saveData() {
        try {
            const n = document.getElementById('m-t-l')?.value; 
            const pVal = document.getElementById('m-u-p')?.value; 
            const p = Number(pVal) || 0;
            if (!n) {
                showToast("è«‹è¼¸å…¥å•†å“åç¨±");
                return;
            }


            const isExp = (state.activeTab === 'expense' || document.getElementById('m-qty'));
            const key = isExp ? 'expenses' : 'wishlist';
            
            // --- é—œéµä¿®æ­£ï¼šè™•ç†åœ–ç‰‡ä¸Šå‚³ ---
            let finalImageUrl = state.tempImage; // å¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼ä¸”æ²’æ›åœ–ï¼Œä¿ç•™åŸç¶²å€
            if (state.tempImageBlob) {
                showToast("æ­£åœ¨ä¸Šå‚³åœ–ç‰‡...");
                if (state.editingId) { // æª¢æŸ¥ï¼šå¦‚æœæ˜¯ã€Œç·¨è¼¯æ¨¡å¼ã€ï¼Œä¸”åŸæœ¬å°±æœ‰åœ–ç‰‡ç¶²å€ï¼Œå‰‡å…ˆåˆªé™¤èˆŠåœ–
                    const oldItem = state[key].find(i => String(i.id) === state.editingId);
                    if (oldItem && oldItem.image) {
                        // ç•°æ­¥åˆªé™¤èˆŠåœ–ï¼Œä¸å¡ä½ä¸Šå‚³æµç¨‹
                        window.cloud.deleteFile(oldItem.image).then(res => {
                            console.log("èˆŠåœ–ç‰‡å·²æ¸…ç†:", oldItem.image);
                        });
                    }
                }
                const fileName = `${Date.now()}.jpg`;
                const uploadedUrl = await window.cloud.uploadFile(state.tempImageBlob, fileName);
                if (uploadedUrl) {
                    finalImageUrl = uploadedUrl;
                }
            }
            let item;
            const tags = window.getSmartTags ? window.getSmartTags() : [];
            let c, pf;
            if(state.enableExchange){
                c = document.getElementById('currency-select').value;
                pf = Number(document.getElementById('foreign-amount')?.value);
            }else{
                c='KRW';
                pf= 0;
            }
            if (isExp) { //æ¶ˆè²»æ¨¡å¼
                const dateVal = document.getElementById('m-date').value;
                const dateParts = dateVal ? dateVal.split('-') : [state.filterYear, state.filterMonth];
                const y = Number(dateParts[0]);
                const m = Number(dateParts[1]);
                const d = Number(dateParts[2]);
                const p = Number(document.getElementById('m-u-p').value) || 0;
                const q = Number(document.getElementById('m-qty').value) || 1;
                const s = Number(document.getElementById('m-shipping').value) || 0;

                const payM = document.getElementById('m-pay-method')?.value || 'å¾…ä»˜æ¬¾';
                const totalPrice = (p * q) + s;

                item = { 
                    id: state.editingId || String(Date.now()), 
                    type: state.tempType || 'expense', // expense æˆ– income
                    name: n, price: p, qty: q,shipping: s,
                    currency: c,foreign_amount: pf || '', 
                    total: state.tempType === 'income' ? (p * q) : (p * q + s), 
                    category: document.getElementById('m-cat').value, 
                    year: y, month: m,day:d || 1,
                    image: finalImageUrl, 
                    platform: document.getElementById('m-platform').value || '', 
                    arrivalStatus: document.getElementById('m-status').value, 
                    paymentMethod: payM,
                    paidAmount: payM === 'å·²ä»˜è¨‚é‡‘' ? (Number(document.getElementById('m-paid-amount').value) || 0) : totalPrice,
                    tags:tags,
                    remark: document.getElementById('m-remark').value || '' ,
                };
                item.total = (item.price * item.qty) + item.shipping;
            } else { //å¿ƒé¡˜æ¨¡å¼
                item = { 
                    id: state.editingId || String(Date.now()), name: n, 
                    price: p,
                    currency: c,foreign_amount: pf || '',
                    category: document.getElementById('m-wish-cat').value, 
                    releaseDate: document.getElementById('m-release-date').value, 
                    releaseTime: document.getElementById('m-release-time').value, 
                    remark: document.getElementById('m-remark').value || '', 
                    image: finalImageUrl
                };
            }

            // æ›´æ–° stateã€LocalStorage ä¸¦åŒæ­¥
            if (state.editingId) {
                const idx = state[key].findIndex(i => String(i.id) === state.editingId);
                if (idx !== -1) {
                    state[key][idx] = item;
                } else {
                    // å¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼ä½†åœ¨è©²æ¸…å–®æ‰¾ä¸åˆ°ï¼ˆä¾‹å¦‚å¾é¡˜æœ›è½‰éä¾†ï¼‰ï¼Œæ”¹ç”¨æ–°å¢
                    state[key].push(item);
                }
            } else {
                state[key].push(item);
            }

            // å„²å­˜è‡³æœ¬åœ° (ä¿®æ­£å¼•è™Ÿå•é¡Œ)
            localStorage.setItem(`fe_v11_${key}`, JSON.stringify(state[key]));
            // --- æ ¸å¿ƒä¿®æ­£ï¼šå¦‚æœæ˜¯å¾é¡˜æœ›è½‰éä¾†çš„ï¼Œåˆªé™¤è©²é¡˜æœ› ---
            if (isExp && state.wishSourceId) {
                state.wishlist = state.wishlist.filter(w => String(w.id) !== state.wishSourceId);
                localStorage.setItem('fe_v11_wishlist', JSON.stringify(state.wishlist));
                state.wishSourceId = null; // è™•ç†å®Œå¾Œæ¸…ç©º
            }

            // åŒæ­¥è‡³é›²ç«¯ (åŠ å…¥ await)
            if (window.cloud && typeof window.cloud.sync === 'function') {
                await window.cloud.sync(state.expenses, state.wishlist);
                // å­˜æª”å¾Œæ¸…é™¤æš«å­˜ Blob
                state.tempImageBlob = null;
            }
            if (isExp && state.activeTab !== 'expense') {
                state.activeTab = 'expense';
                // åŒæ­¥æ›´æ–°åº•éƒ¨å°è¦½åˆ—çš„é¡è‰²
                ['expense', 'report', 'wish', 'settings'].forEach(t => {
                    const el = document.getElementById(`tab-${t}`);
                    if (el) el.className = `flex-1 flex flex-col items-center gap-1 transition-colors ${state.activeTab === t ? 'tab-active' : 'text-gray-400'}`;
                });
            }
            closeModal(); 
            renderContent(); 
            showToast("å·²æˆåŠŸå„²å­˜ä¸¦åŒæ­¥");
        } catch (error) {
            console.error("å„²å­˜å¤±æ•—ï¼š", error);
            showToast("å„²å­˜ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥è¼¸å…¥å…§å®¹");
        }
    }

        /**
         * 6. å…¶å®ƒåŠŸèƒ½
         */
        // é»æ“Šåˆªé™¤æŒ‰éˆ•è§¸ç™¼
        async function handleDelete(e, type, id) {
            if (e) e.stopPropagation();
            
            // ä½¿ç”¨é€šç”¨å·¥å…·
            const confirmed = await askUser("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ", "ç´€éŒ„åˆªé™¤å¾Œå°‡ç„¡æ³•æ¢å¾©ã€‚", "ğŸ—‘ï¸");

            if (confirmed) {
                const key = type === 'expense' ? 'expenses' : 'wishlist';
                // 2. æ‰¾åˆ°è¦åˆªé™¤çš„é‚£ç­†è³‡æ–™ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰åœ–ç‰‡
                const itemToDelete = state[key].find(i => String(i.id) === String(id));
        
                // ç”¨window.cloud.deleteFileåˆªé™¤storageè³‡æ–™
                if (itemToDelete && itemToDelete.image) {
                    await window.cloud.deleteFile(itemToDelete.image);
                }

                // 4. åˆªé™¤æœ¬åœ°èˆ‡é›²ç«¯çš„æ–‡å­—ç´€éŒ„
                state[key] = state[key].filter(i => String(i.id) !== String(id));
                localStorage.setItem(`fe_v11_${key}`, JSON.stringify(state[key]));
                
                if (window.cloud) window.cloud.sync(state.expenses, state.wishlist);
                
                renderContent();
                showToast("å·²æˆåŠŸåˆªé™¤ç´€éŒ„");
            }
        }

        
        async function triggerDeleteFromAction() {
            const { type, id } = state.actionTarget;
            closeActionModal(); // å…ˆé—œé–‰æ“ä½œé¸å–®
            await handleDelete(null, type, id);
        }
      
        function updateFilter(k, v) { if (k === 'year') state.filterYear = Number(v); else state.filterMonth = Number(v); renderContent(); }
        async function handleImage(input) {
            if (!state.user) {
                showToast("è«‹å…ˆç™»å…¥ä»¥é–‹å•Ÿåœ–ç‰‡ä¸Šå‚³åŠŸèƒ½â˜ï¸");
                input.value = "";
                return;
            }
            const file = input.files[0];
            if (!file) {
                reportEvent('image_picker_error', {reason: 'empty_file',userAgent: navigator.userAgent})
                showToast('åœ–ç‰‡å–å¾—å¤±æ•—');
                return;
            }
            showToast("æ­£åœ¨è®€å–åœ–ç‰‡...");
        // 2. è™•ç† file.type ç‚ºç©ºçš„æƒ…æ³ (é‡å°éƒ¨åˆ† Android/OPPO ç³»çµ±)
            let isImage = false;
            if (file.type) {
                isImage = file.type.startsWith('image/');
            } else {
                // å¦‚æœç³»çµ±æ²’çµ¦ MIME typeï¼Œæ”¹ç”¨å‰¯æª”ååˆ¤æ–· (é˜²å‘†)
                const ext = file.name.split('.').pop().toLowerCase();
                isImage = ['jpg', 'jpeg', 'png', 'webp', 'heic'].includes(ext);
            }

            if (!isImage) {
                showToast("ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼Œè«‹é¸æ“‡åœ–ç‰‡æª”");
                input.value = ""; // æ¸…ç©ºé¸å–
                return;
            }
            // 3. æª¢æŸ¥æª”æ¡ˆå¤§å° (è¶…é 15MB é è­¦)
            if (file.size > 15 * 1024 * 1024) {
                showToast("åœ–ç‰‡å¤ªå¤§å›‰ï¼è«‹é¸æ“‡è¼ƒå°çš„ç…§ç‰‡");
                input.value = "";
                return;
            }
            if (file) {
                const reader = new FileReader();
                // æª”æ¡ˆè®€å–å¤±æ•—çš„è™•ç†
                reader.onerror = () => {
                    showToast("æª”æ¡ˆè®€å–ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦");
                    input.value = "";
                };
                reader.onload = async (e) => {
                    try {
                        const compressionWidth = file.size > 2 * 1024 * 1024 ? 500 : 800;
                        const compressedBase64 = await compressImage(e.target.result, compressionWidth);
                        
                        if (!compressedBase64) throw new Error("å£“ç¸®å¤±æ•—");

                        // æ›´æ–° UI é è¦½
                        const placeholder = document.getElementById('img-placeholder');
                        if (placeholder) {
                            placeholder.innerHTML = `<img src="${compressedBase64}" class="w-full h-full object-cover">`;
                        }

                        // å°‡ Base64 è½‰æ›ç‚º Blob æº–å‚™ä¸Šå‚³
                        const response = await fetch(compressedBase64);
                        if (!response.ok) throw new Error("è½‰æ›å¤±æ•—");
                        
                        state.tempImageBlob = await response.blob(); 
                        state.tempImage = null; // æ¸…é™¤èˆŠç¶²å€ç´€éŒ„
                        showToast("åœ–ç‰‡ä¸Šå‚³æˆåŠŸ");

                    } catch (error) {
                        console.error("Image processing error:", error);
                        showToast("åœ–ç‰‡è™•ç†å¤±æ•—ï¼Œè«‹æ›ä¸€å¼µè©¦è©¦");
                        // é‡ç½®ç‹€æ…‹
                        state.tempImageBlob = null;
                        document.getElementById('img-placeholder').innerHTML = `<span class="text-slate-300 text-[10px] font-bold uppercase tracking-widest">ä¸Šå‚³ç›¸ç‰‡</span>`;
                        input.value = "";
                    }
                };
                reader.readAsDataURL(file);
            }
        }
        function openLightbox(url, name, sub) { const overlay = document.getElementById('lightbox-overlay'); const img = document.getElementById('lightbox-img'); document.getElementById('lightbox-name').textContent = name; document.getElementById('lightbox-sub').textContent = sub; img.src = url; overlay.classList.remove('hidden'); }
        function closeLightbox() { document.getElementById('lightbox-overlay').classList.add('hidden'); }

        function calculateReportRange() {
            let start, end, label; const now = new Date();
            if (state.reportRange === 'month') { start = new Date(now.getFullYear(), now.getMonth() + state.reportOffset, 1); end = new Date(start.getFullYear(), start.getMonth() + 1, 0); label = `${start.getFullYear()} å¹´ ${start.getMonth() + 1} æœˆ`; }
            else if (state.reportRange === '6months') { end = new Date(now.getFullYear(), now.getMonth() + state.reportOffset + 1, 0); start = new Date(end.getFullYear(), end.getMonth() - 5, 1); label = `${start.getFullYear()}.${start.getMonth()+1} ï½ ${end.getFullYear()}.${end.getMonth()+1}`; }
            else { start = new Date(now.getFullYear() + state.reportOffset, 0, 1); end = new Date(start.getFullYear(), 11, 31); label = `${start.getFullYear()} å¹´åº¦å ±å‘Š`; }
            return { start, end, label };
        }

        function initChart(stats) {
            const ctx = document.getElementById('donutChart'); if (!ctx) return;
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, { type: 'doughnut', data: { labels: stats.map(s => s.id), datasets: [{ data: stats.map(s => s.amount), backgroundColor: stats.map(s => s.color), borderWidth: 0 }] }, options: { cutout: '75%', plugins: { legend: { display: false } } } });
        }

        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            const headers = Object.values(excelHeaderMap);
            //const rows = state.expenses.map(i => { return Object.keys(excelHeaderMap).map(engKey => { let val = i[engKey]; if (engKey === 'tags' && Array.isArray(val)) return val.join(','); return (val !== undefined && val !== null) ? val : ""; }); });
            const sortedExpenses = [...state.expenses].sort((a, b) =>
                Number(a.year) - Number(b.year) ||
                Number(a.month) - Number(b.month) ||
                Number((a.day ?? 1)) - Number((b.day ?? 1)) ||
                Number(a.id) - Number(b.id)
            );
            const rows = sortedExpenses.map(i => { 
                return Object.keys(excelHeaderMap).map(engKey => { 
                    let val = i[engKey]; 
                    if (engKey === 'type') {
                        return (val === 'income') ? 'å”®å‡º' : 'æ”¯å‡º';
                    }
                    if (engKey === 'day' && val == null) {
                        val=1;
                    }
                    // å¦‚æœæ¬„ä½æ˜¯æ¨™ç±¤ä¸”ç‚ºé™£åˆ—ï¼Œå‰‡ç”¨é€—è™Ÿåˆä½µç‚ºå­—ä¸²
                    if (engKey === 'tags' && Array.isArray(val)) return val.join(', '); 
                    if (engKey === 'paidAmount') {
                        if (i.paymentMethod !== 'å·²ä»˜è¨‚é‡‘') {
                            return i.total;
                        }
                    };
                    return (val !== undefined && val !== null) ? val : ""; 
                }); 
            });
            const wsExp = XLSX.utils.aoa_to_sheet([headers, ...rows]);
            XLSX.utils.book_append_sheet(wb, wsExp, "æ¶ˆè²»æ¸…å–®");
            XLSX.writeFile(wb, `è¿½æ˜Ÿè¨˜å¸³_å‚™ä»½_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        async function importFromExcel(input) {
        const file = input.files[0];
        if (!file) return;
        const confirmed = await askUser(
            "ç¢ºå®šè¦åŒ¯å…¥è³‡æ–™å—ï¼Ÿ", 
            "æ³¨æ„ï¼šåŒ¯å…¥ Excel æœƒã€Œå®Œå…¨è¦†è“‹ã€ç›®å‰çš„æ¶ˆè²»æ¸…å–®ï¼ŒåŸæœ¬çš„èˆŠè³‡æ–™å°‡æœƒæ¶ˆå¤±ã€‚å»ºè­°åŒ¯å…¥å‰å…ˆåŸ·è¡Œä¸€æ¬¡åŒ¯å‡ºå‚™ä»½ã€‚", 
            "âš ï¸"
        );

        // 2. å¦‚æœä½¿ç”¨è€…é»æ“Šå–æ¶ˆï¼Œå‰‡æ¸…ç©ºè¼¸å…¥æ¡†ä¸¦ä¸­æ–·åŸ·è¡Œ
        if (!confirmed) {
            input.value = "";
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                if (!workbook.SheetNames.includes("æ¶ˆè²»æ¸…å–®")) {
                    showToast("æ‰¾ä¸åˆ°ã€Œæ¶ˆè²»æ¸…å–®ã€å·¥ä½œè¡¨");
                    return;
                }

                const worksheet = workbook.Sheets["æ¶ˆè²»æ¸…å–®"];
                const aoa = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                if (aoa.length < 1) {
                    showToast("æª”æ¡ˆç‚ºç©º");
                    return;
                }

                const fileHeaders = aoa[0].map(h => String(h || "").trim());
                const nameIdx = fileHeaders.indexOf("é …ç›®åç¨±");
                if (nameIdx === -1) {
                    showToast("æ‰¾ä¸åˆ°ã€Œé …ç›®åç¨±ã€æ¬„ä½");
                    return;
                }

                // æº–å‚™é è¨­å€¼
                const now = new Date();
                const defaultYear = now.getFullYear();
                const defaultMonth = now.getMonth();//å‰ä¸€å€‹æœˆ
                const defaultDay = 1;

                const importedData = [];

                for (let r = 1; r < aoa.length; r++) {
                    const row = aoa[r];
                    if (!row[nameIdx]) continue; // å¦‚æœæ²’æœ‰é …ç›®åç¨±å‰‡è·³é

                    let item = { id: String(Date.now() + r), image: null };

                    Object.keys(excelHeaderMap).forEach(engKey => {
                        const chiKey = excelHeaderMap[engKey];
                        const colIdx = fileHeaders.indexOf(chiKey);
                        let val = colIdx > -1 ? row[colIdx] : undefined;

                        // æª¢æŸ¥å€¼æ˜¯å¦æœ‰æ•ˆï¼ˆéç©ºä¸”é undefinedï¼‰
                        const isEmpty = (val === undefined || val === null || String(val).trim() === "");
                        if (engKey === 'type') {
                            const typeStr = String(val || "").trim();
                            if (typeStr === 'å”®å‡º' || typeStr === 'income') {
                                item[engKey] = 'income';
                            } else {
                                item[engKey] = 'expense';
                            }
                        }
                        else if (engKey === 'tags') {
                            item[engKey] = isEmpty ? [] : String(val).split(',').map(t => t.trim());
                        } 
                        else if (engKey === 'qty') {// æ•¸é‡é è¨­ç‚º 1
                            item[engKey] = isEmpty ? 1 : (Number(val) || 1);
                        } 
                        else if (engKey === 'year') {// å¹´ä»½é è¨­ç‚ºç•¶å‰å¹´ä»½
                            item[engKey] = isEmpty ? defaultYear : Number(val);
                        } 
                        else if (engKey === 'month') { // ç„¡æœˆä»½å‰‡é è¨­ç‚ºå‰ä¸€å€‹æœˆ
                            item[engKey] = isEmpty ? defaultMonth : Number(val);
                        } 
                        else if (engKey === 'day') {
                            item[engKey] = isEmpty ? defaultDay : Number(val);
                        } 
                        else if (engKey === 'category') { // åˆ†é¡é è¨­
                            item[engKey] = isEmpty ? "å°ˆè¼¯" : String(val).trim();
                        } 
                        else if (engKey === 'arrivalStatus') {// åˆ°è²¨ç‹€æ…‹é è¨­
                            item[engKey] = isEmpty ? "å·²åˆ°è²¨" : String(val).trim();
                        } 
                        else if (engKey === 'paymentMethod') { // ä»˜æ¬¾æ–¹å¼é è¨­
                            item[engKey] = isEmpty ? "åŒ¯æ¬¾å…¨é¡" : String(val).trim();
                        } 
                        else if (['price', 'paidAmount','shipping'].includes(engKey)) {// é‡‘é¡é¡é è¨­ç‚º 0
                            item[engKey] = Number(val) || 0;
                        } 
                        else {// å…¶ä»–å­—ä¸²æ¬„ä½
                            item[engKey] = isEmpty ? "" : String(val).trim();
                        }
                    });
                    item.total =(Number(item.price) * Number(item.qty)) + Number(item.shipping);
                    if (item.paymentMethod !== 'å·²ä»˜è¨‚é‡‘') {
                        item.paidAmount = item.total; // éè¨‚é‡‘åˆ¶å‰‡è¦–ç‚ºå…¨é¡ä»˜æ¸…
                    }
                    importedData.push(item);
                }

                if (importedData.length > 0) {
                    state.expenses = importedData;
                    localStorage.setItem('fe_v11_expenses', JSON.stringify(state.expenses));
                    if (window.cloud) window.cloud.sync(state.expenses, state.wishlist);
                    renderContent();
                    showToast(`åŒ¯å…¥æˆåŠŸï¼šå…± ${importedData.length} ç­†ï¼Œè‹¥ç„¡å¡«å¯«æ—¥æœŸè«‹æŸ¥çœ‹ä¸Šå€‹æœˆçš„æ¶ˆè²»æ¸…å–®`);
                }
            } catch (err) {
                console.error(err);
                showToast("æª”æ¡ˆæ ¼å¼éŒ¯èª¤");
            }
        };
        reader.readAsArrayBuffer(file);
        input.value = "";
    }
    async function runStorageCleanup() {
        // 1. è©¢å•ä½¿ç”¨è€…
        const confirmed = await askUser("å•Ÿå‹•æ·±å±¤æ¸…ç†ï¼Ÿ", "æ­£åœ¨å„ªåŒ–é›²ç«¯ç©ºé–“ï¼Œå®‰å…¨ç§»é™¤é‡è¤‡æˆ–å¤±æ•ˆçš„åœ–æª”ã€‚é€™éœ€è¦ä¸€é»æ™‚é–“ï¼Œè«‹æ”¾å¿ƒï¼Œæ‚¨çš„æ‰€æœ‰ç´€éŒ„èˆ‡ç›¸ç‰‡éƒ½æœƒå¦¥å–„ä¿ç•™ã€‚", "ğŸ§¹");
        if (!confirmed) return;

        showToast("æ­£åœ¨æƒæé›²ç«¯æª”æ¡ˆ...");

        // 2. æ”¶é›†ç›®å‰æ‰€æœ‰ç´€éŒ„ä¸­æ­£åœ¨ä½¿ç”¨çš„åœ–ç‰‡ç¶²å€
        const activeUrls = [
            ...state.expenses.map(ex => ex.image),
            ...state.wishlist.map(w => w.image)
        ].filter(url => url); // ç§»é™¤ç©ºå€¼

        // 3. åŸ·è¡Œæ¸…ç†
        const count = await window.cloud.cleanupOrphanedFiles(activeUrls);

        if (count > 0) {
            showToast(`æ¸…ç†å®Œæˆï¼å…±åˆªé™¤äº† ${count} å€‹å†—é¤˜åœ–æª”`);
        } else if (count === 0) {
            showToast("é›²ç«¯éå¸¸æ•´æ½”ï¼Œæ²’æœ‰éœ€è¦æ¸…ç†çš„æª”æ¡ˆ");
        } else {
            showToast("æ¸…ç†éç¨‹ç™¼ç”ŸéŒ¯èª¤");
        }
    }

        window.onload = () => { applyTheme(state.themeColor); switchTab('expense'); initSwipeToClose(); if (state.enableExchange){fetchRates()};};
    </script>
    <script>// å®šç¾©é è¨­æ¨™ç±¤
        const PREDEFINED_TAGS = ["å¾…äºŒè£œ", "ä¸é ˆäºŒè£œ", "ç·šä¸Šè³¼è²·", "ç·šä¸‹è³¼è²·", "SEVENTEEN"];
        // åˆå§‹åŒ–æ™ºæ…§æ¨™ç±¤
        function initSmartTags(initialTags = []) {
            const container = document.getElementById('m-tag-container');
            const input = document.getElementById('m-tag-input');
            const suggestionsList = document.getElementById('m-tag-suggestions');
            if (!container || !input) return () => [];

            let selectedTags = Array.isArray(initialTags) ? [...initialTags] : [];

            const renderChips = () => {
                container.querySelectorAll('.tag-chip').forEach(el => el.remove());
                selectedTags.forEach((tag, index) => {
                    const chip = document.createElement('div');
                    chip.className = 'tag-chip flex items-center bg-slate-100 text-brand px-2 py-1 rounded-lg text-xs font-bold';
                    chip.innerHTML = `${tag}<span class="ml-1 cursor-pointer hover:text-red-500" onclick="event.stopPropagation(); window.removeSmartTag(${index})">âœ•</span>`;
                    container.insertBefore(chip, input);
                });
            };

            window.removeSmartTag = (index) => {
                selectedTags.splice(index, 1);
                renderChips();
            };

            const addSmartTag = (content) => {
                const clean = content.replace(/[,ï¼Œ]/g, '').trim();
                if (clean && !selectedTags.includes(clean)) {
                    selectedTags.push(clean);
                    renderChips();
                }
                input.value = '';
                suggestionsList.classList.add('hidden');
            };

            window.addSmartTagByClick = (val) => addSmartTag(val);
            // ç›£è½è¼¸å…¥è¡Œç‚ºï¼šè™•ç†é€—è™Ÿèˆ‡å»ºè­°æ¸…å–®
            input.addEventListener('input', (e) => {
                const val = e.target.value;
                // 1. åµæ¸¬é€—è™Ÿè‡ªå‹•åŠ å…¥
                if (val.endsWith(',') || val.endsWith('ï¼Œ')) {
                    addSmartTag(val);
                    return;
                }
                // 2. é¡¯ç¤ºå»ºè­°æ¸…å–® (PREDEFINED_TAGS é‚è¼¯)
                const query = val.trim();
                if (!query) {
                    suggestionsList.classList.add('hidden');
                    return;
                }
                const dynamicPool = [...new Set(state.expenses.flatMap(ex => ex.tags || []))];
                // åˆä½µé è¨­æ¨™ç±¤èˆ‡å¾æ¶ˆè²»ç´€éŒ„ä¸­æå–çš„æ¨™ç±¤
                const combinedPool = [...new Set([...PREDEFINED_TAGS, ...dynamicPool])];
                const matches = combinedPool.filter(t => 
                    t.toLowerCase().includes(query.toLowerCase()) && !selectedTags.includes(t)
                );
                if (matches.length > 0) {  
                    suggestionsList.innerHTML = matches.map(m => {
                        const isDynamic = !PREDEFINED_TAGS.includes(m);
                        return `<li class="px-4 py-3 hover:bg-slate-50 cursor-pointer text-sm text-gray-700 border-b border-slate-50 last:border-0 font-medium flex justify-between items-center" onclick="window.addSmartTagByClick('${m}')">
                            <span>${m.replace(new RegExp(`(${query})`, 'gi'), `<span class="text-brand font-bold">$1</span>`)}</span>
                            ${isDynamic ? '<span class="text-[9px] text-slate-300 italic">å·²ä½¿ç”¨é</span>' : ''}
                        </li>`;
                    }).join('');
                    suggestionsList.classList.remove('hidden');
                } else {
                    suggestionsList.classList.add('hidden');
                }
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addSmartTag(input.value);
                } else if (e.key === 'Backspace' && !input.value && selectedTags.length > 0) {
                    selectedTags.pop();
                    renderChips();
                }
            });
            // é»æ“Šå¤–éƒ¨é—œé–‰å»ºè­°
            document.addEventListener('click', (e) => {
                if (!container.contains(e.target)) suggestionsList.classList.add('hidden');
            });

            renderChips();
            return () => selectedTags; 
        }

   
        </script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js')
            .then(() => console.log('Service Worker registered'))
            .catch(err => console.error('SW registration failed:', err));
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js"></script>

    <script>
        function showShareConfirm() {
            document.getElementById('share-confirm-overlay').classList.remove('hidden');
        }

        function startShareGeneration() {
            document.getElementById('share-confirm-overlay').classList.add('hidden');
            drawShareCard();
        }
        const base64Cache = new Map();
        const finalCardCache = new Map();
        const ENGLISH_MONTHS = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        /** * 1. åœ–ç‰‡è™•ç†ï¼šç¸®åœ–å¿«å– */
        async function getSafeBase64(url) {
            if (!url) return null;
            if (base64Cache.has(url)) return base64Cache.get(url);
            
            try {
                if (url.startsWith('data:')) return url;
                const response = await fetch(url, { mode: 'cors' });
                if (!response.ok) throw new Error('Fetch failed');
                const blob = await response.blob();
                const shrunkBase64 = await shrinkImage(blob, 400); 
                base64Cache.set(url, shrunkBase64);
                return shrunkBase64;
            } catch (err) {
                console.warn("è®€å–å¤±æ•—:", url);
                return null; 
            }
        }

        function shrinkImage(blob, targetSize) {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.src = URL.createObjectURL(blob);
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const scale = targetSize / Math.max(img.width, img.height);
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const result = canvas.toDataURL('image/jpeg', 0.8);
                    URL.revokeObjectURL(img.src);
                    resolve(result);
                };
            });
        }

        /**
         * 2. ç”Ÿæˆåˆ†äº«å¡ (æ™ºæ…§å¿«å–å„ªåŒ–ç‰ˆ)
         * @param {boolean} force - æ˜¯å¦å¼·åˆ¶æ¸…é™¤å¿«å–ä¸¦é‡æ–°ç¹ªè£½
         */
        async function drawShareCard(forceRandom = false) {
            const modal = document.getElementById('share-modal');
            const resultBox = document.getElementById('share-result-container');
            const grid = document.getElementById('share-photo-grid');
            
            // A. è¨ˆç®—è³‡æ–™æŒ‡ç´‹ (Fingerprint)
            //const currentMonthItems = state.expenses.filter(ex => ex.type !== 'income' && ex.year === state.filterYear && ex.month === state.filterMonth);
            //const total = currentMonthItems.reduce((s, i) => s + (Number(i.total || i.amount) || 0), 0);
            // --- æ™ºæ…§æ™‚é–“ç¯©é¸ (åŒ…å«ä¸é™æœˆä»½/å¹´ä»½é‚è¼¯) ---
            const currentMonthItems = state.expenses.filter(ex => {
                const typeMatch = ex.type !== 'income';
                const yearMatch = state.filterYear === 0 || Number(ex.year) === state.filterYear;
                const monthMatch = state.filterMonth === 0 || Number(ex.month) === state.filterMonth;
                return typeMatch && yearMatch && monthMatch;
            });
            const totalExp = currentMonthItems.filter(i => i.type !== 'income').reduce((sum, i) => sum + i.total, 0);
            const totalInc = currentMonthItems.filter(i => i.type === 'income').reduce((sum, i) => sum + i.total, 0);
            const total = totalExp - totalInc;
            const photoItems = currentMonthItems.filter(i => i.image).slice(0, 9);
            
            // é—œéµå„ªåŒ–ï¼šCache Key åŒ…å«åœ–ç‰‡ URLï¼Œç¶²å€ä¸€æ›å¿«å–å°±è‡ªå‹•å¤±æ•ˆ
            const imagesFingerprint = photoItems.map(i => i.image).join('|');
            const cacheKey = `${state.filterYear}-${state.filterMonth}-${currentMonthItems.length}-${total}-${imagesFingerprint}`;

           // C. æª¢æŸ¥å¿«å–
            if (!forceRandom && finalCardCache.has(cacheKey)) {
                modal.classList.remove('hidden');
                resultBox.innerHTML = `<img src="${finalCardCache.get(cacheKey)}" class="w-full h-auto rounded-[2.5rem] shadow-2xl animate-card">`;
                document.getElementById('download-trigger').onclick = () => {
                    const link = document.createElement('a');
                    link.download = `Report_${state.filterYear}_${state.filterMonth}.png`;
                    link.href = cachedDataUrl;
                    link.click();
                };               
                return;
            }

            // D. ç¹ªè£½æµç¨‹
            modal.classList.remove('hidden');
            resultBox.innerHTML = `
                <div class=" h-[70vh] flex items-center justify-center p-10 text-center">
                    <div>
                    <div class="w-12 h-12 border-4 border-brand border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                    <p class="text-slate-400 text-sm font-bold tracking-widest uppercase italic">ç”Ÿæˆåœ–ç‰‡ä¸­...</p>
                    <p class="text-slate-400 text-xs tracking-widest ">é è¨ˆæœƒèŠ±5~10ç§’</p>
                    </div>
                </div>`;

            const base64Photos = await Promise.all(photoItems.map(async (item) => {
                return await getSafeBase64(item.image);
            }));
            // æ›´æ–° DOM å…§å®¹
            //document.getElementById('share-title').textContent = `${state.filterYear}.${String(state.filterMonth).padStart(2, '0')}`;
            //document.getElementById('share-total').textContent = `$${total.toLocaleString()}`;
            // --- æ›´æ–°æ¨™é¡Œï¼šè‹±æ–‡æœˆä»½ ---
            if (state.filterMonth === 0) { //æœˆä»½é¸ä¸é™
                const yearName = state.filterYear === 0 ? "ALL-TIME" : state.filterYear;
                document.getElementById('share-title').textContent = "ANNUAL";
                document.getElementById('share-title-sub').textContent = `${yearName}`;
            } else {
                const monthName = ENGLISH_MONTHS[state.filterMonth - 1] || "MONTH";
                document.getElementById('share-title').textContent = `${monthName}`;
                document.getElementById('share-title-sub').textContent = `${state.filterYear}`;
            }

            // --- éš¨æ©Ÿäººæ ¼é‚è¼¯ ---
            const categoryPrefixTemplates = {
                'å°ˆè¼¯': ['{tag}å°ˆè¼¯æ§','éŸ³æ¨‚å®ˆè­·è€…','å¯¦é«”CDåŸ·å¿µè€…','éŠ·é‡è²¢ç»å¤§æˆ¶'],
                'å°å¡': ['{tag}å°å¡ç‹‚ç†±è€…','å°å¡æ„›å¥½è€…','å¡ç‰‡è’é›†ç‹‚','è¿·ä½ æ”¶è—å®¶','å¡å†Šå»ºç¯‰å¤§å¸«'],
                'æ¼”å”±æœƒ / è¦‹é¢æœƒé–€ç¥¨': ['æ¶ç¥¨æˆ°ç¥','é–€ç¥¨å¯Œç¿','èˆå°è¿½å°‹è€…', 'æ’éšŠå°ˆæ¥­æˆ¶'],
                'å‘¨é‚Šå•†å“': ['{tag}å‘¨é‚Šæ§','å¯¦é«”æ”¶è—é”äºº'],
                'å¨ƒå¨ƒ': ['{tag}å¨ƒå¨ƒè¦ªåª½','å¨ƒå¨ƒå®ˆè­·è€…','èŒç‰©æ”¶è—å®¶'],

                'æ¼«ç•« / è¼•å°èªª': ['{tag}æ›¸æ¶ç ´å£è€…', 'ç²¾ç¥ç³§é£Ÿç³§å€‰ä¸»', 'äºŒæ¬¡å…ƒä½æ°‘'],
                'ç«‹ç‰Œ / åŠé£¾': ['{tag}ç¥å£‡å»ºç¯‰å¸«', 'å£“å…‹åŠ›å®ˆè­·éˆ', 'æ¡Œé¢ç©ºé–“ä¾µå è€…', 'å£“å…‹åŠ›æ”¶è—å®¶'],
                'å°å¡ / è‰²ç´™': ['{tag}ç´™ç‰‡äººä»£è³¼å•†', 'å¡å†Šå»ºç¯‰å¤§å¸«','è‰²ç´™å±•ç¤ºç‹‚'],
                'æ˜ä¿¡ç‰‡ / æµ·å ±': ['{tag}ç‰†é¢ç²‰åˆ·åŒ ', 'å¹³é¢ç¾å­¸ç›£è£½', 'è¦–ç·šæ•æ‰è€…'],
                'å¾½ç«  / å£“å…‹åŠ›': ['{tag}ç—›åŒ…é‡é‡æ“”ç•¶', 'é‡‘å±¬æ’æ“Šæ„›å¥½è€…', 'é–ƒäº®äº®æœåˆ®è€…','åˆ¥é‡å—é›£è€…'],
                'å…¬ä»” / å¨ƒå¨ƒ': ['{tag}æ£‰èŠ±å¨ƒè¦ªåª½', 'å¨ƒå¨ƒå®ˆè­·è€…', 'èŒç‰©æ”¶è—å®¶'],
            };

            const getSuffixByAmount = (amount) => {
                if (amount === 0) return 'ç´”æ„›æˆ°å£«(é›¶æˆæœ¬ç‰ˆ)';
                if (amount < 1000) return 'ç´”æ„›æˆ°å£«';
                if (amount < 1500) return 'ç†æ€§å°ç²‰çµ²';
                if (amount < 2000) return 'å¿«æ¨‚å°ç²‰çµ²';
                if (amount < 3000) return 'ç²¾ç¥ç³§é£Ÿæ„›å¥½è€…';
                if (amount < 4000) return 'å­˜æ‘ºç¸®æ°´è­¦å‘Šä¸­';
                if (amount < 4500) return 'ææ¬¾æ©Ÿç²¾éˆ';
                if (amount < 5000) return 'å°ˆæ¥­å‘¨é‚Šçµäºº';
                if (amount < 5500) return 'è¡Œèµ°çš„å‘¨é‚Šæ”¶å‰²æ©Ÿ';
                if (amount < 6000) return 'çª®åˆ°åƒåœŸçš„å¿«æ¨‚äººğŸ›–';
                if (amount < 7000) return 'MBTIæ˜¯ATMğŸ’¸';
                if (amount < 8000) return 'ç‚ºäº†æ­çˆ¸å‘¼å¸çš„ATM';
                if (amount < 8500) return 'ç ´ç”¢ç¾å­¸å¯¦è¸è€…ğŸšï¸';
                if (amount < 9000) return 'å¶åƒçš„ç¥ä»™æ•™æ¯';
                if (amount < 10000) return 'ç²‰çµ²éŠ€è¡Œè‘£äº‹ğŸ¦';
                if (amount < 20000) return 'ç¶“ç´€å…¬å¸å†ç”Ÿçˆ¶æ¯ğŸ’°';
                if (amount < 30000) return 'ç¶“ç´€å…¬å¸æ¦®è­½è‘£äº‹';
                return 'å¶åƒèƒŒå¾Œçš„éš±å½¢é‡‘ä¸»ğŸ‘‘';
            };

            const getPrefixByExpenses = (expenses) => {
                if (!expenses.length) return 'å¿«æ¨‚è¿½æ˜Ÿæ—';
                const categorySum = {};
                const categoryTagMap = {};
                expenses.forEach(e => {
                    categorySum[e.category] = (categorySum[e.category] || 0) + (Number(e.total) || 0);
                    const tag = (Array.isArray(e.tags) && e.tags.length > 0) ? e.tags[0] : '';
                    if (tag) {
                        categoryTagMap[e.category] = categoryTagMap[e.category] || {};
                        categoryTagMap[e.category][tag] = (categoryTagMap[e.category][tag] || 0) + 1;
                    }
                });
                const topCategory = Object.entries(categorySum).sort((a,b)=>b[1]-a[1])[0][0];
                const topTagObj = categoryTagMap[topCategory] || {};
                const topTag = Object.entries(topTagObj).sort((a,b)=>b[1]-a[1])[0]?.[0] || '';
                const templates = categoryPrefixTemplates[topCategory] || ['è¿½æ˜Ÿç©å®¶'];
                let chosen = templates[Math.floor(Math.random() * templates.length)];
                return chosen.replace('{tag}', topTag);
            };
            const prefix = getPrefixByExpenses(currentMonthItems);
            const suffix = getSuffixByAmount(total);
            document.getElementById('share-personality').textContent = `${prefix}ï½œ${suffix}`;

            // å¼·åˆ¶å¡«å……è‡³ 9 å€‹æ ¼å­ï¼Œä¸è¶³çš„ç•™ç™½
            grid.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const b64 = base64Photos[i];
                const slot = document.createElement('div');
                // æ ¼å­é–“è·èˆ‡åœ“è§’æ”¾å¤§ä»¥åŒ¹é… 1080p
                slot.className = 'aspect-square bg-white/10 rounded-[45px] overflow-hidden border-2 border-white/20 shadow-xl';
                if (b64) {
                    slot.innerHTML = `<img src="${b64}" class="w-full h-full object-cover">`;
                } else {
                    // å‰©é¤˜ç•™ç™½è™•ç† (é¡¯ç¤ºé€æ˜èƒŒæ™¯ Slot)
                    slot.innerHTML = `<div class="w-full h-full"></div>`;
                }
                grid.appendChild(slot);
            }

            requestAnimationFrame(async () => {
                try {
                    const node = document.getElementById('share-card');
                    await document.fonts.ready;
                    // åŸ·è¡Œæ“·å–ï¼ŒpixelRatio è¨­ç‚º 1 å› ç‚º DOM å·²ç¶“æ˜¯ 1080px
                    const dataUrl = await htmlToImage.toPng(node, { 
                        width: 1080, 
                        height: 1920,
                        pixelRatio: 1, 
                        cacheBust: true,
                        fontEmbedCSS: ""
                    });
                    
                    finalCardCache.set(cacheKey, dataUrl);
                    
                    resultBox.innerHTML = `<img src="${dataUrl}" class="w-full h-full shadow-2xl animate-card">`;
                    document.getElementById('download-trigger').onclick = () => {
                        const link = document.createElement('a');
                        link.download = `Report_${state.filterYear}_${state.filterMonth}.png`;
                        link.href = dataUrl;
                        link.click();
                    };
                } catch (err) {
                    showToast("ç”Ÿæˆå¤±æ•—");
                    modal.classList.add('hidden');
                }
            });
        }

    </script>
</body>
</html>