<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- PWA ç›¸é—œæ¨™ç±¤ -->
    <meta name="theme-color" content="#92A8D1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="è¿½æ˜ŸéŒ¢åŒ…">
    <link rel="manifest" href="./manifest.json">
    <title>è¿½æ˜ŸéŒ¢åŒ…-è¨˜éŒ„ä½ çš„è¿½æ˜Ÿæ¶ˆè²»</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        :root {
            --brand-color: #92A8D1; 
            --brand-gradient: linear-gradient(135deg, #F7CAC9 0%, #92A8D1 100%);
            --app-bg: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --border-color: #f1f5f9;
        }

        body.dark-mode {
            --app-bg: #1a1a1a;
            --card-bg: #282828;
            --text-main: #ffffffe8;
            --text-sub: #94a3b8;
            --border-color: #2d2d2d;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--app-bg);
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s, color 0.3s;
        }

        .bg-brand { background: var(--brand-gradient) !important; }
        .text-brand { color: var(--brand-color) !important; }
        .tab-active { color: var(--brand-color) !important; font-weight: 900; }
        
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-enter { animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        .card-shadow { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); }
        body.dark-mode .card-shadow { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4); }

        .status-unArrived { background-color: #fee2e2; color: #ef4444; }
        .status-toShip { background-color: #fef3c7; color: #d97706; }
        .status-received { background-color: #dcfce7; color: #16a34a; }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none !important;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield !important;
            appearance: none !important;
        }

        .chip {
            flex-shrink: 0; padding: 6px 14px; border-radius: 12px; font-size: 11px;
            font-weight: 600; transition: all 0.2s; cursor: pointer;
            border: 1px solid var(--border-color); background-color: var(--card-bg); color: var(--text-sub);
        }
        .chip.active-tag { background: var(--brand-gradient) !important; color: #fff !important; border-color: transparent !important; }
        .report-range-btn.active { background: var(--brand-gradient); color: white; }
        
        .color-preset { width: 42px; height: 42px; border-radius: 50%; cursor: pointer; border: 2px solid #e2e8f0; transition: all 0.2s; }
        .color-preset.active { border-color: #fff !important; outline: 3px solid var(--brand-color); }
        .photo-tab.active { border-bottom: 3px solid var(--brand-color); color: var(--brand-color); font-weight: 900; }

        body.dark-mode .bg-white { background-color: var(--card-bg) !important; }
        body.dark-mode .text-slate-800, body.dark-mode .text-gray-800 { color: #ffffffe8 !important; }
        body.dark-mode .text-slate-700, body.dark-mode .text-gray-700,body.dark-mode .text-slate-400 { color: #e9e9e9 !important; }
        body.dark-mode .text-slate-500 { color: #fcfcfc !important; }
        body.dark-mode .bg-slate-100 { background-color: #1a1a1a !important; }
        body.dark-mode .bg-slate-50 { background-color: #363636 !important; }
        body.dark-mode .border-gray-100 { border-color: #282828 !important; }

        #toast {
            visibility: hidden; min-width: 200px; background-color: rgba(30, 41, 59, 0.95);
            color: #fff; text-align: center; border-radius: 16px; padding: 12px 24px;
            position: fixed; z-index: 999; left: 50%; bottom: 100px; transform: translateX(-50%);
            font-size: 14px; font-weight: 600; backdrop-filter: blur(8px); opacity: 0;
            transition: all 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 120px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <main id="main-content" class="flex-grow overflow-y-auto no-scrollbar pb-32"></main>
    <div id="toast">æç¤ºè¨Šæ¯</div>
    <button id="fab" onclick="openAddModal()" class="bg-brand fixed bottom-28 right-6 w-14 h-14 text-white rounded-full flex items-center justify-center text-3xl shadow-lg z-40 transition-transform active:scale-90">ï¼‹</button>

    <!-- åº•éƒ¨å°è¦½ -->
    <footer class="fixed bottom-0 w-full bg-white backdrop-blur-md border-t border-gray-100 flex justify-around items-center h-20 safe-area-bottom z-50 px-2 shadow-[0_-4px_10px_rgba(0,0,0,0.03)]">
        <button onclick="switchTab('expense')" id="tab-expense" class="flex-1 flex flex-col items-center gap-1 text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 012-2h2a2 2 0 012 2" stroke-width="2"/></svg>
            <span class="text-[10px] font-bold">æ¶ˆè²»æ¸…å–®</span>
        </button>
        <button onclick="switchTab('report')" id="tab-report" class="flex-1 flex flex-col items-center gap-1 text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" stroke-width="2"/><path d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" stroke-width="2"/></svg>
            <span class="text-[10px] font-bold">è²¡å‹™å ±è¡¨</span>
        </button>
        <button onclick="switchTab('wish')" id="tab-wish" class="flex-1 flex flex-col items-center gap-1 text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" stroke-width="2"/></svg>
            <span class="text-[10px] font-bold">é¡˜æœ›æ¸…å–®</span>
        </button>
        <button onclick="switchTab('settings')" id="tab-settings" class="flex-1 flex flex-col items-center gap-1 text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" stroke-width="2"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke-width="2"/></svg>
            <span class="text-[10px] font-bold">è¨­å®š</span>
        </button>
    </footer>

    <!-- å½ˆçª—å…§å®¹ -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/60 hidden z-[60] flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div id="modal-container" class="bg-white w-full max-w-lg rounded-t-3xl sm:rounded-3xl overflow-hidden modal-enter shadow-2xl">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="modal-title" class="text-xl font-bold text-gray-800">æ–°å¢æ¶ˆè²»</h3>
                    <button onclick="closeModal()" class="text-gray-400 p-2 text-xl">âœ•</button>
                </div>
                <form id="data-form" class="space-y-4 max-h-[60vh] overflow-y-auto no-scrollbar pb-6 px-1"></form>
                <div class="pt-4 border-t border-gray-50 flex gap-3">
                    <button onclick="closeModal()" class="flex-1 bg-gray-100 text-gray-500 font-bold py-4 rounded-2xl active:scale-95 transition-transform">å–æ¶ˆ</button>
                    <button onclick="saveData()" class="bg-brand flex-[2] text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-transform">ç¢ºèªå„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¶ˆè²»æ¸…å–®æ“ä½œé¸å–®å½ˆçª— -->
    <div id="action-modal-overlay" onclick="closeActionModal()" class="fixed inset-0 bg-black/60 hidden z-[70] flex items-end justify-center p-0">
        <div id="action-modal-container" onclick="event.stopPropagation()" class="bg-slate-100 w-full max-w-lg rounded-t-[2.5rem] overflow-hidden modal-enter p-8 space-y-4 shadow-2xl">
            <!-- é ‚éƒ¨è£é£¾æ¢ -->
            <div class="w-12 h-1.5 bg-slate-300 rounded-full mx-auto mb-4"></div>
            <div class="space-y-3">
                <button id="action-convert-btn" onclick="triggerConvertToExpense()" class="hidden w-full flex items-center justify-between p-2 bg-white rounded-2xl font-bold text-slate-700 active:scale-[0.98] transition-all">
                    <div class="flex items-center gap-4">
                        <span>åŠ å…¥æ¶ˆè²»æ¸…å–®</span>
                    </div>
                    <div class="w-10 h-10 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="23" height="23" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path><line x1="12" y1="10" x2="18" y2="10"></line><line x1="15" y1="6" x2="15" y2="13"></line></svg>
                    </div>
                </button>
                <!-- ç·¨è¼¯æŒ‰éˆ• -->
                <button onclick="triggerEditFromAction()" class="w-full flex items-center justify-between p-2 bg-white rounded-2xl font-bold text-slate-700 active:scale-[0.98] transition-all">
                    <div class="flex items-center gap-4">
                        <span>ç·¨è¼¯è³‡æ–™</span>
                    </div>
                    <div class="w-10 h-10 flex items-center justify-center ">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" stroke-width="2"/></svg>
                    </div>
                </button>
                
                <!-- åˆªé™¤æŒ‰éˆ• -->
                <button onclick="triggerDeleteFromAction()" class="w-full flex items-center justify-between p-2 bg-white rounded-2xl font-bold text-red-500 active:scale-[0.98] transition-all">
                    <div class="flex items-center gap-4">
                        <span>åˆªé™¤è³‡æ–™</span>
                    </div>
                     <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center shadow-sm">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2"/></svg>
                    </div> 
                </button>
            </div>
        </div>
    </div>
    
     <!-- é€šç”¨ç¢ºèªå½ˆçª— -->
    <div id="common-confirm-overlay" class="fixed inset-0 bg-black/70 hidden z-[110] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xs rounded-3xl overflow-hidden p-6 text-center shadow-2xl scale-95">
            <div id="confirm-icon" class="w-16 h-16 bg-brand/10 text-brand rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">ğŸ—‘ï¸</div>
            <h3 id="confirm-title" class="text-lg font-bold text-gray-800 mb-2">ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ</h3>
            <p id="confirm-desc" class="text-sm text-gray-400 mb-6">ç´€éŒ„åˆªé™¤å¾Œå°‡ç„¡æ³•æ¢å¾©ã€‚</p>
            <div class="flex gap-3">
                <button id="confirm-btn-cancel" class="flex-1 bg-gray-100 text-gray-500 font-bold py-3 rounded-xl active:scale-95">å–æ¶ˆ</button>
                <button id="confirm-btn-ok" class="bg-brand flex-1 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95">ç¢ºå®š</button>
            </div>
        </div>
    </div>
    <!-- è‡ªè¨‚æ¼¸å±¤å½ˆçª— -->
    <div id="grad-modal" class="fixed inset-0 bg-black/70 hidden z-[110] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl">
            <h3 class="text-lg font-bold mb-4 text-center text-slate-800">è¨­å®šè‡ªè¨‚æ¼¸å±¤</h3>
            
            <div class="space-y-4 mb-6">
                <div class="space-y-1">
                    <div class="flex items-center gap-1 mb-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">èµ·å§‹é¡è‰² (HEX)</label>
                        
                        <div class="relative group flex items-center w-8 h-8">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-slate-300 cursor-help hover:text-slate-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>

                            <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-36 p-2 bg-slate-700 text-white text-[10px] rounded-xl shadow-xl opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none text-center leading-relaxed z-50">
                                è‹¥ä½¿ç”¨æ·±è‰²æ¨¡å¼ï¼Œå»ºè­°å°‡æ·ºè‰²è¨­ç‚ºèµ·å§‹å€¼ã€‚
                                <div class="absolute top-full left-1/2 -translate-x-1/2 -mt-1 border-4 border-transparent border-t-slate-800"></div>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="g1-hex" placeholder="#000000" oninput="syncGradInput('g1')" 
                            class="flex-grow bg-slate-50 border-2 border-transparent focus:border-brand rounded-xl px-3 py-2 text-sm font-mono outline-none">
                        <input type="color" id="g1-picker" oninput="syncGradPicker('g1')" class="w-10 h-10 border-none bg-transparent cursor-pointer">
                    </div>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase">çµæŸé¡è‰² (HEX)</label>
                    <div class="flex gap-2">
                        <input type="text" id="g2-hex" placeholder="#FF85D0" oninput="syncGradInput('g2')" 
                            class="flex-grow bg-slate-50 border-2 border-transparent focus:border-brand rounded-xl px-3 py-2 text-sm font-mono outline-none">
                        <input type="color" id="g2-picker" oninput="syncGradPicker('g2')" class="w-10 h-10 border-none bg-transparent cursor-pointer">
                    </div>
                </div>

                <div id="grad-preview-box" class="w-full h-10 rounded-xl border border-slate-100 shadow-inner"></div>
            </div>

            <div class="flex gap-3">
                <button onclick="document.getElementById('grad-modal').classList.add('hidden')" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button>
                <button onclick="saveGrad()" class="bg-brand flex-[2] text-white py-3 rounded-xl shadow-lg font-bold">å„²å­˜ä¸¦å¥—ç”¨</button>
            </div>
        </div>
    </div>
    <!-- ç‡ˆç®± -->
    <div id="lightbox-overlay" onclick="closeLightbox()" class="fixed inset-0 bg-black/95 hidden z-[200] flex flex-col items-center justify-center p-4">
        <div class="relative w-full max-w-md">
            <img id="lightbox-img" src="" class="w-full h-auto rounded-3xl shadow-2xl">
            <div id="lightbox-info" class="absolute bottom-5 left-0 right-0 text-white text-center">
                <p id="lightbox-name" class="font-black text-lg"></p>
                <p id="lightbox-sub" class="text-white/60 text-xs"></p>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject, listAll} from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";
    const firebaseConfig = {
        apiKey: "AIzaSyCiJHNQcqr07KVu4Xh6KjOQ9KmVS9YG78A",
        authDomain: "fandom-expense.firebaseapp.com",
        projectId: "fandom-expense",
        storageBucket: "fandom-expense.firebasestorage.app",
        messagingSenderId: "275234127604",
        appId: "1:275234127604:web:af62f27f272290236ae8a1",
        measurementId: "G-4QE8P5ZDQ6"
    };

    const appId = 'fandom-expense-v11'; 
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    window.cloud = {
        login: async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (err) {
                console.error("Login Error:", err);
                showToast("ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥å½ˆçª—è¨­å®š");
            }
        },
        logout: async () => { await signOut(auth); localStorage.clear(); location.reload(); },
        uploadFile: async (blob, fileName) => {
            if (!auth.currentUser) return null;
            try {
                const fileRef = ref(storage, `users/${auth.currentUser.uid}/images/${fileName}`);
                
                const metadata = {
                    cacheControl: 'public, max-age=31536000', // ç¶­æŒå¿«å–ä¸€å¹´
                    contentType: blob.type // <--- é€™è£¡æ”¹ç‚ºå‹•æ…‹ç²å–ï¼Œä¸ç®¡æ˜¯ png, jpeg, webp éƒ½æœƒæ­£ç¢ºæ¨™è¨˜
                };
                
                const snapshot = await uploadBytes(fileRef, blob, metadata);
                return await getDownloadURL(snapshot.ref);
            } catch (e) {
                console.error("Upload failed:", e);
                showToast("é›²ç«¯ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ‰‹æ©Ÿæ¬Šé™",e);
                return null;
            }
        },
        deleteFile: async (url) => {
            if (!url) return;
            try {
                // åœ¨æ¨¡çµ„å…§éƒ¨ï¼Œref æ˜¯å¯ä»¥è¢«å­˜å–çš„
                const fileRef = ref(storage, url);
                await deleteObject(fileRef);
                console.log("é›²ç«¯æª”æ¡ˆåˆªé™¤æˆåŠŸ");
                return true;
            } catch (e) {
                console.error("é›²ç«¯æª”æ¡ˆåˆªé™¤å¤±æ•—:", e);
                return false;
            }
        },
        cleanupOrphanedFiles: async (activeUrls) => {
            if (!auth.currentUser) return;
            try {
                const listRef = ref(storage, `users/${auth.currentUser.uid}/images/`);
                const res = await listAll(listRef);
                
                let deleteCount = 0;
                for (const itemRef of res.items) {
                    // å–å¾—è©²æª”æ¡ˆçš„ä¸‹è¼‰ç¶²å€ä¾†åšæ¯”å°
                    const downloadUrl = await getDownloadURL(itemRef);
                    if (!activeUrls.includes(downloadUrl)) {
                        await deleteObject(itemRef);
                        deleteCount++;
                        console.log(`å·²æ¸…ç†å­¤å…’æª”æ¡ˆ: ${itemRef.name}`);
                    }
                }
                return deleteCount;
            } catch (e) {
                console.error("æ¸…ç†å¤±æ•—:", e);
                return -1;
            }
        },
        sync: async (expenses, wishlist) => {
            if (!auth.currentUser || auth.currentUser.isAnonymous) return;
            try {
                // ä¿®æ­£ï¼šè·¯å¾‘å¢åŠ  'main' ä½¿å…¶è®Šç‚ºå¶æ•¸å° (6å±¤)
                const userDoc = doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'userData', 'main');
                await setDoc(userDoc, { expenses, wishlist }, { merge: true });
            } catch (e) { console.error("Sync failed:", e); }
        },
        pull: async () => {
            if (!auth.currentUser || auth.currentUser.isAnonymous) return null;
            try {
                // ä¿®æ­£ï¼šè·¯å¾‘å¿…é ˆèˆ‡ sync ä¸€è‡´
                const userDoc = doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'userData', 'main');
                const snap = await getDoc(userDoc);
                return snap.exists() ? snap.data() : null;
            } catch (e) { return null; }
        }
    };

    onAuthStateChanged(auth, async (user) => {
        state.user = (user && !user.isAnonymous) ? user : null;
        if (state.user) {
            const data = await window.cloud.pull();
            if (data) {
                state.expenses = data.expenses || state.expenses;
                state.wishlist = data.wishlist || state.wishlist;
                localStorage.setItem(`fe_v11_expenses`, JSON.stringify(state.expenses));
                localStorage.setItem(`fe_v11_wishlist`, JSON.stringify(state.wishlist));
            }
        }
        renderContent();
    });
</script>


    <script>
        /**
         * 1. ç‹€æ…‹ç®¡ç†
         */
        let state = {
            activeTab: 'expense',
            subPage: null,
            photoWallTab: 'purchased',
            themeColor: localStorage.getItem('fe_v11_theme') || 'svt', 
            expenses: JSON.parse(localStorage.getItem('fe_v11_expenses')) || [],
            tempImage: null,     // ç”¨ä¾†å­˜æ—¢æœ‰çš„åœ–ç‰‡ç¶²å€ (URL)
            tempImageBlob: null, // ç”¨ä¾†å­˜æ–°é¸å–çš„åœ–ç‰‡æª”æ¡ˆ (Blob)
            wishlist: JSON.parse(localStorage.getItem('fe_v11_wishlist')) || [],
            wishSourceId: null, // ç”¨ä¾†æš«å­˜è½‰æ›ä¸­çš„é¡˜æœ› ID
            filterYear: Number(new Date().getFullYear()),
            filterMonth: Number(new Date().getMonth() + 1),
            reportRange: '6months', 
            reportOffset: 0,
            searchKeyword: '',
            selectedCategory: '',
            photoFilterCat: '',
            editingId: null,
            actionTarget: { type: null, id: null },
            user: null,
            hideAmount: JSON.parse(localStorage.getItem('fe_v11_hideAmount')) || false, //ç¸½é‡‘é¡éš±è—ç‹€æ…‹
        };

        const excelHeaderMap = {
            name: "é …ç›®åç¨±", price: "å–®åƒ¹", qty: "æ•¸é‡",shipping:"é‹è²»",category: "åˆ†é¡",
            year: "æ¶ˆè²»å¹´ä»½", month: "æ¶ˆè²»æœˆä»½", platform: "æ”¶ç‰©å¹³å°",
            arrivalStatus: "åˆ°è²¨ç‹€æ…‹", paymentMethod: "ä»˜æ¬¾æ–¹å¼", paidAmount: "å·²ä»˜é‡‘é¡", tags: "æ¨™ç±¤", remark: "å‚™è¨»"
        };

        const categories = [
            { id: 'å°ˆè¼¯', icon: 'ğŸµ', color: '#6366f1' },               // é›è— (Indigo) - æ²‰ç©©çš„éŸ³æ¨‚æ„Ÿ
            { id: 'å°å¡', icon: 'âœ¨', color: '#EAB308' },               // é»ƒè‰² (Yellow) - é–ƒé–ƒç™¼å…‰çš„æ”¶è—æ„Ÿ
            { id: 'æ¼”å”±æœƒ / è¦‹é¢æœƒé–€ç¥¨', icon: 'ğŸ«', color: '#fb7185' },  // çŠç‘šç´… (Rose) - å……æ»¿ç†±æƒ…çš„ç¾å ´æ„Ÿ
            { id: 'å‘¨é‚Šå•†å“', icon: 'ğŸ§¸', color: '#f59e0b' },           // ç¥ç€ (Amber) - æº«æš–çš„ç‰©è³ªæ„Ÿ
            { id: 'äº¤é€š / ä½å®¿', icon: 'âœˆï¸', color: '#60a5fa' },          // å¤©è— (Sky) - é£›ç¿”èˆ‡æ—…éŠæ„Ÿ
            { id: 'å…¶ä»–è¿½æ˜Ÿæ”¯å‡º', icon: 'ğŸŒˆ', color: '#94a3b8' }           // å†·ç° (Slate) - ä¸­æ€§ä¸”ä¸æ¶æˆ²
        ];

        const wishCategories = ["å°ˆè¼¯", "å‘¨é‚Š", "å¨ƒå¨ƒ", "å°å¡","æ¼”å”±æœƒ"];
        const arrivalOptions = ['æœªåˆ°è²¨', 'å¾…å‡ºè²¨', 'å·²å–è²¨'];
        const paymentOptions = ['å¾…ä»˜æ¬¾', 'è²¨åˆ°ä»˜æ¬¾', 'åŒ¯æ¬¾å…¨é¡', 'å·²ä»˜è¨‚é‡‘','ä¿¡ç”¨å¡','ç¾é‡‘'];
        let myChart = null;
        /**æ»‘å‹•é—œé–‰ç·¨è¼¯é‚è¼¯ */
        let touchStartY = 0;
        let isDragging = false;

        function initSwipeToClose() {
            const container = document.getElementById('action-modal-container');
            const overlay = document.getElementById('action-modal-overlay');
            
            container.addEventListener('touchstart', (e) => {
                touchStartY = e.touches[0].clientY;
                isDragging = true;
                container.classList.add('dragging');
            }, { passive: true });

            container.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                const currentY = e.touches[0].clientY;
                const deltaY = currentY - touchStartY;
                
                if (deltaY > 0) { // åªæœ‰å‘ä¸‹åŠƒæ™‚æœ‰åæ‡‰
                    container.style.transform = `translateY(${deltaY}px)`;
                    // èƒŒæ™¯é€æ˜åº¦éš¨æ»‘å‹•è·é›¢è®Šæ·¡
                    const opacity = Math.max(0, 0.6 - (deltaY / 500));
                    overlay.style.backgroundColor = `rgba(0, 0, 0, ${opacity})`;
                }
            }, { passive: true });

            container.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                isDragging = false;
                container.classList.remove('dragging');
                
                const currentY = e.changedTouches[0].clientY;
                const deltaY = currentY - touchStartY;

                if (deltaY > 120) { // æ»‘å‹•é–€æª»ï¼š120px
                    closeActionModal();
                } else {
                    // å½ˆå›åŸä½
                    container.style.transform = 'translateY(0)';
                    overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.6)';
                }
            });
        }

        /**
         * 2. å·¥å…·å‡½å¼
         */
        function showToast(msg) {
            const t = document.getElementById("toast");
            if(!t) return;
            t.textContent = msg; t.classList.add("show");
            setTimeout(() => t.classList.remove("show"), 2000);
        }
        //æ¼¸å±¤å·¥å…·
        // åŒæ­¥ï¼šè¼¸å…¥æ–‡å­—æ¡† -> è‰²ç›¤
        function syncGradInput(id) {
            const inputEl = document.getElementById(`${id}-hex`);
            let hex = inputEl.value.trim();

            // 1. è‡ªå‹•è£œäº•å­—è™Ÿ
            if (hex.length > 0 && !hex.startsWith('#')) {
                hex = '#' + hex;
                inputEl.value = hex;
            }

            // 2. æ­£è¦è¡¨é”å¼æª¢æŸ¥ï¼šå¿…é ˆæ˜¯ # åŠ ä¸Š 6 ä½ 0-9 æˆ– A-F
            const isValid = /^#[0-9A-F]{6}$/i.test(hex);

            if (isValid) {
                // åªæœ‰æ ¼å¼å®Œå…¨æ­£ç¢ºï¼Œæ‰å»æ”¹è‰²ç›¤çš„å€¼å’Œé è¦½
                document.getElementById(`${id}-picker`).value = hex;
                inputEl.style.borderColor = 'transparent'; // ç§»é™¤ç´…æ¡†
                updateGradPreview();
            } else {
                // å¦‚æœé•·åº¦å·²ç¶“å¤ äº†(7ç¢¼)ä½†æ ¼å¼ä¸å°ï¼Œæˆ–æ˜¯è¼¸å…¥ä¸­
                // æˆ‘å€‘ä¸æ›´æ–°é¡è‰²ï¼Œä½†å¯ä»¥çµ¦å€‹è¦–è¦ºæç¤ºï¼ˆä¾‹å¦‚é‚Šæ¡†è®Šæ·¡ç´…ï¼‰
                if (hex.length >= 7) {
                    inputEl.style.borderColor = '#ef4444'; // Tailwind çš„ red-500
                } else {
                    inputEl.style.borderColor = 'transparent';
                }
            }
        }

        // åŒæ­¥ï¼šè‰²ç›¤ -> è¼¸å…¥æ–‡å­—æ¡†
        function syncGradPicker(id) {
            const val = document.getElementById(`${id}-picker`).value;
            document.getElementById(`${id}-hex`).value = val.toUpperCase();
            updateGradPreview();
        }

        // æ›´æ–°é è¦½å€
        function updateGradPreview() {
            const c1 = document.getElementById('g1-picker').value;
            const c2 = document.getElementById('g2-picker').value;
            document.getElementById('grad-preview-box').style.background = `linear-gradient(135deg, ${c1}, ${c2})`;
        }

        // é–‹å•Ÿä¸¦åˆå§‹åŒ–å½ˆçª—
        function openGradModal() {
            // 1. é¡¯ç¤ºå½ˆçª—
            document.getElementById('grad-modal').classList.remove('hidden');
            
            // 2. è¨­å®šé è¨­å€¼ (é¿å…æ²’æŠ“åˆ°é¡è‰²æ™‚å ±éŒ¯)
            let color1 = "#F7CAC9"; 
            let color2 = "#92A8D1"; 

            // 3. æ ¹æ“šç›®å‰çš„ç‹€æ…‹ state.themeColor è§£æé¡è‰²
            if (state.themeColor.includes('gradient') && state.themeColor !== 'svt') {
                // å¦‚æœæ˜¯è‡ªè¨‚æ¼¸å±¤ï¼Œç”¨æ­£å‰‡è¡¨é”å¼æŠ“å–è‰²ç¢¼
                const matchedColors = state.themeColor.match(/#[A-Fa-f0-9]{3,6}/g);
                if (matchedColors && matchedColors.length >= 2) {
                    color1 = matchedColors[0];
                    color2 = matchedColors[1];
                }
            } else if (state.themeColor === 'svt') {
                color1 = "#F7CAC9";
                color2 = "#92A8D1";
            } else if (state.themeColor.startsWith('#')) {
                // å¦‚æœæ˜¯ç´”è‰²ï¼Œèµ·å§‹è¨­ç‚ºè©²è‰²ï¼ŒçµæŸè¨­ç‚ºç™½è‰²
                color1 = state.themeColor;
                color2 = "#FFFFFF";
            }
            document.getElementById('g1-hex').value = color1.toUpperCase();
            document.getElementById('g1-picker').value = color1;
            document.getElementById('g2-hex').value = color2.toUpperCase();
            document.getElementById('g2-picker').value = color2;
            // æ–°å¢ï¼šåµæ¸¬ body æ˜¯å¦æœ‰ dark-mode classï¼Œæœ‰çš„è©±å°±æŠŠé–‹é—œæ‰“å‹¾
            const isDark = document.body.classList.contains('dark-mode');
            document.getElementById('grad-dark-toggle').checked = isDark;
            updateGradPreview();
        }

        function saveGrad() {
            const c1 = document.getElementById('g1-picker').value;
            const c2 = document.getElementById('g2-picker').value;
            const grad = `linear-gradient(135deg, ${c1}, ${c2})`;
            const isDark = document.getElementById('grad-dark-toggle').checked;
            // å¥—ç”¨ä¸»é¡Œï¼Œå¤šå‚³ä¸€å€‹ isDark åƒæ•¸
            applyTheme(grad, isDark);
            document.getElementById('grad-modal').classList.add('hidden');
            renderContent();
            showToast("æ¼¸å±¤å·²æ›´æ–°ï¼");
        }

        //æ‡‰ç”¨ä¸»é¡Œé¡è‰²
        function applyTheme(color, isDarkMode = null) {
            state.themeColor = color;
            const root = document.documentElement;
            const body = document.body;

            // --- æ·±è‰²æ¨¡å¼åˆ¤æ–·é‚è¼¯ ---
            let targetDark;
            
            if (isDarkMode !== null) {
                // å¦‚æœæœ‰å¾ saveGrad å‚³é€²ä¾† (true æˆ– false)ï¼Œå°±ç”¨å‚³é€²ä¾†çš„
                targetDark = isDarkMode;
            } else {
                // å¦‚æœæ˜¯é»æ“Šã€Œç²‰è—ã€æˆ–å…¶ä»–é è¨­é¡è‰²ï¼ˆåªå‚³ä¸€å€‹åƒæ•¸æ™‚ï¼‰ï¼Œå°±è®€å–åŸæœ¬å­˜çš„ç‹€æ…‹
                targetDark = localStorage.getItem('fe_v11_darkMode') === 'true';
            }

            // å„²å­˜ç‹€æ…‹ä¸¦å¥—ç”¨ class
            localStorage.setItem('fe_v11_darkMode', targetDark);
            if (targetDark) {
                body.classList.add('dark-mode');
            } else {
                body.classList.remove('dark-mode');
            }

            if (color === 'svt') {
                root.style.setProperty('--brand-color', '#92A8D1');
                root.style.setProperty('--brand-gradient', 'linear-gradient(135deg, #F7CAC9 0%, #92A8D1 100%)');
            } else if (color.includes('gradient')) {
                root.style.setProperty('--brand-gradient', color);
                const match = color.match(/#[A-Fa-f0-9]{6}/);
                root.style.setProperty('--brand-color', match ? match[0] : '#92A8D1');
            } else {
                root.style.setProperty('--brand-color', color);
                root.style.setProperty('--brand-gradient', color);
            }
            localStorage.setItem('fe_v11_theme', color);
        }

        function compressImage(base64Str, maxWidth = 600) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;

                    // 1. å¼·åˆ¶èª¿æ•´å°ºå¯¸
                    if (w > maxWidth) {
                        h *= maxWidth / w;
                        w = maxWidth;
                    }
                    canvas.width = w;
                    canvas.height = h;

                    const ctx = canvas.getContext('2d');
                    // 2. ä½¿ç”¨æ›´å¹³æ»‘çš„ç¸®æ”¾ç¹ªè£½
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, w, h);

                    // 3. å„ªå…ˆä½¿ç”¨ webp æ ¼å¼ (é«”ç©æ¸›å°‘ç´„ 30%)ï¼Œå“è³ªè¨­ç‚º 0.4
                    // å¦‚æœç€è¦½å™¨ä¸æ”¯æ´ webpï¼Œå®ƒæœƒè‡ªå‹•é€€å›åˆ° image/jpeg
                    let outputFormat = "image/webp";
                    let quality = 0.4; 

                    const compressedBase64 = canvas.toDataURL(outputFormat, quality);
                    resolve(compressedBase64);
                };
            });
        }

        function getStatusClass(s) {
            if (s === 'æœªåˆ°è²¨') return 'status-unArrived';
            if (s === 'å¾…å‡ºè²¨') return 'status-toShip';
            return 'status-received';
        }

        /**
         * 3. å°è¦½èˆ‡æ¸²æŸ“
         */
        function switchTab(tab) {
            state.activeTab = tab; state.subPage = null; state.searchKeyword = ''; state.selectedCategory = '';
            ['expense', 'report', 'wish', 'settings'].forEach(t => {
                const el = document.getElementById(`tab-${t}`);
                if (el) el.className = `flex-1 flex flex-col items-center gap-1 transition-colors ${tab === t ? 'tab-active' : 'text-gray-400'}`;
            });
            document.getElementById('fab').classList.toggle('hidden', tab === 'report' || tab === 'settings');
            // é‡å°å…¨åŸŸè¦–çª—èˆ‡ä¸»è¦çš„å…§å®¹å®¹å™¨é€²è¡Œæ²å‹•é‡è¨­
            window.scrollTo(0, 0); 
            const container = document.getElementById('main-content');
            if (container) {
                container.scrollTop = 0;
            }
            renderContent();
        }

        function renderContent() {
            const container = document.getElementById('main-content');
            if(!container) return;
            container.innerHTML = '';
            if (state.activeTab === 'expense') renderExpenseList(container);
            else if (state.activeTab === 'report') renderReport(container);
            else if (state.activeTab === 'wish') renderWishList(container);
            else if (state.activeTab === 'settings') {
                if (state.subPage === 'backup') renderBackupView(container);
                else if (state.subPage === 'appearance') renderAppearanceView(container);
                else if (state.subPage === 'photowall') renderPhotoWall(container);
                else renderSettings(container);
            }
        }

        function renderExpenseList(container) {
            container.innerHTML = `
                <div class="pt-6 px-6 sticky top-0 bg-brand/5 backdrop-blur-md z-30 border-b border-gray-100">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-black tracking-tight">æ¶ˆè²»æ¸…å–®</h2>
                        <div class="flex gap-2 text-gray-800">
                            <select onchange="updateFilter('year', this.value)" class="bg-white border rounded-lg px-2 py-1 text-xs outline-none shadow-sm">
                                <option value="0" ${state.filterYear === 0 ? 'selected' : ''}>ä¸é™</option>
                                ${[2024, 2025, 2026].map(y => `<option value="${y}" ${Number(y) === Number(state.filterYear) ? 'selected' : ''}>${y}å¹´</option>`).join('')}
                            </select>
                            <select onchange="updateFilter('month', this.value)" class="bg-white border rounded-lg px-2 py-1 text-xs outline-none shadow-sm">
                                <option value="0" ${state.filterMonth === 0 ? 'selected' : ''}>ä¸é™</option>
                                ${Array.from({length: 12}, (_, i) => i + 1).map(m => `<option value="${m}" ${Number(m) === Number(state.filterMonth) ? 'selected' : ''}>${m}æœˆ</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="relative mb-3">
                        <input type="text" placeholder="æœå°‹é …ç›®ã€åˆ°è²¨ç‹€æ…‹ã€å‚™è¨»..." oninput="state.searchKeyword=this.value;renderExpenseListItems(document.getElementById('expense-list-items'))" class="w-full bg-white border border-gray-100 rounded-2xl py-3 px-10 text-sm shadow-sm outline-none focus:ring-2 focus:ring-brand focus:ring-opacity-20 transition-all text-gray-800">
                        <svg class="text-brand w-4 h-4 absolute left-4 top-4 opacity-40" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="3"/></svg>
                    </div>
                    <div id="cat-bar" class="flex gap-2 overflow-x-auto no-scrollbar pb-2 mb-1"></div>
                    <div id="tag-bar" class="flex gap-2 overflow-x-auto no-scrollbar pb-2"></div>
                </div>
                <div id="expense-list-items" class="px-6 space-y-4 pb-12 pt-4"></div>
            `;
            renderTagAndCatBar();
            renderExpenseListItems(document.getElementById('expense-list-items'));
        }

        function quickFilter(type, value) {
            const input = document.querySelector('input[placeholder*="æœå°‹"]');
            
            if (type === 'category') {
                state.selectedCategory = value;
            } else {
                state.searchKeyword = value;
                if (input) input.value = value;
            }

            // åŸ·è¡Œæ¸²æŸ“ï¼šæ›´æ–°åˆ†é¡åˆ—èˆ‡æ¸…å–®å…§å®¹
            renderTagAndCatBar(); 
            renderExpenseListItems(document.getElementById('expense-list-items'));
        }
        function renderTagAndCatBar() {
            const catBar = document.getElementById('cat-bar'); 
            if (!catBar) return;

            // --- ç¬¬ä¸€å±¤ï¼šåˆ†é¡ (Categories) æ¸²æŸ“ ---
            catBar.innerHTML = categories.map(cat => {
                const isActive = state.selectedCategory === cat.id;
                return `
                    <div onclick="state.selectedCategory=(state.selectedCategory==='${cat.id}'?'':'${cat.id}'); 
                                renderTagAndCatBar(); 
                                renderExpenseListItems(document.getElementById('expense-list-items'))" 
                        class="chip ${isActive ? 'active-cat text-white' : ''}" 
                        style="${isActive ? `background-color:${cat.color}` : `color:${cat.color}; background-color:${cat.color}10; border-color:${cat.color}30`}">
                        ${cat.icon} ${cat.id.split(' ')[0]}
                    </div>`;
            }).join('');

            // --- ç¬¬äºŒå±¤ï¼šé€£å‹•æ¨™ç±¤ (Filtered Tags) é‚è¼¯ ---
            const tagBar = document.getElementById('tag-bar');
            if (!tagBar) return;

            //åŒæ™‚éæ¿¾ å¹´ä»½ã€æœˆä»½ ä»¥åŠ åˆ†é¡
            const filteredExpensesForTags = state.expenses.filter(ex => {
                // 1. æª¢æŸ¥å¹´ä»½èˆ‡æœˆä»½æ˜¯å¦ç¬¦åˆç›®å‰çš„é¸æ“‡   
                const dateMatch = (state.filterYear === 0 || Number(ex.year) === Number(state.filterYear)) && (state.filterMonth === 0 || Number(ex.month) === Number(state.filterMonth));
               // 2. æª¢æŸ¥åˆ†é¡æ˜¯å¦ç¬¦åˆç›®å‰çš„é¸æ“‡
                const catMatch = (state.selectedCategory === '' || ex.category === state.selectedCategory);
                
                return dateMatch && catMatch;
         });

        // 2. æå–é€™äº›ç´€éŒ„ä¸­ä¸é‡è¤‡çš„æ¨™ç±¤
            const relevantTags = [...new Set(filteredExpensesForTags.flatMap(ex => ex.tags || []))].filter(t => t);

            // 3. æ¸²æŸ“æ¨™ç±¤åˆ—
            if (relevantTags.length === 0) {
                tagBar.innerHTML = `<span class="text-[10px] text-slate-300 py-2 ml-1">æ­¤åˆ†é¡æš«ç„¡æ¨™ç±¤</span>`;
            } else {
                tagBar.innerHTML = relevantTags.map(tag => {
                    const isActive = state.searchKeyword === tag;
                    return `
                        <div onclick="state.searchKeyword=(state.searchKeyword==='${tag}'?'':'${tag}'); 
                                    renderTagAndCatBar(); 
                                    renderExpenseListItems(document.getElementById('expense-list-items'))" 
                            class="chip ${isActive ? 'active-tag' : ''}">
                            #${tag}
                        </div>`;
                }).join('');
            }
        }

        function renderExpenseListItems(container) { //æ¶ˆè²»æ¸…å–®æ¸²æŸ“
            if(!container) return;
            const kw = state.searchKeyword.toLowerCase();
            const filtered = state.expenses.filter(ex => {
            // 1. åŸºæœ¬æ™‚é–“éæ¿¾
            const dateMatch = (state.filterYear === 0 || Number(ex.year) === Number(state.filterYear)) && (state.filterMonth === 0 || Number(ex.month) === Number(state.filterMonth));
            // 2. åˆ†é¡éæ¿¾
            const catMatch = (state.selectedCategory === '' || ex.category === state.selectedCategory);
            
            // 3. é€²éšé—œéµå­—éæ¿¾ (åŒ…å«ï¼šåç¨±ã€æ¨™ç±¤ã€å‚™è¨»ã€åˆ°è²¨ç‹€æ…‹ã€æ”¶ç‰©å¹³å°)
            const keywordMatch = (
                ex.name.toLowerCase().includes(kw) || 
                (ex.tags && ex.tags.some(t => t.toLowerCase().includes(kw))) || 
                (ex.remark && ex.remark.toLowerCase().includes(kw)) ||
                (ex.arrivalStatus && ex.arrivalStatus.toLowerCase().includes(kw)) || // æ–°å¢ï¼šæœå°‹åˆ°è²¨ç‹€æ…‹
                (ex.platform && ex.platform.toLowerCase().includes(kw))             // æ–°å¢ï¼šæœå°‹æ”¶ç‰©å¹³å°
            );

            return dateMatch && catMatch && keywordMatch;
            });
            const total = filtered.reduce((sum, item) => sum + (Number(item.total) || 0), 0);
            const totalDisplay = state.hideAmount ? 'â€¢â€¢â€¢â€¢â€¢' : `$ ${total.toLocaleString()}`;
            const summaryLabel = state.filterYear === 0 ? 'Total Cost' : (state.filterMonth === 0 ? 'Yearly Cost' : 'Monthly Cost');


            if (filtered.length === 0) { container.innerHTML = `<div class="text-center py-24 text-slate-300 font-bold">ç›®å‰æ²’æœ‰ç´€éŒ„å”·</div>`; return; }
            
            container.innerHTML = `<div class="bg-brand rounded-3xl p-6 text-white card-shadow flex justify-between items-end mb-6">
                <div>
                    <div class="flex items-center mb-1"><p class="text-white/70 text-[10px] font-bold uppercase tracking-wider ">${summaryLabel}</p>                     
                        <button onclick="toggleAmountVisibility()" class="text-white/60 hover:text-white transition-colors p-1">
                                ${state.hideAmount ? 
                                    `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>` : 
                                    `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5 " stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`
                                }
                        </button></div>
                    <h3 class="text-3xl font-black">${totalDisplay}</h3>
                    </div>
                    <p class="text-xs text-white/80 font-medium">${filtered.length} é …ç´€éŒ„</p>
                </div>` + 
                filtered.sort((a, b) => {
                    if (Number(b.year) !== Number(a.year)) {
                        return Number(b.year) - Number(a.year);
                    }
                    if (Number(b.month) !== Number(a.month)) {
                        return Number(b.month) - Number(a.month);
                    }
                    return Number(b.id) - Number(a.id);
                }).map(item => {
                const catInfo = categories.find(c => c.id === item.category) || { icon: 'ğŸŒˆ' };
                const payInfo = item.paymentMethod === 'å·²ä»˜è¨‚é‡‘' ? `å·²ä»˜è¨‚é‡‘ $${item.paidAmount || 0}` : (item.paymentMethod || 'å¾…ä»˜æ¬¾');
                return `<div class="bg-white rounded-3xl p-4 card-shadow relative overflow-hidden group">
                    <div class="absolute top-4 right-4 z-10">
                        <button onclick="openActionModal(event, 'expense', '${item.id}')" class="p-2 text-slate-300 hover:text-slate-600 active:scale-90 transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                        </button>
                    </div>
                    <div class="flex gap-4" >
                        ${item.image ? `<img src="${item.image}" loading="lazy" class="w-20 h-20 object-cover rounded-2xl" onclick="${item.image ? `openLightbox('${item.image}', '${item.name}', '${item.year}/${item.month}')` : ''}">` : 
                        `<div class="w-20 h-20 bg-slate-50 rounded-2xl flex items-center justify-center text-3xl shadow-inner">${catInfo.icon}</div>`}
                        <div class="flex-grow">
                            <div class="flex gap-2 mb-1">
                                <span onclick="quickFilter('category', '${item.category}')" class="cursor-pointer text-[9px] font-bold px-2 py-0.5 rounded-lg"  style="background-color: ${catInfo.color}1A; color: ${catInfo.color};">${catInfo.icon} ${item.category}</span>
                                <span onclick="quickFilter('status', '${item.arrivalStatus}')" class="cursor-pointer text-[9px] font-bold px-2 py-0.5 rounded-lg ${getStatusClass(item.arrivalStatus)}">${item.arrivalStatus}</span>
                                 ${state.filterMonth === 0 ? `<span class="text-[9px] font-bold px-2 py-0.5 rounded-lg bg-slate-50 text-slate-400">${item.month}æœˆ</span>` : ''}
                            </div>
                            <h4 class="font-bold text-slate-800 text-sm leading-tight">${item.name}</h4>
                            ${item.remark ? `<div class="text-[10px] text-slate-400 mt-1"><span class="text-brand font-bold mr-1 opacity-70">å‚™è¨»:</span>${item.remark}</div>` : ''}

                            <div class="flex justify-between items-end mt-2">
                                <div class="flex flex-wrap gap-1 pr-2">${(item.tags || []).map(t => `<span class="bg-slate-50 text-slate-400 text-[9px] px-2 py-0.5 rounded-md">#${t}</span>`).join('')}</div>
                                <div class="text-right flex-shrink-0 text-brand"><p class="text-[9px] text-slate-300 font-normal">$${item.price} Ã— ${item.qty} ${item.shipping > 0 ? `+ é‹$${item.shipping}` : ''}</p><p class="font-black text-lg leading-none">${state.hideAmount ? 'â€¢â€¢â€¢' : `$${(Number(item.total)).toLocaleString()}`}</p></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 pt-3 border-t border-slate-100">
                            <div class="flex justify-between items-center">
                                <div class="text-[10px] text-slate-400">
                                    <span class="font-bold text-brand">ä»˜æ¬¾:</span> ${item.paymentMethod} ${item.paymentMethod === 'å·²ä»˜è¨‚é‡‘' ? `(å·²ä»˜:$${item.paidAmount})` : ''}</div>
                                    ${item.shipping > 0 ? `<div class="text-[10px] text-slate-400 font-bold"><span class="opacity-70">é‹è²»:</span> $${item.shipping}</div>
                                ` : ''}
                            </div>
                            ${item.platform ? `<div class="bg-slate-50 p-2 rounded-xl mt-2 border border-slate-100 text-[10px] text-slate-500 leading-relaxed">ğŸ“ ${item.platform}</div>
                            ` : ''}
                        </div>
                </div>`;
            }).join('');
        }
        // é€šç”¨ç¢ºèªå·¥å…·ï¼Œæœƒå›å‚³ true æˆ– false

        function askUser(title, desc, icon = 'ğŸ’¸') {
            const overlay = document.getElementById('common-confirm-overlay');
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-desc').textContent = desc;
            document.getElementById('confirm-icon').textContent = icon;
            
            // æ ¹æ“šåœ–ç¤ºè‡ªå‹•èª¿æ•´èƒŒæ™¯è‰²ï¼ˆå¦‚æœæ˜¯åƒåœ¾æ¡¶å°±è®Šç´…è‰²ç³»ï¼Œå¦å‰‡ç”¨å“ç‰Œè‰²ï¼‰
            const iconBg = document.getElementById('confirm-icon');
            if (icon === 'ğŸ—‘ï¸') {
                iconBg.className = "w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl";
            } else {
                iconBg.className = "w-16 h-16 bg-brand/10 text-brand rounded-full flex items-center justify-center mx-auto mb-4 text-2xl";
            }

            overlay.classList.remove('hidden');

            return new Promise((resolve) => {
                document.getElementById('confirm-btn-ok').onclick = () => { overlay.classList.add('hidden'); resolve(true); };
                document.getElementById('confirm-btn-cancel').onclick = () => { overlay.classList.add('hidden'); resolve(false); };
            });
        }

        // é¡¯ç¤º/éš±è—é‡‘é¡å‡½æ•¸
        async function toggleAmountVisibility() {
            // é—œéµé‚è¼¯ï¼šå¦‚æœæ˜¯ true (è¦é¡¯ç¤º)ï¼Œå°±ç­‰å¾…å½ˆçª—å›å‚³ã€‚å¦‚æœä½¿ç”¨è€…æŒ‰å–æ¶ˆ (!true)ï¼Œå°±ä¸­æ–·
            if (state.hideAmount && !(await askUser("ç¢ºå®šè¦é¡¯ç¤ºé‡‘é¡å—ï¼Ÿ", "é¡¯ç¤ºå¾Œå°‡å¯æŸ¥çœ‹å®Œæ•´çš„æ¶ˆè²»æ˜ç´°èˆ‡ç¸½è¨ˆã€‚"))) {
                return;
            }
            // çœŸæ­£çš„åˆ‡æ›å‹•ä½œ
            state.hideAmount = !state.hideAmount;
            localStorage.setItem('fe_v11_hideAmount', JSON.stringify(state.hideAmount));
            renderContent();
        }

        function renderWishList(container) {
            // 1. æ ¹æ“šç›®å‰é¸ä¸­çš„åˆ†é¡éæ¿¾æ¸…å–®
            const filtered = state.selectedCategory === '' 
                ? state.wishlist 
                : state.wishlist.filter(item => item.category === state.selectedCategory);

            container.innerHTML = `
                <div class="pt-6 px-6 sticky top-0 bg-brand/5 backdrop-blur-md z-30 border-b border-gray-100">
                    <h2 class="text-2xl font-black mb-4 tracking-tight text-slate-800">é¡˜æœ›æ¸…å–®</h2>
                    <div id="wish-cat-bar" class="flex gap-2 overflow-x-auto no-scrollbar pb-3 mb-1"></div>
                </div>

                <div class="p-6 space-y-4 pb-12">
                    ${filtered.length === 0 
                        ? `<div class="text-center py-24 text-slate-300 font-bold">
                            ${state.selectedCategory ? 'æ­¤åˆ†é¡æš«ç„¡é¡˜æœ›' : 'å¿«è¨±ä¸‹æ–°çš„é¡˜æœ›å§ï¼'}
                        </div>` 
                        : filtered.map(item => `
                        <div class="bg-white rounded-3xl p-4 flex flex-col gap-3 card-shadow relative overflow-hidden">
                            <div class="absolute top-4 right-4 z-10">
                                <button onclick="openActionModal(event,'wish', '${item.id}')" class="p-2 text-slate-300 hover:text-slate-600 active:scale-90 transition-all">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                                </button>
                            </div>
                            <div class="flex items-center gap-4" onclick="${item.image ? `openLightbox('${item.image}', '${item.name}', '${item.releaseDate || 'æœªå®š'}')` : ''}">
                                ${item.image ? `<img src="${item.image}" loading="lazy" class="w-16 h-16 object-cover rounded-2xl shadow-sm">` : `<div class="w-16 h-16 bg-slate-50 rounded-2xl flex items-center justify-center text-2xl shadow-inner">âœ¨</div>`}
                                <div class="flex-grow pr-24">
                                    <span class="text-[9px] font-bold px-2 py-0.5 rounded-lg bg-slate-50 text-brand mb-1 inline-block">${item.category || 'ä¸€èˆ¬'}</span>
                                    <h4 class="font-bold text-sm leading-tight text-slate-800">${item.name}</h4>
                                    <p class="text-xs font-black text-brand mt-1">$ ${Number(item.price).toLocaleString()}</p>
                                    <p class="text-[10px] text-slate-400 mt-1 font-bold">ğŸ—“ï¸ ${item.releaseDate || 'æœªå®š'} ${item.releaseTime || ''}</p>
                                </div>
                            </div>
                            ${item.remark ? `
                                <div class="mt-2 pt-2 border-t border-slate-100 flex flex-col gap-1">
                                    <div class="bg-slate-50 p-2 rounded-xl mt-1 border border-slate-100 text-[10px] text-slate-500 leading-relaxed">
                                        <span class="text-brand font-bold mr-1 opacity-70">å‚™è¨»:</span>${item.remark}
                                    </div>
                                </div>` : ''}
                        </div>`).join('')}
                </div>`;

            // æ¸²æŸ“å®Œ HTML å¾Œï¼Œå¡«å……åˆ†é¡åˆ—
            renderWishCatBar();
        }
        function renderWishCatBar() { // æ¸²æŸ“åˆ†é¡æŒ‰éˆ•
            const bar = document.getElementById('wish-cat-bar');
            if (!bar) return;
            
            bar.innerHTML = wishCategories.map(cat => {
                const isActive = state.selectedCategory === cat;
                return `
                    <div onclick="state.selectedCategory=(state.selectedCategory==='${cat}'?'':'${cat}'); renderContent();"
                        class="chip ${isActive ? 'active-tag' : ''}">
                        ${cat}
                    </div>
                    `;
            }).join('');
        }

        // --- è²¡å‹™å ±è¡¨ ---
        function renderReport(container) {
            const rangeData = calculateReportRange();
            const filteredExpenses = state.expenses.filter(ex => { const d = new Date(ex.year, ex.month - 1); return d >= rangeData.start && d <= rangeData.end; });
            const stats = categories.map(cat => ({ ...cat, amount: filteredExpenses.filter(ex => ex.category === cat.id).reduce((sum, item) => sum + (Number(item.total) || 0), 0) })).filter(s => s.amount > 0).sort((a,b) => b.amount - a.amount);
            const totalSpending = stats.reduce((sum, s) => sum + s.amount, 0);//é‡‘é¡è¨ˆç®—
            const totalDisplay = state.hideAmount ? 'â€¢â€¢â€¢' : `${totalSpending.toLocaleString()}`; //é‡‘é¡é¡¯ç¤º

            container.innerHTML = `<div class="p-6"><h2 class="text-2xl font-black text-slate-800 mb-6 tracking-tight">è²¡å‹™åˆ†æå ±å‘Š</h2>
                <div class="flex flex-col gap-4 mb-8">
                    <div class="flex bg-slate-200/50 p-1 rounded-2xl">${['month', '6months', 'year'].map(r => `<button onclick="changeReportRange('${r}')" class="report-range-btn flex-1 py-2 text-xs font-bold rounded-xl transition-all ${state.reportRange===r?'active':''}">${r==='month'?'æœˆ':r==='year'?'å¹´':'è¿‘ 6 å€‹æœˆ'}</button>`).join('')}</div>
                    <div class="flex justify-between items-center bg-white p-4 rounded-2xl card-shadow"><button onclick="shiftRange(-1)" class="p-2 text-slate-400 hover:text-brand transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2"/></svg></button><span class="text-sm font-black text-slate-700">${rangeData.label}</span><button onclick="shiftRange(1)" class="p-2 text-slate-400 hover:text-brand transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="2"/></svg></button></div>
                </div>
                ${totalSpending > 0 ? `<div class="bg-white rounded-3xl p-6 card-shadow mb-8 relative"><div class="w-full max-w-[240px] mx-auto relative"><canvas id="donutChart"></canvas><div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none mt-2"><span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">ç¸½æ”¯å‡º</span><span class="text-xl font-black text-slate-800">$${totalDisplay}</span></div></div></div><div class="space-y-3"><h3 class="text-xs font-black text-slate-400 uppercase mb-4 tracking-widest">æ”¯å‡ºä½”æ¯”æ’å</h3>${stats.map(s => { const p = ((s.amount / totalSpending) * 100).toFixed(1); return `<div class="bg-white rounded-2xl p-4 card-shadow flex items-center gap-4 border-l-4" style="border-color:${s.color}"><div class="w-10 h-10 rounded-xl flex items-center justify-center text-lg" style="background-color:${s.color}20">${s.icon}</div><div class="flex-grow"><div class="flex justify-between items-center mb-1"><span class="text-sm font-bold text-slate-700">${s.id}</span><span class="text-xs font-black text-slate-400">${p}%</span></div><div class="w-full bg-slate-50 h-1.5 rounded-full overflow-hidden"><div class="h-full rounded-full transition-all duration-1000" style="width:${p}%; background-color:${s.color}"></div></div></div><div class="text-right flex-shrink-0 font-black text-slate-800">$${s.amount.toLocaleString()}</div></div>` }).join('')}</div>` : `<div class="py-24 text-center bg-white rounded-3xl border-2 border-dashed border-slate-200 font-bold text-slate-300">ç›®å‰å°šç„¡åˆ†æè³‡æ–™</div>`}</div>`;
            if (totalSpending > 0) initChart(stats);
        }
        /*** å ±è¡¨ç¯„åœåˆ‡æ› (æœˆ/åŠå¹´/å¹´)*/
        function changeReportRange(range) {
            state.reportRange = range;
            state.reportOffset = 0; // åˆ‡æ›æ™‚é‡è¨­åç§»é‡
            renderContent();
        }

        //å ±è¡¨æ™‚é–“è»¸å‰å¾Œç§»å‹•
        function shiftRange(delta) {
            state.reportOffset += delta;
            renderContent();
        }
        //è¨­å®š
        function renderSettings(container) {
            const user = state.user;
            container.innerHTML = `
            <div class="p-6 h-screen"><h2 class="text-2xl font-black mb-8 tracking-tight">è¨­å®š</h2>
                <div class="bg-white rounded-3xl p-5 card-shadow mb-8 flex items-center gap-4 ">
                    <div class="w-12 h-12 rounded-full overflow-hidden bg-slate-50 border-2 border-brand/20 flex items-center justify-center">
                        ${state.user 
                        ? `<img src="${state.user.photoURL}" class="w-full h-full object-cover" alt="ä½¿ç”¨è€…é ­åƒ">` 
                        : `<span class="text-xl">ğŸ‘¤</span>`}
                    </div>
                    
                    <div class="flex-grow">
                        <h4 class="font-bold text-slate-800 text-sm">
                        ${state.user ? (state.user.displayName || 'Google ç”¨æˆ¶') : 'è¨ªå®¢æ¨¡å¼'}
                        </h4>
                        <p class="text-[10px] text-slate-400">
                        ${state.user ? 'é›²ç«¯è³‡æ–™å·²åŒæ­¥ â˜ï¸' : 'ç™»å…¥å¾Œé–‹å•Ÿé›²ç«¯å‚™ä»½'}
                        </p>
                    </div>
                    
                    <div>
                        ${state.user 
                        ? `<button onclick="window.cloud.logout()" class="text-[10px] font-bold text-slate-400 bg-slate-50 px-3 py-2 rounded-xl active:scale-95 transition-all">ç™»å‡º</button>` 
                        : `<button onclick="window.cloud.login()" class="text-xs bg-brand text-white font-bold px-4 py-2 rounded-xl shadow-md active:scale-95 transition-transform">ç™»å…¥</button>`}
                    </div>
                    </div>

                <div class="bg-white rounded-3xl overflow-hidden card-shadow">
                    <div onclick="state.subPage = 'photowall'; renderContent();" class="flex items-center justify-between p-5 hover:bg-slate-50 cursor-pointer border-b border-slate-50"><div class="flex items-center gap-4 text-brand"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h14a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-width="2"/></svg><span class="font-bold text-slate-700">æˆ‘çš„ç…§ç‰‡ç‰†</span></div><span>â–¶</span></div>
                    <div onclick="state.subPage = 'appearance'; renderContent();" class="flex items-center justify-between p-5 hover:bg-slate-50 cursor-pointer border-b border-slate-50"><div class="flex items-center gap-4 text-brand"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" stroke-width="2"/></svg><span class="font-bold text-slate-700">å¤–è§€è¨­å®š</span></div><span>â–¶</span></div>
                    <div onclick="state.subPage = 'backup'; renderContent();" class="flex items-center justify-between p-5 hover:bg-slate-50 cursor-pointer border-b border-slate-50"><div class="flex items-center gap-4 text-brand"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" stroke-width="2"/></svg><span class="font-bold text-slate-700">æ•¸æ“šåŒ¯å…¥èˆ‡åŒ¯å‡º</span></div><span>â–¶</span></div>
                    <div onclick="runStorageCleanup()" class="flex items-center justify-between p-5 hover:bg-slate-50 cursor-pointer">
                    <div class="flex items-center gap-4 text-brand">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2"/>
                        </svg>
                        <span class="font-bold text-slate-700">æ¸…ç†å†—é¤˜åœ–æª”</span>
                    </div>
                    <span class="text-[10px] text-slate-300">é‡‹æ”¾ç©ºé–“</span>
                    </div>
                </div>
                        

            </div>
                `;
        }
        //ç…§ç‰‡ç‰†
        function renderPhotoWall(container) {
            const isWishWall = state.photoWallTab === 'wish';
            // æ ¹æ“šæ¨™ç±¤æ±ºå®šè³‡æ–™ä¾†æºèˆ‡åˆ†é¡æ¸…å–®
            const dataSource = isWishWall ? state.wishlist : state.expenses;
            const currentCats = isWishWall ? wishCategories : categories.map(c => c.id);

            // å–å¾—æœ‰ç…§ç‰‡çš„è³‡æ–™ä¸¦éæ¿¾åˆ†é¡
            let photos = dataSource.filter(i => i.image);
            if (state.photoFilterCat && state.photoFilterCat !== '') {
                photos = photos.filter(p => p.category === state.photoFilterCat);
            }

            container.innerHTML = `
                <div class="p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <button onclick="state.subPage=null;state.photoFilterCat='';renderContent()" class="p-2 -ml-2 text-slate-400 active:scale-90 font-bold">â—€</button>
                        <h2 class="text-2xl font-black tracking-tight text-slate-800">ç…§ç‰‡ç‰†</h2>
                    </div>

                    <div class="flex border-b border-gray-100 mb-6">
                        <button onclick="state.photoWallTab='purchased';state.photoFilterCat='';renderContent()" 
                            class="photo-tab flex-1 py-3 text-sm font-bold ${state.photoWallTab==='purchased'?'active':'text-gray-400'}">å·²è³¼è²·</button>
                        <button onclick="state.photoWallTab='wish';state.photoFilterCat='';renderContent()" 
                            class="photo-tab flex-1 py-3 text-sm font-bold ${state.photoWallTab==='wish'?'active':'text-gray-400'}">å¿ƒé¡˜ç‰†</button>
                    </div>

                    <div class="flex gap-2 overflow-x-auto no-scrollbar pb-4 mb-2">
                        <div onclick="state.photoFilterCat='';renderContent()" 
                            class="chip ${state.photoFilterCat === '' ? 'active-tag' : ''}">å…¨éƒ¨</div>
                        ${currentCats.map(c => `
                            <div onclick="state.photoFilterCat='${c}';renderContent()" 
                                class="chip ${state.photoFilterCat === c ? 'active-tag' : ''}">${c.split(' ')[0]}</div>
                        `).join('')}
                    </div>

                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 pb-20">
                        ${photos.length > 0 ? photos.map(item => `
                            <div onclick="openLightbox('${item.image}', '${item.name}', '${isWishWall ? (item.category || 'ä¸€èˆ¬') : (item.year + '/' + item.month)}')" 
                                class="relative aspect-square bg-gray-200 rounded-2xl overflow-hidden shadow-sm active:scale-95 transition-all">
                                <img src="${item.image}" loading="lazy" class="w-full h-full object-cover">
                            </div>
                        `).join('') : `
                            <div class="col-span-full py-24 text-center text-slate-300 font-bold">ç›®å‰å°šç„¡ç…§ç‰‡</div>
                        `}
                    </div>
                </div>`;
             // ä¿®æ­£ï¼šæ¸²æŸ“å®Œå¾Œï¼Œè‡ªå‹•å°‡å•Ÿå‹•ä¸­çš„ Chip æ²å‹•åˆ°å¯è¦–ç¯„åœ
            requestAnimationFrame(() => {
                const activeChip = container.querySelector('.active-tag');
                if (activeChip) {
                    activeChip.scrollIntoView({
                        behavior: 'auto', // ç›´æ¥åˆ‡æ›
                        inline: 'center',   // å°‡è©²å…ƒç´ ç½®ä¸­é¡¯ç¤º
                        block: 'nearest'    // å‚ç›´æ–¹å‘ä¸è®Š
                    });
                }
            });
        }

        // --- å¤–è§€è¨­å®š ---
        function renderAppearanceView(container) {
            const presets = [
                {name:'ç²‰è—', c:'svt', g: 'linear-gradient(135deg, #F7CAC9 0%, #92A8D1 100%)'},
                {name:'å¹»ç´«', c:'#BB96FF'},
                {name:'æ²è—', c:'#69C4E0'},
                {name:'è¢ç¶ ', c:'#B6ED00'},
                {name:'æ¥µå…‰', c:'#6C3591'},
                {name:'ç† é‡‘', c:'#E2B216'}
            ];
            const currentHex = (state.themeColor && state.themeColor.startsWith('#')) ? state.themeColor : '';
            const isCustomGrad = state.themeColor.includes('gradient') && state.themeColor !== 'svt';
            const btnGrad = isCustomGrad ? state.themeColor : 'linear-gradient(135deg, #FEBEBE 0%,#85D0FF 100%)';
            container.innerHTML = `
                    <div class="p-6">
                        <div class="flex items-center gap-3 mb-8">
                            <button onclick="state.subPage=null;renderContent()" class="p-2 -ml-2 text-slate-400">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2"/></svg>
                            </button>
                            <h2 class="text-2xl font-black tracking-tight text-slate-800">å¤–è§€è¨­å®š</h2>
                        </div>
                        
                        <div class="bg-white rounded-3xl p-6 card-shadow text-slate-800">
                            <div class="flex mb-6 justify-between">
                                <h3 class="text-sm font-bold text-slate-500 tracking-wide">é¸æ“‡é è¨­ä¸»é¡Œ</h3>
                                <div class="flex justify-center border-slate-50">
                                    <label class="inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="grad-dark-toggle" class="sr-only peer" onchange="toggleDarkMode(this.checked)" ${document.body.classList.contains('dark-mode') ? 'checked' : ''}>
                                        <div class="relative w-10 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer 
                                                    peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full 
                                                    after:content-[''] after:absolute after:top-[2px] after:start-[2px] 
                                                    after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all 
                                                    peer-checked:bg-slate-700"></div>
                                        
                                        <span class="select-none text-sm font-bold text-slate-500">æ·±è‰²æ¨¡å¼</span>
                                    </label>
                                </div>
                            </div>
                            <div class="grid grid-cols-4 gap-y-8 gap-x-4 place-items-center mb-10">
                                ${presets.map(p => `
                                    <div class="flex flex-col items-center gap-2">
                                        <div onclick="applyTheme('${p.c}');renderContent()" 
                                            class="color-preset ${state.themeColor===p.c?'active':''}" 
                                            style="background:${p.g || p.c}"></div>
                                        <span class="text-[10px] font-bold text-slate-400">${p.name}</span>
                                    </div>
                                `).join('')}
                                <div class="flex flex-col items-center gap-2">
                                    <input type="color" onchange="applyTheme(this.value);renderContent()" 
                                        value="${state.themeColor==='svt'?'#92A8D1':state.themeColor==='bp'?'#FF85D0':state.themeColor}" 
                                        class="w-10 h-10 rounded-full border-none cursor-pointer bg-slate-200 shadow-sm">
                                    <span class="text-[10px] font-bold text-slate-400">æ»´ç®¡é¸è‰²</span>
                                </div>
                                <div class="flex flex-col items-center gap-2">
                                    <div onclick="openGradModal()" 
                                        class="color-preset flex items-center justify-center text-white text-[10px] font-bold ${state.themeColor.includes('gradient') && state.themeColor!=='svt'?'active':''}" 
                                        style="background:white">ğŸ¨</div>
                                    <span class="text-[10px] font-bold text-slate-400">è‡ªè¨‚æ¼¸å±¤</span>
                                </div>
                            </div>

                            <div class="mt-8 pt-6 border-t border-slate-50">
                                <h3 class="text-xs font-black text-slate-400 mb-4 uppercase tracking-widest">è¼¸å…¥è‡ªè¨‚è‰²ç¢¼</h3>
                                <div class="flex gap-2">
                                    <input type="text" id="custom-hex-input" placeholder="#RRGGBB" 
                                        value="${currentHex}"
                                        class="flex-grow bg-slate-50 border-2 border-transparent focus:border-brand rounded-2xl px-4 py-3 text-sm outline-none font-mono text-slate-700">
                                    <button onclick="applyHexColor()" 
                                            class="bg-brand text-white font-bold px-6 py-3 rounded-2xl shadow-lg active:scale-95 transition-all">
                                        å¥—ç”¨
                                    </button>
                                </div>
                                <p class="text-[10px] text-slate-300 mt-2 ml-1">è«‹è¼¸å…¥åŒ…å« # çš„å…­ä½æ•¸è‰²ç¢¼ï¼Œä¾‹å¦‚ #92A8D1</p>
                            </div>
                        </div>
                    </div>`;
            }
        function toggleDarkMode(isDark) {
            // å¥—ç”¨ç›®å‰çš„é¡è‰²ï¼Œä½†å‚³å…¥æ–°çš„æ·±æ·ºè¨­å®š
            applyTheme(state.themeColor, isDark);
            showToast(isDark ? "æ·±è‰²æ¨¡å¼å·²é–‹å•Ÿ" : "æ·±è‰²æ¨¡å¼å·²é—œé–‰");
        }
        function applyHexColor() {
            const hexInput = document.getElementById('custom-hex-input');
            const color = hexInput.value.trim();
            
            // é©—è­‰æ ¼å¼æ˜¯å¦ç‚ºæœ‰æ•ˆçš„ Hex è‰²ç¢¼ (ä¾‹å¦‚ #FFFFFF æˆ– #FFF)
            const isHex = /^#([A-Fa-f0-9]{3}){1,2}$/.test(color);
            
            if (isHex) {
                applyTheme(color);
                renderContent();
                showToast("å·²æ›´æ›è‡ªè¨‚ä¸»é¡Œè‰²ï¼");
            } else {
                showToast("æ ¼å¼éŒ¯èª¤ï¼è«‹è¼¸å…¥å¦‚ #92A8D1 çš„è‰²ç¢¼");
            }
        }

        // --- æ•¸æ“šå‚™ä»½ ---
        function renderBackupView(container) {
            container.innerHTML = `<div class="p-6"><div class="flex items-center gap-3 mb-8"><button onclick="state.subPage=null;renderContent()" class="p-2 -ml-2 text-slate-400 active:scale-90"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2"/></svg></button><h2 class="text-2xl font-black tracking-tight text-slate-800">åŒ¯å…¥èˆ‡åŒ¯å‡º</h2></div>
                <div class="bg-white rounded-3xl p-8 card-shadow border-2 border-dashed border-slate-200 text-center text-slate-800"><div class="w-20 h-20 bg-slate-50 text-slate-400 rounded-3xl flex items-center justify-center mx-auto mb-6 text-3xl">ğŸ“Š</div><h3 class="text-lg font-bold mb-2">Excel ç®¡ç†</h3><p class="text-sm text-slate-400 mb-8 px-4">æœ¬åœ° Excel å‚™ä»½ä¸åŒ…å«åœ–ç‰‡è³‡æ–™<br>âš ï¸åŒ¯å…¥å¾Œæœƒè¦†è“‹ç¾æœ‰è³‡æ–™ä¸¦æ¸…é™¤åœ–ç‰‡</p><div class="grid grid-cols-1 gap-4"><button onclick="exportToExcel()" class="bg-brand text-white font-black py-5 rounded-2xl shadow-lg active:scale-95 transition-transform">åŒ¯å‡º Excel å‚™ä»½</button><label class="bg-slate-800 text-white font-black py-5 rounded-2xl active:scale-95 cursor-pointer text-center">åŒ¯å…¥ Excel é‚„åŸ<input type="file" class="hidden" accept=".xlsx, .xls" onchange="importFromExcel(this)"></label></div></div></div>`;
        }


        /**
         * 4. ä»˜æ¬¾æ–¹å¼å‹•æ…‹ç›£è½
         */
        function handlePaymentChange(val) {
            const amountContainer = document.getElementById('paid-amount-container');
            if (amountContainer) {
                amountContainer.classList.toggle('hidden', val !== 'å·²ä»˜è¨‚é‡‘');
            }
        }
        function openActionModal(e, type, id) {
            e.stopPropagation();
            state.actionTarget = { type, id };
            
            const convertBtn = document.getElementById('action-convert-btn');
            if (convertBtn) {
                // å¦‚æœé»æ“Šçš„æ˜¯ã€Œå¿ƒé¡˜æ¸…å–® (wish)ã€ï¼Œæ‰é¡¯ç¤ºè½‰æ›æŒ‰éˆ•
                if (type === 'wish') {
                    convertBtn.classList.remove('hidden');
                } else {
                    convertBtn.classList.add('hidden');
                }
            }
            
            // å‘¼å«å‹•ç•«é–‹å•Ÿ
            openModalAnimation('action-modal-overlay', 'action-modal-container');
        }

        function triggerEditFromAction() {
            const { type, id } = state.actionTarget; closeActionModal();
            const list = type === 'expense' ? state.expenses : state.wishlist;
            const item = list.find(i => i.id === id);
            if (item) openAddModal(item);
        }

        function triggerDeleteFromAction() {
            const { type, id } = state.actionTarget; closeActionModal();
        }

        function triggerConvertToExpense() {
            const { id } = state.actionTarget; closeActionModal();
            const wish = state.wishlist.find(w => w.id === id);
            if(wish) {
                state.wishSourceId = id;
                openAddModal({ ...wish, qty: 1, category: 'å‘¨é‚Šå•†å“', arrivalStatus: 'æœªåˆ°è²¨', paymentMethod: 'å¾…ä»˜æ¬¾' });
            }
        }
        function openModalAnimation(overlayId, containerId) {
            const overlay = document.getElementById(overlayId);
            const container = document.getElementById(containerId);
            if (!overlay || !container) return;
            overlay.classList.remove('hidden');
            container.style.transform = 'translateY(100%)';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0)';
            container.offsetHeight; // force reflow
            container.style.transform = 'translateY(0)';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.6)';
        }

        function closeModalAnimation(overlayId, containerId) {
            const overlay = document.getElementById(overlayId);
            const container = document.getElementById(containerId);
            if (!overlay || !container) return;
            container.style.transform = 'translateY(100%)';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0)';
            setTimeout(() => {
                overlay.classList.add('hidden');
                container.style.transform = ''; 
            }, 300);
        }

        function closeModal() { closeModalAnimation('modal-overlay', 'modal-container'); }
        function closeActionModal() { closeModalAnimation('action-modal-overlay', 'action-modal-container'); }

        /**
         * 5. æ•¸æ“šè™•ç†
         */
        function openAddModal(itemData = null) {
            state.editingId = itemData?.id ? String(itemData.id) : null;
            state.tempImage = itemData?.image || null; // æ—¢æœ‰ç¶²å€å­˜åœ¨é€™è£¡
            state.tempImageBlob = null;               // é–‹å•Ÿæ™‚æ¸…ç©ºæ–°é¸å–çš„æª”æ¡ˆ
            const form = document.getElementById('data-form');
            const modalTitle = document.getElementById('modal-title');
            // ä¿®æ”¹åˆ¤æ–·é‚è¼¯ï¼šå¦‚æœè³‡æ–™è£¡æœ‰ qtyï¼Œæˆ–è€…ç›®å‰ç¢ºå¯¦åœ¨ expense åˆ†é ï¼Œæ‰é¡¯ç¤ºæ¶ˆè²»æ¨¡å¼
            const isWishMode = (state.activeTab === 'wish' && !itemData?.qty);
         // --- æ¨™é¡Œåˆ¤æ–·é‚è¼¯å„ªåŒ– ---
            if (isWishMode) {
                modalTitle.textContent = state.editingId ? "ç·¨è¼¯å¿ƒé¡˜" : "æ–°å¢å¿ƒé¡˜";
            } else {
                // æ¶ˆè²»æ¨¡å¼ä¸‹çš„ä¸‰ç¨®æƒ…æ³ï¼š
                if (state.wishSourceId) {
                    // 1. å¾é¡˜æœ›æ¸…å–®è½‰æ›è€Œä¾†
                    modalTitle.textContent = "åŠ å…¥æ¶ˆè²»æ¸…å–®";
                } else if (state.editingId) {
                    // 2. ç·¨è¼¯ç¾æœ‰æ¶ˆè²»ç´€éŒ„
                    modalTitle.textContent = "ç·¨è¼¯æ¶ˆè²»";
                } else {
                    // 3. ä¸€èˆ¬æ–°å¢æ¶ˆè²»
                    modalTitle.textContent = "æ–°å¢æ¶ˆè²»";
                }
            }
            if (!isWishMode) { //æ–°å¢æ¶ˆè²»
                const defaultMonthStr = String(state.filterMonth).padStart(2,'0');
                const mStr = state.filterMonth === 0 
                    ? String(new Date().getMonth() + 1).padStart(2, '0') // å¦‚æœæ˜¯ä¸é™ï¼Œç”¨ç¾åœ¨çš„æœˆä»½
                    : String(state.filterMonth).padStart(2, '0');        // å¦å‰‡ç”¨é¸å®šçš„æœˆä»½

                const defaultDate = `${state.filterYear}-${mStr}`;
                const isPaidDeposit = itemData?.paymentMethod === 'å·²ä»˜è¨‚é‡‘';

                form.innerHTML = `
                    <div class="space-y-4">
                        <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">å•†&#8203;å“&#8203;å&#8203;ç¨±</label><input type="text" id="m-t-l" autocomplete="one-time-code" autocorrect="off" required value="${itemData?.name || ''}" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none border-2 border-transparent focus:border-brand text-gray-800"></div>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">å–®&#8203;åƒ¹</label><input type="number" id="m-u-p" inputmode="decimal" autocomplete="one-time-code" autocorrect="off" required value="${itemData?.price || ''}" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800"></div>
                            <div class="space-y-1 relative" id="qty-combobox">
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">æ•¸é‡</label>
                                <div class="relative flex items-center">
                                    <input type="number" id="m-qty" inputmode="numeric" value="${itemData?.qty || 1}" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800 border-2 border-transparent focus:border-brand">
                                    <div id="qty-toggle" class="absolute right-3 cursor-pointer text-slate-400"><svg class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" stroke-width="2"/></svg></div>
                                </div>
                                <ul id="qty-options" class="absolute z-50 w-full mt-1 bg-white border border-slate-100 rounded-xl shadow-xl max-h-40 overflow-y-auto hidden custom-scrollbar"></ul>
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-slate-400 uppercase">é‹è²»</label>
                                <input type="number" id="m-shipping" inputmode="numeric" value="${itemData?.shipping || ''}" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">åˆ†é¡</label><select id="m-cat" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800">${categories.map(c => `<option ${itemData?.category == c.id ? 'selected' : ''}>${c.id}</option>`).join('')}</select></div>
                            <div class="space-y-1 flex flex-col"><label class="text-[10px] font-bold text-slate-400 uppercase mb-1">æ¶ˆè²»å¹´æœˆ</label><input type="month" id="m-date" value="${itemData?.year ? `${itemData.year}-${String(itemData.month).padStart(2,'0')}` : defaultDate}" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">è³¼ç‰©å¹³å°</label><input type="text" id="m-platform" autocomplete="one-time-code" autocorrect="off" placeholder="LINEç¤¾ç¾¤ã€WVS" value="${itemData?.platform || ''}" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800"></div>
                            <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">åˆ°è²¨ç‹€æ…‹</label><select id="m-status" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800">${arrivalOptions.map(o => `<option ${itemData?.arrivalStatus == o ? 'selected' : ''}>${o}</option>`).join('')}</select></div>
                        </div>
                
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">ä»˜æ¬¾æ–¹å¼</label><select id="m-pay-method" onchange="handlePaymentChange(this.value)" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800">${paymentOptions.map(o => `<option ${itemData?.paymentMethod == o ? 'selected' : ''}>${o}</option>`).join('')}</select></div>
                            <div id="paid-amount-container" class="space-y-1 ${isPaidDeposit ? '' : 'hidden'}"><label class="text-[10px] font-bold text-slate-400 uppercase">å·²ä»˜é‡‘é¡</label><input type="number" id="m-paid-amount" autocomplete="one-time-code" autocorrect="off" value="${itemData?.paidAmount || ''}" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800"></div>
                        </div>
                        <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">æ¨™ç±¤</label><input type="text" id="m-tags" autocomplete="one-time-code" autocorrect="off" value="${itemData?.tags?.join(', ') || ''}" placeholder="ç”¨é€—è™Ÿåˆ†éš” ä¾‹:SEVENTEEN,æ’’æµªå˜¿" class="w-full bg-slate-50 rounded-xl p-3 text-sm text-gray-800"></div>
                        <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">å‚™è¨»</label><textarea id="m-remark" autocomplete="one-time-code" autocorrect="off" placeholder="é€šè·¯ã€ooä»£è³¼ã€é è¨ˆå‡ºè²¨æ—¥æœŸç­‰ç­‰" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none h-16 resize-none text-gray-800">${itemData?.remark || ''}</textarea></div>
                        <div onclick="document.getElementById('m-img').click()" id="img-placeholder" class="bg-slate-50 border-2 border-dashed border-slate-100 rounded-3xl h-24 flex items-center justify-center overflow-hidden cursor-pointer shadow-inner">${state.tempImage ? `<img src="${state.tempImage}" class="w-full h-full object-cover">` : `<span class="text-slate-300 text-[10px] font-bold uppercase tracking-widest">ä¸Šå‚³ç›¸ç‰‡</span>`}</div>
                        <input type="file" id="m-img" accept="image/*" class="hidden" onchange="handleImage(this)">
                    </div>`;
                    initQtyPicker();
            } else {
                // é¡˜æœ›æ¨¡å¼ - ä¾ç…§è¦æ±‚è¨­å®šé è¨­æ—¥æœŸæ™‚é–“
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                const defaultTime = "12:00";

                form.innerHTML = `<div class="space-y-4">
                    <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">å•†&#8203;å“&#8203;å&#8203;ç¨±</label><input type="text" id="m-t-l" autocomplete="one-time-code" autocorrect="off" required value="${itemData?.name || ''}" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800 font-bold"></div>
                    <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">é &#8203;ä¼°&#8203;åƒ¹&#8203;æ ¼</label><input type="number" id="m-u-p" inputmode="decimal" autocomplete="one-time-code" autocorrect="off" value="${itemData?.price || ''}" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800 font-bold"></div>
                    <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">åˆ†é¡</label><select id="m-wish-cat" autocomplete="one-time-code" autocorrect="off" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none text-gray-800">${wishCategories.map(c => `<option value="${c}" ${itemData?.category == c ? 'selected' : ''}>${c}</option>`).join('')}</select></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1 flex flex-col"><label class="text-[10px] font-bold text-slate-400 uppercase mb-1">ç™¼å”®æ—¥æœŸ</label><input type="date" id="m-release-date" value="${itemData?.releaseDate || today}" class="w-full bg-slate-50 rounded-xl p-3 text-sm text-gray-800 font-bold"></div>
                        <div class="space-y-1 flex flex-col"><label class="text-[10px] font-bold text-slate-400 uppercase mb-1">æ™‚é–“</label><input type="time" id="m-release-time" value="${itemData?.releaseTime || defaultTime}" class="w-full bg-slate-50 rounded-xl p-3 text-sm text-gray-800 font-bold"></div>
                    </div>
                    <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase font-black">å¿ƒé¡˜å‚™è¨»</label><textarea id="m-remark" autocomplete="one-time-code" autocorrect="off" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none h-16 resize-none text-gray-800 font-bold">${itemData?.remark || ''}</textarea></div>
                    <div onclick="document.getElementById('m-img').click()" id="img-placeholder" class="bg-slate-50 border-2 border-dashed rounded-3xl h-24 flex items-center justify-center cursor-pointer shadow-inner">${state.tempImage ? `<img src="${state.tempImage}" class="w-full h-full object-cover">` : `<span class="text-slate-300 text-xs font-bold font-bold">ä¸Šå‚³ç›¸ç‰‡</span>`}</div>
                    <input type="file" id="m-img" accept="image/*" class="hidden" onchange="handleImage(this)">
                </div>`;
            }
                        
            document.getElementById('modal-overlay').classList.remove('hidden');
            setTimeout(() => { if (form) form.scrollTop = 0; }, 50);//æ¯æ¬¡é–‹å•Ÿéƒ½åœ¨å½ˆçª—æœ€ä¸Šæ–¹
        }
    function initQtyPicker() { //æ•¸é‡é¸æ“‡
        const input = document.getElementById('m-qty');
        const list = document.getElementById('qty-options');
        const toggle = document.getElementById('qty-toggle');
        const arrow = toggle.querySelector('svg');
        list.innerHTML = Array.from({length: 10}, (_, i) => i + 1).map(num => `<li class="px-4 py-3 text-sm hover:bg-slate-50 cursor-pointer text-gray-700 border-b border-slate-50 last:border-none font-bold" data-val="${num}">${num}</li>`).join('');
        const toggleShow = (show) => { list.classList.toggle('hidden', !show); arrow.style.transform = show ? 'rotate(180deg)' : 'rotate(0deg)'; };
        input.addEventListener('focus', () => toggleShow(true));
        toggle.onclick = (e) => { e.stopPropagation(); toggleShow(list.classList.contains('hidden')); };
        list.querySelectorAll('li').forEach(li => { li.onclick = () => { input.value = li.dataset.val; toggleShow(false); }; });
        document.addEventListener('click', (e) => { if (!document.getElementById('qty-combobox')?.contains(e.target)) toggleShow(false); }, { once: true });
    }
    async function saveData() {
        try {
            const n = document.getElementById('m-t-l')?.value; 
            const pVal = document.getElementById('m-u-p')?.value; 
            const p = Number(pVal) || 0;
            if (!n) {
                showToast("è«‹è¼¸å…¥å•†å“åç¨±");
                return;
            }


            const isExp = (state.activeTab === 'expense' || document.getElementById('m-qty'));
            const key = isExp ? 'expenses' : 'wishlist';
            
            // --- é—œéµä¿®æ­£ï¼šè™•ç†åœ–ç‰‡ä¸Šå‚³ ---
            let finalImageUrl = state.tempImage; // å¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼ä¸”æ²’æ›åœ–ï¼Œä¿ç•™åŸç¶²å€
            if (state.tempImageBlob) {
                showToast("æ­£åœ¨ä¸Šå‚³åœ–ç‰‡...");
                const fileName = `${Date.now()}.jpg`;
                const uploadedUrl = await window.cloud.uploadFile(state.tempImageBlob, fileName);
                if (uploadedUrl) {
                    finalImageUrl = uploadedUrl;
                }
            }
            let item;
            if (isExp) { //æ¶ˆè²»æ¨¡å¼
                const dateVal = document.getElementById('m-date').value;
                const dateParts = dateVal ? dateVal.split('-') : [state.filterYear, state.filterMonth];
                const y = Number(dateParts[0]);
                const m = Number(dateParts[1]);
                const p = Number(document.getElementById('m-u-p').value) || 0;
                const q = Number(document.getElementById('m-qty').value) || 1;
                const s = Number(document.getElementById('m-shipping').value) || 0;
                const payM = document.getElementById('m-pay-method')?.value || 'å¾…ä»˜æ¬¾';

                item = { 
                    id: state.editingId || String(Date.now()), 
                    name: n, price: p, qty: q,shipping: s, total: (p * q) + s, 
                    category: document.getElementById('m-cat').value, 
                    year: y, month: m,   image: finalImageUrl, 
                    platform: document.getElementById('m-platform').value || '', 
                    arrivalStatus: document.getElementById('m-status').value, 
                    paymentMethod: payM,
                    paidAmount: payM === 'å·²ä»˜è¨‚é‡‘' ? (Number(document.getElementById('m-paid-amount').value) || 0) : 0,
                    tags: document.getElementById('m-tags').value.split(/[,ï¼Œ]/).map(t => t.trim()).filter(t => t), 
                    remark: document.getElementById('m-remark').value || '' ,
                };
                item.total = (item.price * item.qty) + item.shipping;
            } else { //å¿ƒé¡˜æ¨¡å¼
                item = { 
                    id: state.editingId || String(Date.now()), name: n, 
                    price: p,
                    category: document.getElementById('m-wish-cat').value, 
                    releaseDate: document.getElementById('m-release-date').value, 
                    releaseTime: document.getElementById('m-release-time').value, 
                    remark: document.getElementById('m-remark').value || '', 
                    image: finalImageUrl
                };
            }

            // æ›´æ–° stateã€LocalStorage ä¸¦åŒæ­¥
            if (state.editingId) {
                const idx = state[key].findIndex(i => String(i.id) === state.editingId);
                if (idx !== -1) {
                    state[key][idx] = item;
                } else {
                    // å¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼ä½†åœ¨è©²æ¸…å–®æ‰¾ä¸åˆ°ï¼ˆä¾‹å¦‚å¾é¡˜æœ›è½‰éä¾†ï¼‰ï¼Œæ”¹ç”¨æ–°å¢
                    state[key].push(item);
                }
            } else {
                state[key].push(item);
            }

            // å„²å­˜è‡³æœ¬åœ° (ä¿®æ­£å¼•è™Ÿå•é¡Œ)
            localStorage.setItem(`fe_v11_${key}`, JSON.stringify(state[key]));
            // --- æ ¸å¿ƒä¿®æ­£ï¼šå¦‚æœæ˜¯å¾é¡˜æœ›è½‰éä¾†çš„ï¼Œåˆªé™¤è©²é¡˜æœ› ---
            if (isExp && state.wishSourceId) {
                state.wishlist = state.wishlist.filter(w => String(w.id) !== state.wishSourceId);
                localStorage.setItem('fe_v11_wishlist', JSON.stringify(state.wishlist));
                state.wishSourceId = null; // è™•ç†å®Œå¾Œæ¸…ç©º
            }

            // åŒæ­¥è‡³é›²ç«¯ (åŠ å…¥ await)
            if (window.cloud && typeof window.cloud.sync === 'function') {
                await window.cloud.sync(state.expenses, state.wishlist);
                // å­˜æª”å¾Œæ¸…é™¤æš«å­˜ Blob
                state.tempImageBlob = null;
            }
            if (isExp && state.activeTab !== 'expense') {
                state.activeTab = 'expense';
                // åŒæ­¥æ›´æ–°åº•éƒ¨å°è¦½åˆ—çš„é¡è‰²
                ['expense', 'report', 'wish', 'settings'].forEach(t => {
                    const el = document.getElementById(`tab-${t}`);
                    if (el) el.className = `flex-1 flex flex-col items-center gap-1 transition-colors ${state.activeTab === t ? 'tab-active' : 'text-gray-400'}`;
                });
            }
            closeModal(); 
            renderContent(); 
            showToast("å·²æˆåŠŸå„²å­˜ä¸¦åŒæ­¥");
        } catch (error) {
            console.error("å„²å­˜å¤±æ•—ï¼š", error);
            showToast("å„²å­˜ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥è¼¸å…¥å…§å®¹");
        }
    }

        /**
         * 6. å…¶å®ƒåŠŸèƒ½
         */
        // é»æ“Šåˆªé™¤æŒ‰éˆ•è§¸ç™¼
        async function handleDelete(e, type, id) {
            if (e) e.stopPropagation();
            
            // ä½¿ç”¨é€šç”¨å·¥å…·
            const confirmed = await askUser("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ", "ç´€éŒ„åˆªé™¤å¾Œå°‡ç„¡æ³•æ¢å¾©ã€‚", "ğŸ—‘ï¸");

            if (confirmed) {
                const key = type === 'expense' ? 'expenses' : 'wishlist';
                // 2. æ‰¾åˆ°è¦åˆªé™¤çš„é‚£ç­†è³‡æ–™ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰åœ–ç‰‡
                const itemToDelete = state[key].find(i => String(i.id) === String(id));
        
                // ç”¨window.cloud.deleteFileåˆªé™¤storageè³‡æ–™
                if (itemToDelete && itemToDelete.image) {
                    await window.cloud.deleteFile(itemToDelete.image);
                }

                // 4. åˆªé™¤æœ¬åœ°èˆ‡é›²ç«¯çš„æ–‡å­—ç´€éŒ„
                state[key] = state[key].filter(i => String(i.id) !== String(id));
                localStorage.setItem(`fe_v11_${key}`, JSON.stringify(state[key]));
                
                if (window.cloud) window.cloud.sync(state.expenses, state.wishlist);
                
                renderContent();
                showToast("å·²æˆåŠŸåˆªé™¤ç´€éŒ„");
            }
        }

        
        async function triggerDeleteFromAction() {
            const { type, id } = state.actionTarget;
            closeActionModal(); // å…ˆé—œé–‰æ“ä½œé¸å–®
            await handleDelete(null, type, id);
        }
      
        function updateFilter(k, v) { if (k === 'year') state.filterYear = Number(v); else state.filterMonth = Number(v); renderContent(); }
        async function handleImage(input) {
            if (!state.user) {
                showToast("è«‹å…ˆç™»å…¥ä»¥é–‹å•Ÿåœ–ç‰‡ä¸Šå‚³åŠŸèƒ½â˜ï¸");
                input.value = "";
                return;
            }
            const file = input.files[0];
            if (!file) return;
            // 2. æª¢æŸ¥æ˜¯å¦ç‚ºåœ–ç‰‡æ ¼å¼ (ä¿éšªèµ·è¦‹)
            if (!file.type.startsWith('image/')) {
                showToast("è«‹é¸æ“‡æ­£ç¢ºçš„åœ–ç‰‡æª”æ¡ˆæ ¼å¼");
                input.value = ""; // æ¸…ç©ºé¸å–ï¼Œé¿å…æ®˜ç•™éŒ¯èª¤æª”æ¡ˆ
                return;
            }
            // 3. æª¢æŸ¥æª”æ¡ˆå¤§å° (è¶…é 15MB é è­¦)
            if (file.size > 15 * 1024 * 1024) {
                showToast("åœ–ç‰‡å¤ªå¤§å›‰ï¼è«‹é¸æ“‡è¼ƒå°çš„ç…§ç‰‡");
                input.value = "";
                return;
            }
            if (file) {
                const reader = new FileReader();
                // æª”æ¡ˆè®€å–å¤±æ•—çš„è™•ç†
                reader.onerror = () => {
                    showToast("æª”æ¡ˆè®€å–ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦");
                    input.value = "";
                };
                reader.onload = async (e) => {
                    try {
                        const compressionWidth = file.size > 2 * 1024 * 1024 ? 500 : 800;
                        const compressedBase64 = await compressImage(e.target.result, compressionWidth);
                        
                        if (!compressedBase64) throw new Error("å£“ç¸®å¤±æ•—");

                        // æ›´æ–° UI é è¦½
                        const placeholder = document.getElementById('img-placeholder');
                        if (placeholder) {
                            placeholder.innerHTML = `<img src="${compressedBase64}" class="w-full h-full object-cover">`;
                        }

                        // å°‡ Base64 è½‰æ›ç‚º Blob æº–å‚™ä¸Šå‚³
                        const response = await fetch(compressedBase64);
                        if (!response.ok) throw new Error("è½‰æ›å¤±æ•—");
                        
                        state.tempImageBlob = await response.blob(); 
                        state.tempImage = null; // æ¸…é™¤èˆŠç¶²å€ç´€éŒ„
                        showToast("åœ–ç‰‡ä¸Šå‚³æˆåŠŸ");

                    } catch (error) {
                        console.error("Image processing error:", error);
                        showToast("åœ–ç‰‡è™•ç†å¤±æ•—ï¼Œè«‹æ›ä¸€å¼µè©¦è©¦");
                        // é‡ç½®ç‹€æ…‹
                        state.tempImageBlob = null;
                        document.getElementById('img-placeholder').innerHTML = `<span class="text-slate-300 text-[10px] font-bold uppercase tracking-widest">ä¸Šå‚³ç›¸ç‰‡</span>`;
                        input.value = "";
                    }
                };
                reader.readAsDataURL(file);
            }
        }
        function openLightbox(url, name, sub) { const overlay = document.getElementById('lightbox-overlay'); const img = document.getElementById('lightbox-img'); document.getElementById('lightbox-name').textContent = name; document.getElementById('lightbox-sub').textContent = sub; img.src = url; overlay.classList.remove('hidden'); }
        function closeLightbox() { document.getElementById('lightbox-overlay').classList.add('hidden'); }

        function calculateReportRange() {
            let start, end, label; const now = new Date();
            if (state.reportRange === 'month') { start = new Date(now.getFullYear(), now.getMonth() + state.reportOffset, 1); end = new Date(start.getFullYear(), start.getMonth() + 1, 0); label = `${start.getFullYear()} å¹´ ${start.getMonth() + 1} æœˆ`; }
            else if (state.reportRange === '6months') { end = new Date(now.getFullYear(), now.getMonth() + state.reportOffset + 1, 0); start = new Date(end.getFullYear(), end.getMonth() - 5, 1); label = `${start.getFullYear()}.${start.getMonth()+1} ï½ ${end.getFullYear()}.${end.getMonth()+1}`; }
            else { start = new Date(now.getFullYear() + state.reportOffset, 0, 1); end = new Date(start.getFullYear(), 11, 31); label = `${start.getFullYear()} å¹´åº¦å ±å‘Š`; }
            return { start, end, label };
        }

        function initChart(stats) {
            const ctx = document.getElementById('donutChart'); if (!ctx) return;
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, { type: 'doughnut', data: { labels: stats.map(s => s.id), datasets: [{ data: stats.map(s => s.amount), backgroundColor: stats.map(s => s.color), borderWidth: 0 }] }, options: { cutout: '75%', plugins: { legend: { display: false } } } });
        }

        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            const headers = Object.values(excelHeaderMap);
            const rows = state.expenses.map(i => { return Object.keys(excelHeaderMap).map(engKey => { let val = i[engKey]; if (engKey === 'tags' && Array.isArray(val)) return val.join(','); return (val !== undefined && val !== null) ? val : ""; }); });
            const wsExp = XLSX.utils.aoa_to_sheet([headers, ...rows]);
            XLSX.utils.book_append_sheet(wb, wsExp, "æ¶ˆè²»æ¸…å–®");
            XLSX.writeFile(wb, `è¿½æ˜Ÿè¨˜å¸³_å‚™ä»½_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        async function importFromExcel(input) {
        const file = input.files[0];
        if (!file) return;
        const confirmed = await askUser(
            "ç¢ºå®šè¦åŒ¯å…¥è³‡æ–™å—ï¼Ÿ", 
            "æ³¨æ„ï¼šåŒ¯å…¥ Excel æœƒã€Œå®Œå…¨è¦†è“‹ã€ç›®å‰çš„æ¶ˆè²»æ¸…å–®ï¼ŒåŸæœ¬çš„èˆŠè³‡æ–™å°‡æœƒæ¶ˆå¤±ã€‚å»ºè­°åŒ¯å…¥å‰å…ˆåŸ·è¡Œä¸€æ¬¡åŒ¯å‡ºå‚™ä»½ã€‚", 
            "âš ï¸"
        );

        // 2. å¦‚æœä½¿ç”¨è€…é»æ“Šå–æ¶ˆï¼Œå‰‡æ¸…ç©ºè¼¸å…¥æ¡†ä¸¦ä¸­æ–·åŸ·è¡Œ
        if (!confirmed) {
            input.value = "";
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                if (!workbook.SheetNames.includes("æ¶ˆè²»æ¸…å–®")) {
                    showToast("æ‰¾ä¸åˆ°ã€Œæ¶ˆè²»æ¸…å–®ã€å·¥ä½œè¡¨");
                    return;
                }

                const worksheet = workbook.Sheets["æ¶ˆè²»æ¸…å–®"];
                const aoa = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                if (aoa.length < 1) {
                    showToast("æª”æ¡ˆç‚ºç©º");
                    return;
                }

                const fileHeaders = aoa[0].map(h => String(h || "").trim());
                const nameIdx = fileHeaders.indexOf("é …ç›®åç¨±");
                if (nameIdx === -1) {
                    showToast("æ‰¾ä¸åˆ°ã€Œé …ç›®åç¨±ã€æ¬„ä½");
                    return;
                }

                // æº–å‚™é è¨­å€¼
                const now = new Date();
                const defaultYear = now.getFullYear();
                const defaultMonth = now.getMonth();//å‰ä¸€å€‹æœˆ

                const importedData = [];

                for (let r = 1; r < aoa.length; r++) {
                    const row = aoa[r];
                    if (!row[nameIdx]) continue; // å¦‚æœæ²’æœ‰é …ç›®åç¨±å‰‡è·³é

                    let item = { id: String(Date.now() + r), image: null };

                    Object.keys(excelHeaderMap).forEach(engKey => {
                        const chiKey = excelHeaderMap[engKey];
                        const colIdx = fileHeaders.indexOf(chiKey);
                        let val = colIdx > -1 ? row[colIdx] : undefined;

                        // æª¢æŸ¥å€¼æ˜¯å¦æœ‰æ•ˆï¼ˆéç©ºä¸”é undefinedï¼‰
                        const isEmpty = (val === undefined || val === null || String(val).trim() === "");

                        if (engKey === 'tags') {
                            item[engKey] = isEmpty ? [] : String(val).split(',').map(t => t.trim());
                        } 
                        else if (engKey === 'qty') {// æ•¸é‡é è¨­ç‚º 1
                            item[engKey] = isEmpty ? 1 : (Number(val) || 1);
                        } 
                        else if (engKey === 'year') {// å¹´ä»½é è¨­ç‚ºç•¶å‰å¹´ä»½
                            item[engKey] = isEmpty ? defaultYear : Number(val);
                        } 
                        else if (engKey === 'month') { // æœˆä»½é è¨­ç‚ºå‰ä¸€å€‹æœˆ
                            item[engKey] = isEmpty ? defaultMonth : Number(val);
                        } 
                        else if (engKey === 'category') { // åˆ†é¡é è¨­
                            item[engKey] = isEmpty ? "å°ˆè¼¯" : String(val).trim();
                        } 
                        else if (engKey === 'arrivalStatus') {// åˆ°è²¨ç‹€æ…‹é è¨­
                            item[engKey] = isEmpty ? "å·²åˆ°è²¨" : String(val).trim();
                        } 
                        else if (engKey === 'paymentMethod') { // ä»˜æ¬¾æ–¹å¼é è¨­
                            item[engKey] = isEmpty ? "åŒ¯æ¬¾å…¨é¡" : String(val).trim();
                        } 
                        else if (['price', 'paidAmount','shipping'].includes(engKey)) {// é‡‘é¡é¡é è¨­ç‚º 0
                            item[engKey] = Number(val) || 0;
                        } 
                        else {// å…¶ä»–å­—ä¸²æ¬„ä½
                            item[engKey] = isEmpty ? "" : String(val).trim();
                        }
                    });

                    // è¨ˆç®—ç¸½é¡
                    item.total =(Number(item.price) * Number(item.qty)) + Number(item.shipping);
                    importedData.push(item);
                }

                if (importedData.length > 0) {
                    state.expenses = importedData;
                    localStorage.setItem('fe_v11_expenses', JSON.stringify(state.expenses));
                    if (window.cloud) window.cloud.sync(state.expenses, state.wishlist);
                    renderContent();
                    showToast(`åŒ¯å…¥æˆåŠŸï¼šå…± ${importedData.length} ç­†`);
                }
            } catch (err) {
                console.error(err);
                showToast("æª”æ¡ˆæ ¼å¼éŒ¯èª¤");
            }
        };
        reader.readAsArrayBuffer(file);
        input.value = "";
    }
    async function runStorageCleanup() {
        // 1. è©¢å•ä½¿ç”¨è€…
        const confirmed = await askUser("å•Ÿå‹•æ·±å±¤æ¸…ç†ï¼Ÿ", "æ­£åœ¨å„ªåŒ–é›²ç«¯ç©ºé–“ï¼Œå®‰å…¨ç§»é™¤é‡è¤‡æˆ–å¤±æ•ˆçš„åœ–æª”ã€‚é€™éœ€è¦ä¸€é»æ™‚é–“ï¼Œè«‹æ”¾å¿ƒï¼Œæ‚¨çš„æ‰€æœ‰ç´€éŒ„èˆ‡ç›¸ç‰‡éƒ½æœƒå¦¥å–„ä¿ç•™ã€‚", "ğŸ§¹");
        if (!confirmed) return;

        showToast("æ­£åœ¨æƒæé›²ç«¯æª”æ¡ˆ...");

        // 2. æ”¶é›†ç›®å‰æ‰€æœ‰ç´€éŒ„ä¸­æ­£åœ¨ä½¿ç”¨çš„åœ–ç‰‡ç¶²å€
        const activeUrls = [
            ...state.expenses.map(ex => ex.image),
            ...state.wishlist.map(w => w.image)
        ].filter(url => url); // ç§»é™¤ç©ºå€¼

        // 3. åŸ·è¡Œæ¸…ç†
        const count = await window.cloud.cleanupOrphanedFiles(activeUrls);

        if (count > 0) {
            showToast(`æ¸…ç†å®Œæˆï¼å…±åˆªé™¤äº† ${count} å€‹å†—é¤˜åœ–æª”`);
        } else if (count === 0) {
            showToast("é›²ç«¯éå¸¸æ•´æ½”ï¼Œæ²’æœ‰éœ€è¦æ¸…ç†çš„æª”æ¡ˆ");
        } else {
            showToast("æ¸…ç†éç¨‹ç™¼ç”ŸéŒ¯èª¤");
        }
    }

        window.onload = () => { applyTheme(state.themeColor); switchTab('expense'); initSwipeToClose(); };
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js')
            .then(() => console.log('Service Worker registered'))
            .catch(err => console.error('SW registration failed:', err));
        }
    </script>

</body>
</html>